<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wound Care RT Supply Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 30px;
            position: sticky;
            top: 20px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            color: #4f46e5;
            font-size: 2rem;
            font-weight: 700;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: #4f46e5;
        }

        .user-role {
            color: #666;
            font-size: 0.9rem;
        }

        /* Navigation Styles */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Panel Styles */
        .panel {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tr:hover {
            background-color: #f9fafb;
        }

        /* Search and Filter Styles */
        .search-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #4f46e5;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
        }

        /* Alert Styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .nav-tabs {
                justify-content: center;
            }

            .search-container {
                flex-direction: column;
            }

            .table-container {
                font-size: 14px;
            }

            .logo h1 {
                font-size: 1.5rem;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <div class="logo-icon">🏥</div>
            <h2>Wound Care RT Supply Tracker</h2>
            <p>Professional Healthcare Supply Management</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
        </form>
        
        <div id="loginMessage" style="margin-top: 20px;"></div>
        
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #666;">
            <p><strong>Demo Credentials:</strong></p>
            <p>Admin: admin@system.com / admin123</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="logo">
                        <div class="logo-icon">🏥</div>
                        <h1>Wound Care RT Supply Tracker</h1>
                    </div>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">Loading...</div>
                        </div>
                        <button class="btn btn-danger" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="showPanel('dashboard')">📊 Dashboard</button>
                <button class="tab-btn" onclick="showPanel('patients')">👤 Patients</button>
                <button class="tab-btn" onclick="showPanel('supplies')">📦 Supplies</button>
                <button class="tab-btn" onclick="showPanel('tracking')">📈 Tracking</button>
                <button class="tab-btn admin-only" onclick="showPanel('admin')" style="display: none;">⚙️ Admin</button>
            </div>

            <!-- Dashboard Panel -->
            <div id="dashboardPanel" class="panel active">
                <h2>📊 Dashboard Overview</h2>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPatients">0</div>
                        <div class="stat-label">Total Patients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalSupplies">0</div>
                        <div class="stat-label">Supply Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthlyTracking">0</div>
                        <div class="stat-label">Monthly Tracking Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCost">$0</div>
                        <div class="stat-label">Total Supply Cost</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3>Recent Activity</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity">
                            <tr>
                                <td colspan="4" class="text-center">Loading recent activity...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Patients Panel -->
            <div id="patientsPanel" class="panel">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>👤 Patient Management</h2>
                    <button class="btn btn-primary" onclick="showAddPatientModal()">+ Add Patient</button>
                </div>

                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="patientSearch" class="form-control" placeholder="🔍 Search patients..." oninput="filterPatients()">
                    </div>
                    <div class="filter-group">
                        <select id="patientFacilityFilter" class="form-control" onchange="filterPatients()">
                            <option value="">All Facilities</option>
                        </select>
                        <select id="patientMonthFilter" class="form-control" onchange="filterPatients()">
                            <option value="">All Months</option>
                        </select>
                        <select id="patientSortBy" class="form-control" onchange="filterPatients()">
                            <option value="name">Sort: A-Z Name</option>
                            <option value="name_desc">Sort: Z-A Name</option>
                            <option value="month">Sort: Month</option>
                            <option value="facility">Sort: Facility</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>MRN</th>
                                <th>Month</th>
                                <th>Facility</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTable">
                            <tr>
                                <td colspan="5" class="text-center">Loading patients...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Supplies Panel -->
            <div id="suppliesPanel" class="panel">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>📦 Supply Management</h2>
                    <div class="flex gap-10">
                        <button class="btn btn-success" onclick="importExcel()">📊 Import Excel</button>
                        <button class="btn btn-primary" onclick="showAddSupplyModal()">+ Add Supply</button>
                    </div>
                </div>

                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="supplySearch" class="form-control" placeholder="🔍 Search supplies..." oninput="filterSupplies()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Description</th>
                                <th>HCPCS</th>
                                <th>Cost</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliesTable">
                            <tr>
                                <td colspan="6" class="text-center">Loading supplies...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tracking Panel -->
            <div id="trackingPanel" class="panel">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>📈 Supply Tracking</h2>
                    <button class="btn btn-success" onclick="exportTrackingData()">📄 Export Data</button>
                </div>

                <div class="search-container">
                    <div class="search-box">
                        <select id="trackingPatient" class="form-control">
                            <option value="">Select Patient...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="trackingFacilityFilter" class="form-control" onchange="filterTrackingPatients()">
                            <option value="">All Facilities</option>
                        </select>
                        <select id="trackingMonth" class="form-control">
                        </select>
                        <button class="btn btn-primary" onclick="loadTrackingData()">Load Tracking</button>
                    </div>
                </div>

                <div id="trackingTableContainer" class="table-container" style="display: none;">
                    <div id="trackingTable"></div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="adminPanel" class="panel">
                <h2>⚙️ Admin Panel</h2>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingApprovals">0</div>
                        <div class="stat-label">Pending Approvals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalFacilities">0</div>
                        <div class="stat-label">Facilities</div>
                    </div>
                </div>

                <div class="flex gap-20 mb-20">
                    <button class="btn btn-primary" onclick="showAddUserModal()">+ Add User</button>
                    <button class="btn btn-primary" onclick="showAddFacilityModal()">+ Add Facility</button>
                    <button class="btn btn-danger" onclick="showSystemReset()">🔄 System Reset</button>
                </div>

                <h3>User Management</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Facility</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="6" class="text-center">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addPatientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Patient</h3>
                <span class="close" onclick="closeModal('addPatientModal')">&times;</span>
            </div>
            <form id="addPatientForm">
                <div class="form-group">
                    <label for="patientName">Patient Name</label>
                    <input type="text" id="patientName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="patientMRN">MRN</label>
                    <input type="text" id="patientMRN" class="form-control">
                </div>
                <div class="form-group">
                    <label for="patientMonth">Month</label>
                    <select id="patientMonth" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="patientFacility">Facility</label>
                    <select id="patientFacility" class="form-control" required>
                        <option value="">Select Facility</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Patient</button>
            </form>
        </div>
    </div>

    <div id="addSupplyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Supply</h3>
                <span class="close" onclick="closeModal('addSupplyModal')">&times;</span>
            </div>
            <form id="addSupplyForm">
                <div class="form-group">
                    <label for="supplyCode">Supply Code</label>
                    <input type="number" id="supplyCode" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="supplyDescription">Description</label>
                    <input type="text" id="supplyDescription" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="supplyHCPCS">HCPCS Code</label>
                    <input type="text" id="supplyHCPCS" class="form-control">
                </div>
                <div class="form-group">
                    <label for="supplyCost">Cost ($)</label>
                    <input type="number" id="supplyCost" class="form-control" step="0.01" min="0">
                </div>
                <button type="submit" class="btn btn-primary">Add Supply</button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="userName">Full Name</label>
                    <input type="text" id="userName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email Address</label>
                    <input type="email" id="userEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password</label>
                    <input type="password" id="userPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Role</label>
                    <select id="userRole" class="form-control" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userFacility">Facility</label>
                    <select id="userFacility" class="form-control">
                        <option value="">No Specific Facility</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add User</button>
            </form>
        </div>
    </div>

    <div id="addFacilityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Facility</h3>
                <span class="close" onclick="closeModal('addFacilityModal')">&times;</span>
            </div>
            <form id="addFacilityForm">
                <div class="form-group">
                    <label for="facilityName">Facility Name</label>
                    <input type="text" id="facilityName" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Facility</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = null;
        let patients = [];
        let supplies = [];
        let facilities = [];
        let allPatients = []; // Store unfiltered patients

        // Generate month options from July 2024 to September 2027
        function generateMonthOptions() {
            const startYear = 2024;
            const startMonth = 7; // July
            const endYear = 2027;
            const endMonth = 9; // September
            
            const months = [];
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];

            for (let year = startYear; year <= endYear; year++) {
                const start = (year === startYear) ? startMonth : 1;
                const end = (year === endYear) ? endMonth : 12;
                
                for (let month = start; month <= end; month++) {
                    const value = `${year}-${month.toString().padStart(2, '0')}`;
                    const label = `${monthNames[month - 1]} ${year}`;
                    months.push({ value, label });
                }
            }
            
            return months;
        }

        // Initialize month dropdowns
        function initializeMonthDropdowns() {
            const months = generateMonthOptions();
            
            // Patient month filter
            const patientMonthFilter = document.getElementById('patientMonthFilter');
            patientMonthFilter.innerHTML = '<option value="">All Months</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.label;
                patientMonthFilter.appendChild(option);
            });

            // Patient modal month selector
            const patientMonth = document.getElementById('patientMonth');
            patientMonth.innerHTML = '<option value="">Select Month</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.label;
                patientMonth.appendChild(option);
            });

            // Tracking month selector
            const trackingMonth = document.getElementById('trackingMonth');
            trackingMonth.innerHTML = '<option value="">Select Month</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.label;
                trackingMonth.appendChild(option);
            });
        }

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showMainApp();
                } else {
                    showMessage('loginMessage', data.message, 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'Login failed. Please try again.', 'error');
            }
        });

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
            
            // Show admin panel if user is admin
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            }

            // Initialize month dropdowns
            initializeMonthDropdowns();

            // Load initial data
            loadDashboardData();
            loadPatients();
            loadSupplies();
            loadFacilities();
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            authToken = null;
            currentUser = null;
        }

        // Check for existing auth on page load
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        });

        // API Helper function
        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (authToken) {
                headers.Authorization = `Bearer ${authToken}`;
            }

            try {
                const response = await fetch(endpoint, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Panel navigation
        function showPanel(panelName) {
            // Hide all panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected panel
            document.getElementById(panelName + 'Panel').classList.add('active');
            event.target.classList.add('active');

            // Load panel-specific data
            switch(panelName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'patients':
                    loadPatients();
                    break;
                case 'supplies':
                    loadSupplies();
                    break;
                case 'tracking':
                    loadTrackingPatients();
                    break;
                case 'admin':
                    if (currentUser.role === 'admin') {
                        loadAdminData();
                    }
                    break;
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            try {
                const [patientsData, suppliesData, trackingData] = await Promise.all([
                    apiCall('/api/patients'),
                    apiCall('/api/supplies'),
                    apiCall('/api/tracking')
                ]);

                document.getElementById('totalPatients').textContent = patientsData.patients?.length || 0;
                document.getElementById('totalSupplies').textContent = suppliesData.supplies?.length || 0;
                document.getElementById('monthlyTracking').textContent = trackingData.tracking?.length || 0;
                
                const totalCost = suppliesData.supplies?.reduce((sum, supply) => sum + (parseFloat(supply.cost) || 0), 0) || 0;
                document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
                
                loadRecentActivity();
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        async function loadRecentActivity() {
            const tbody = document.getElementById('recentActivity');
            tbody.innerHTML = `
                <tr><td>${new Date().toLocaleDateString()}</td><td>System</td><td>Login</td><td>User logged in successfully</td></tr>
                <tr><td>${new Date().toLocaleDateString()}</td><td>System</td><td>Dashboard</td><td>Dashboard data loaded</td></tr>
                <tr><td>${new Date().toLocaleDateString()}</td><td>System</td><td>Supplies</td><td>Complete AR supply database loaded (272, 400-709)</td></tr>
            `;
        }

        // Patient functions
        async function loadPatients() {
            try {
                const data = await apiCall('/api/patients');
                allPatients = data.patients || [];
                patients = [...allPatients]; // Copy for filtering
                filterPatients(); // Apply current filters
            } catch (error) {
                console.error('Failed to load patients:', error);
                document.getElementById('patientsTable').innerHTML = 
                    '<tr><td colspan="5" class="text-center">Failed to load patients</td></tr>';
            }
        }

        function filterPatients() {
            const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
            const facilityFilter = document.getElementById('patientFacilityFilter').value;
            const monthFilter = document.getElementById('patientMonthFilter').value;
            const sortBy = document.getElementById('patientSortBy').value;
            
            let filtered = allPatients.filter(patient => {
                const matchesSearch = patient.name.toLowerCase().includes(searchTerm) ||
                                    (patient.mrn && patient.mrn.toLowerCase().includes(searchTerm));
                const matchesFacility = !facilityFilter || patient.facility_id.toString() === facilityFilter;
                const matchesMonth = !monthFilter || patient.month === monthFilter;
                
                return matchesSearch && matchesFacility && matchesMonth;
            });

            // Sort patients
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'name_desc':
                        return b.name.localeCompare(a.name);
                    case 'month':
                        return a.month.localeCompare(b.month);
                    case 'facility':
                        return (a.facility_name || '').localeCompare(b.facility_name || '');
                    default:
                        return a.name.localeCompare(b.name);
                }
            });

            patients = filtered;
            renderPatientsTable();
        }

        function renderPatientsTable() {
            const tbody = document.getElementById('patientsTable');
            
            if (patients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No patients found</td></tr>';
                return;
            }

            tbody.innerHTML = patients.map(patient => `
                <tr>
                    <td>${patient.name}</td>
                    <td>${patient.mrn || 'N/A'}</td>
                    <td>${patient.month}</td>
                    <td>${patient.facility_name || 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editPatient(${patient.id})">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deletePatient(${patient.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddPatientModal() {
            document.getElementById('addPatientModal').style.display = 'block';
            loadFacilityOptions('patientFacility');
        }

        document.getElementById('addPatientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const patientData = {
                name: document.getElementById('patientName').value,
                mrn: document.getElementById('patientMRN').value,
                month: document.getElementById('patientMonth').value,
                facility_id: document.getElementById('patientFacility').value
            };

            try {
                await apiCall('/api/patients', {
                    method: 'POST',
                    body: JSON.stringify(patientData)
                });

                closeModal('addPatientModal');
                document.getElementById('addPatientForm').reset();
                loadPatients();
                showMessage('Successfully added patient!', 'success');
            } catch (error) {
                showMessage('Failed to add patient', 'error');
            }
        });

        // Supply functions
        async function loadSupplies() {
            try {
                const data = await apiCall('/api/supplies');
                supplies = data.supplies || [];
                filterSupplies();
            } catch (error) {
                console.error('Failed to load supplies:', error);
                document.getElementById('suppliesTable').innerHTML = 
                    '<tr><td colspan="6" class="text-center">Failed to load supplies</td></tr>';
            }
        }

        function filterSupplies() {
            const searchTerm = document.getElementById('supplySearch').value.toLowerCase();
            
            const filtered = supplies.filter(supply => 
                supply.description.toLowerCase().includes(searchTerm) ||
                supply.code.toString().includes(searchTerm) ||
                (supply.hcpcs && supply.hcpcs.toLowerCase().includes(searchTerm))
            );
            
            renderSuppliesTable(filtered);
        }

        function renderSuppliesTable(filteredSupplies = supplies) {
            const tbody = document.getElementById('suppliesTable');
            
            if (filteredSupplies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No supplies found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredSupplies.map(supply => `
                <tr>
                    <td>${supply.code}</td>
                    <td>${supply.description}</td>
                    <td>${supply.hcpcs || 'N/A'}</td>
                    <td>$${parseFloat(supply.cost || 0).toFixed(2)}</td>
                    <td>${supply.is_custom ? 'Custom' : 'AR Standard'}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editSupply(${supply.id})">Edit</button>
                        ${supply.is_custom ? `<button class="btn btn-danger btn-small" onclick="deleteSupply(${supply.id})">Delete</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function showAddSupplyModal() {
            document.getElementById('addSupplyModal').style.display = 'block';
        }

        document.getElementById('addSupplyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const supplyData = {
                code: document.getElementById('supplyCode').value,
                description: document.getElementById('supplyDescription').value,
                hcpcs: document.getElementById('supplyHCPCS').value,
                cost: document.getElementById('supplyCost').value
            };

            try {
                await apiCall('/api/supplies', {
                    method: 'POST',
                    body: JSON.stringify(supplyData)
                });

                closeModal('addSupplyModal');
                document.getElementById('addSupplyForm').reset();
                loadSupplies();
                showMessage('Successfully added supply!', 'success');
            } catch (error) {
                showMessage('Failed to add supply', 'error');
            }
        });

        // Facility functions
        async function loadFacilities() {
            try {
                const data = await apiCall('/api/facilities');
                facilities = data.facilities || [];
                
                // Update facility filters
                updateFacilityFilters();
            } catch (error) {
                console.error('Failed to load facilities:', error);
            }
        }

        function updateFacilityFilters() {
            // Patient facility filter
            const patientFacilityFilter = document.getElementById('patientFacilityFilter');
            patientFacilityFilter.innerHTML = '<option value="">All Facilities</option>';
            facilities.forEach(facility => {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = facility.name;
                patientFacilityFilter.appendChild(option);
            });

            // Tracking facility filter
            const trackingFacilityFilter = document.getElementById('trackingFacilityFilter');
            trackingFacilityFilter.innerHTML = '<option value="">All Facilities</option>';
            facilities.forEach(facility => {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = facility.name;
                trackingFacilityFilter.appendChild(option);
            });
        }

        function loadFacilityOptions(selectId) {
            const select = document.getElementById(selectId);
            const currentHTML = select.innerHTML;
            
            select.innerHTML = selectId.includes('patient') ? '<option value="">Select Facility</option>' : '<option value="">No Specific Facility</option>';
            
            facilities.forEach(facility => {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = facility.name;
                select.appendChild(option);
            });
        }

        // Tracking functions
        async function loadTrackingPatients() {
            try {
                const data = await apiCall('/api/patients');
                const select = document.getElementById('trackingPatient');
                
                // Store all patients for filtering
                window.trackingPatients = data.patients || [];
                
                filterTrackingPatients();
            } catch (error) {
                console.error('Failed to load tracking patients:', error);
            }
        }

        function filterTrackingPatients() {
            const facilityFilter = document.getElementById('trackingFacilityFilter').value;
            const select = document.getElementById('trackingPatient');
            
            select.innerHTML = '<option value="">Select Patient...</option>';
            
            const filteredPatients = (window.trackingPatients || []).filter(patient => {
                return !facilityFilter || patient.facility_id.toString() === facilityFilter;
            });

            filteredPatients.sort((a, b) => a.name.localeCompare(b.name));

            filteredPatients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.name} (${patient.month}) - ${patient.facility_name || 'No Facility'}`;
                select.appendChild(option);
            });
        }

        // IMPROVED TRACKING FUNCTIONALITY
let currentTrackingData = {};
let currentPatientId = null;

async function loadTrackingData() {
    const patientId = document.getElementById('trackingPatient').value;
    
    if (!patientId) {
        showMessage('Please select a patient first', 'error');
        return;
    }

    try {
        currentPatientId = patientId;
        const data = await apiCall(`/api/tracking/${patientId}`);
        currentTrackingData = data.tracking || [];
        
        renderTrackingGrid();
        document.getElementById('trackingTableContainer').style.display = 'block';
        
    } catch (error) {
        console.error('Failed to load tracking data:', error);
        showMessage('Failed to load tracking data', 'error');
    }
}

function renderTrackingGrid() {
    if (!currentTrackingData || currentTrackingData.length === 0) {
        document.getElementById('trackingTable').innerHTML = 
            '<p class="text-center">No tracking data found. Start by adding some supplies for this patient.</p>';
        return;
    }

    // Group data by supply
    const suppliesByCode = {};
    currentTrackingData.forEach(item => {
        if (!suppliesByCode[item.supply_code]) {
            suppliesByCode[item.supply_code] = {
                id: item.supply_id,
                code: item.supply_code,
                description: item.supply_description || 'Unknown Supply',
                cost: parseFloat(item.supply_cost || 0),
                hcpcs: item.hcpcs || '',
                days: {}
            };
        }
        suppliesByCode[item.supply_code].days[item.day_of_month] = {
            quantity: item.quantity || 0,
            wound_dx: item.wound_dx || ''
        };
    });

    // Create tracking grid
    let tableHTML = `
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="showAddSupplyToTracking()">+ Add Supply to Track</button>
            <button class="btn btn-success" onclick="saveAllTrackingData()">💾 Save All Changes</button>
        </div>
        <div style="overflow-x: auto;">
            <table class="table" style="min-width: 800px;">
                <thead>
                    <tr>
                        <th style="min-width: 80px;">Supply Code</th>
                        <th style="min-width: 200px;">Description</th>
                        <th style="min-width: 80px;">HCPCS</th>
                        <th style="min-width: 80px;">Cost</th>
    `;
    
    // Add day columns
    for (let day = 1; day <= 31; day++) {
        tableHTML += `<th style="min-width: 50px; text-align: center;">D${day}</th>`;
    }
    
    tableHTML += `
                        <th style="min-width: 80px;">Total</th>
                        <th style="min-width: 150px;">Wound Dx</th>
                        <th style="min-width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    // Render supply rows
    Object.values(suppliesByCode).forEach(supply => {
        tableHTML += `
            <tr data-supply-id="${supply.id}">
                <td><strong>${supply.code}</strong></td>
                <td>${supply.description}</td>
                <td>${supply.hcpcs}</td>
                <td>$${supply.cost.toFixed(2)}</td>
        `;
        
        let total = 0;
        let woundDx = '';
        
        for (let day = 1; day <= 31; day++) {
            const dayData = supply.days[day] || { quantity: 0, wound_dx: '' };
            total += dayData.quantity;
            if (dayData.wound_dx && !woundDx) {
                woundDx = dayData.wound_dx;
            }
            
            tableHTML += `
                <td style="text-align: center;">
                    <input type="number" 
                           value="${dayData.quantity || ''}" 
                           min="0" 
                           max="999"
                           style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px;"
                           onchange="updateTrackingCell(${supply.id}, ${day}, this.value)"
                           data-supply-id="${supply.id}" 
                           data-day="${day}">
                </td>
            `;
        }
        
        tableHTML += `
                <td><strong>${total}</strong></td>
                <td>
                    <input type="text" 
                           value="${woundDx}" 
                           placeholder="Enter diagnosis"
                           style="width: 140px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"
                           onchange="updateWoundDx(${supply.id}, this.value)">
                </td>
                <td>
                    <button class="btn btn-danger btn-small" onclick="removeSupplyFromTracking(${supply.id})">Remove</button>
                </td>
            </tr>
        `;
    });

    tableHTML += `
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('trackingTable').innerHTML = tableHTML;
}

function updateTrackingCell(supplyId, day, quantity) {
    // This will be saved when user clicks "Save All Changes"
    // Just update the visual total for now
    updateRowTotal(supplyId);
}

function updateRowTotal(supplyId) {
    const row = document.querySelector(`tr[data-supply-id="${supplyId}"]`);
    if (!row) return;
    
    let total = 0;
    const inputs = row.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        total += parseInt(input.value) || 0;
    });
    
    const totalCell = row.cells[row.cells.length - 3]; // Total column
    totalCell.innerHTML = `<strong>${total}</strong>`;
}

function updateWoundDx(supplyId, diagnosis) {
    // Store the diagnosis - will be saved with saveAllTrackingData()
}

async function saveAllTrackingData() {
    if (!currentPatientId) {
        showMessage('No patient selected', 'error');
        return;
    }

    const savePromises = [];
    const rows = document.querySelectorAll('tr[data-supply-id]');
    
    rows.forEach(row => {
        const supplyId = row.getAttribute('data-supply-id');
        const woundDxInput = row.querySelector('input[type="text"]');
        const woundDx = woundDxInput ? woundDxInput.value : '';
        
        const quantityInputs = row.querySelectorAll('input[type="number"]');
        quantityInputs.forEach(input => {
            const day = input.getAttribute('data-day');
            const quantity = parseInt(input.value) || 0;
            
            if (quantity > 0 || woundDx) { // Only save if there's quantity or diagnosis
                savePromises.push(
                    apiCall('/api/tracking', {
                        method: 'POST',
                        body: JSON.stringify({
                            patientId: currentPatientId,
                            supplyId: supplyId,
                            dayOfMonth: day,
                            quantity: quantity,
                            woundDx: woundDx
                        })
                    })
                );
            }
        });
    });

    try {
        await Promise.all(savePromises);
        showMessage('All tracking data saved successfully!', 'success');
        loadTrackingData(); // Refresh the display
    } catch (error) {
        console.error('Failed to save tracking data:', error);
        showMessage('Failed to save some tracking data', 'error');
    }
}

function showAddSupplyToTracking() {
    // Simple implementation - show available supplies
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Supply to Track</h3>
                <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Description</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${supplies.map(supply => `
                            <tr>
                                <td>${supply.code}</td>
                                <td>${supply.description}</td>
                                <td>
                                    <button class="btn btn-primary btn-small" onclick="addSupplyToTracking(${supply.id}); this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.remove();">
                                        Add
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function addSupplyToTracking(supplyId) {
    // Add a supply with 0 quantity for day 1 to initialize tracking
    try {
        await apiCall('/api/tracking', {
            method: 'POST',
            body: JSON.stringify({
                patientId: currentPatientId,
                supplyId: supplyId,
                dayOfMonth: 1,
                quantity: 0
            })
        });
        
        loadTrackingData(); // Refresh to show the new supply
        showMessage('Supply added to tracking!', 'success');
    } catch (error) {
        showMessage('Failed to add supply to tracking', 'error');
    }
}

async function removeSupplyFromTracking(supplyId) {
    if (!confirm('Remove this supply from tracking? This will delete all data for this supply.')) {
        return;
    }
    
    // This would need a backend route to remove all tracking entries for a supply
    showMessage('Remove supply functionality needs backend implementation', 'info');
}

// EXPORT FUNCTIONALITY
function exportTrackingData() {
    if (!currentTrackingData || currentTrackingData.length === 0) {
        showMessage('No tracking data to export', 'error');
        return;
    }

    // Create CSV data
    const csvRows = [];
    csvRows.push(['Patient', 'Supply Code', 'Supply Description', 'Day', 'Quantity', 'Wound Diagnosis', 'Cost', 'HCPCS']);

    const patient = patients.find(p => p.id == currentPatientId);
    const patientName = patient ? patient.name : 'Unknown Patient';

    currentTrackingData.forEach(item => {
        csvRows.push([
            patientName,
            item.supply_code || '',
            item.supply_description || '',
            item.day_of_month || '',
            item.quantity || 0,
            item.wound_dx || '',
            item.supply_cost || 0,
            item.hcpcs || ''
        ]);
    });

    // Convert to CSV string
    const csvContent = csvRows.map(row => 
        row.map(cell => `"${cell}"`).join(',')
    ).join('\n');

    // Download the file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tracking_data_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
        // Admin functions
        async function loadAdminData() {
            if (currentUser.role !== 'admin') return;

            try {
                const [usersData, facilitiesData] = await Promise.all([
                    apiCall('/api/admin/users'),
                    apiCall('/api/facilities')
                ]);

                document.getElementById('totalUsers').textContent = usersData.users?.length || 0;
                document.getElementById('totalFacilities').textContent = facilitiesData.facilities?.length || 0;
                
                const pendingUsers = usersData.users?.filter(user => !user.is_approved).length || 0;
                document.getElementById('pendingApprovals').textContent = pendingUsers;

                renderUsersTable(usersData.users || []);
            } catch (error) {
                console.error('Failed to load admin data:', error);
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${user.facility_name || 'N/A'}</td>
                    <td>${user.is_approved ? 'Approved' : 'Pending'}</td>
                    <td>
                        ${!user.is_approved ? `<button class="btn btn-success btn-small" onclick="approveUser(${user.id})">Approve</button>` : ''}
                        <button class="btn btn-danger btn-small" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
            loadFacilityOptions('userFacility');
        }

        function showAddFacilityModal() {
            document.getElementById('addFacilityModal').style.display = 'block';
        }

        // Add User Form Submit
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value,
                role: document.getElementById('userRole').value,
                facility_id: document.getElementById('userFacility').value || null
            };

            try {
                await apiCall('/api/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                closeModal('addUserModal');
                document.getElementById('addUserForm').reset();
                loadAdminData();
                showMessage('Successfully added user!', 'success');
            } catch (error) {
                showMessage('Failed to add user', 'error');
            }
        });

        // Add Facility Form Submit
        document.getElementById('addFacilityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const facilityData = {
                name: document.getElementById('facilityName').value
            };

            try {
                await apiCall('/api/facilities', {
                    method: 'POST',
                    body: JSON.stringify(facilityData)
                });

                closeModal('addFacilityModal');
                document.getElementById('addFacilityForm').reset();
                loadFacilities();
                loadAdminData();
                showMessage('Successfully added facility!', 'success');
            } catch (error) {
                showMessage('Failed to add facility', 'error');
            }
        });

        async function approveUser(userId) {
            try {
                await apiCall(`/api/admin/users/${userId}/approve`, {
                    method: 'PUT'
                });
                loadAdminData();
                showMessage('User approved successfully!', 'success');
            } catch (error) {
                showMessage('Failed to approve user', 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                await apiCall(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                loadAdminData();
                showMessage('User deleted successfully!', 'success');
            } catch (error) {
                showMessage('Failed to delete user', 'error');
            }
        }

        // Utility functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMessage(message, type) {
            // Create temporary message element
            const msgDiv = document.createElement('div');
            msgDiv.className = `alert alert-${type}`;
            msgDiv.textContent = message;
            
            // Add to top of current panel
            const activePanel = document.querySelector('.panel.active');
            activePanel.insertBefore(msgDiv, activePanel.firstChild);
            
            // Remove after 3 seconds
            setTimeout(() => msgDiv.remove(), 3000);
        }

        // Export functions
        function exportTrackingData() {
            alert('Export functionality would generate CSV/Excel file with tracking data');
        }

        function importExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv';
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    alert(`Would import file: ${file.name}`);
                }
            });
            input.click();
        }

        // PATIENT EDIT FUNCTIONALITY
let editingPatientId = null;

function editPatient(id) {
    const patient = patients.find(p => p.id === id);
    if (!patient) {
        showMessage('Patient not found', 'error');
        return;
    }

    editingPatientId = id;
    
    // Pre-fill the form with existing data
    document.getElementById('editPatientName').value = patient.name;
    document.getElementById('editPatientMRN').value = patient.mrn || '';
    
    document.getElementById('editPatientModal').style.display = 'block';
}

async function updatePatient() {
    if (!editingPatientId) return;

    const patientData = {
        name: document.getElementById('editPatientName').value,
        mrn: document.getElementById('editPatientMRN').value
    };

    if (!patientData.name) {
        showMessage('Patient name is required', 'error');
        return;
    }

    try {
        await apiCall(`/api/patients/${editingPatientId}`, {
            method: 'PUT',
            body: JSON.stringify(patientData)
        });

        closeModal('editPatientModal');
        editingPatientId = null;
        loadPatients();
        showMessage('Patient updated successfully!', 'success');
    } catch (error) {
        showMessage('Failed to update patient', 'error');
    }
}
        async function deletePatient(id) {
    if (!confirm('Are you sure you want to delete this patient? This will also delete all tracking data.')) {
        return;
    }

    try {
        await apiCall(`/api/patients/${id}`, {
            method: 'DELETE'
        });

        loadPatients();
        showMessage('Patient deleted successfully!', 'success');
    } catch (error) {
        showMessage('Failed to delete patient', 'error');
    }
}
        // SUPPLY EDIT FUNCTIONALITY
let editingSupplyId = null;

function editSupply(id) {
    const supply = supplies.find(s => s.id === id);
    if (!supply) {
        showMessage('Supply not found', 'error');
        return;
    }

    editingSupplyId = id;
    
    // Pre-fill the form with existing data
    document.getElementById('editSupplyCode').value = supply.code;
    document.getElementById('editSupplyDescription').value = supply.description;
    document.getElementById('editSupplyHCPCS').value = supply.hcpcs || '';
    document.getElementById('editSupplyCost').value = supply.cost || '';
    
    document.getElementById('editSupplyModal').style.display = 'block';
}

async function updateSupply() {
    if (!editingSupplyId) return;

    const supplyData = {
        code: document.getElementById('editSupplyCode').value,
        description: document.getElementById('editSupplyDescription').value,
        hcpcs: document.getElementById('editSupplyHCPCS').value,
        cost: document.getElementById('editSupplyCost').value
    };

    if (!supplyData.code || !supplyData.description) {
        showMessage('Code and description are required', 'error');
        return;
    }

    try {
        await apiCall(`/api/supplies/${editingSupplyId}`, {
            method: 'PUT',
            body: JSON.stringify(supplyData)
        });

        closeModal('editSupplyModal');
        editingSupplyId = null;
        loadSupplies();
        showMessage('Supply updated successfully!', 'success');
    } catch (error) {
        showMessage('Failed to update supply', 'error');
    }
}
        async function deleteSupply(id) {
    if (!confirm('Are you sure you want to delete this supply?')) {
        return;
    }

    try {
        await apiCall(`/api/supplies/${id}`, {
            method: 'DELETE'
        });

        loadSupplies();
        showMessage('Supply deleted successfully!', 'success');
    } catch (error) {
        showMessage('Failed to delete supply', 'error');
    }
}
        function showSystemReset() { 
            if(confirm('This will reset all data. Are you sure?')) {
                alert('System reset - Feature coming soon'); 
            }
        }

        // Modal close on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
