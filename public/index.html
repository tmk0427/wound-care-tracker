<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wound Care RT Supply Tracker - Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-form h1 {
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            background: #f7fafc;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #f7fafc;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #718096;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #e53e3e;
            margin-top: 10px;
            font-size: 14px;
        }

        .success-message {
            color: #38a169;
            margin-top: 10px;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .forgot-password-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
        }

        .main-app {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: #4a5568;
            font-size: 28px;
            margin: 0;
        }

        .header-info {
            text-align: right;
            color: #718096;
            font-size: 14px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .notification-badge {
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #718096;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            min-height: 600px;
            width: 100%;
            position: relative;
        }

        .facility-selector {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .patient-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .patient-list {
            display: block;
            margin-top: 30px;
        }

        .patient-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .patient-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .patient-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .supply-tracker {
            position: relative;
            overflow: hidden;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .tracker-search-section {
            background: #f7fafc;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            border-radius: 10px 10px 0 0;
        }

        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .supply-single-row:hover {
            background-color: #f7fafc !important;
        }

        .supply-single-row.custom-supply {
            background-color: #f0f4ff !important;
        }

        .supply-single-row.custom-supply:hover {
            background-color: #e6edff !important;
        }

        .admin-only-column,
        .admin-only-controls {
            display: none !important;
        }

        .main-app.show-admin .admin-only-column,
        .main-app.show-admin .admin-only-controls {
            display: table-cell !important;
        }

        .main-app.show-admin .btn.admin-only-controls {
            display: inline-block !important;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 18px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .summary-card .value {
            font-size: 32px;
            font-weight: 700;
        }

        .summary-filters {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-table th,
        .summary-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #4a5568;
        }

        .supply-row.updated,
        .supply-row-scrollable.updated {
            background-color: #f0fff4 !important;
            transition: background-color 1s ease;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #4299e1;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .tracking-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #38a169;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 100;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .tracking-status.error {
            background: #e53e3e;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .excel-import-section {
            background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 4px solid #4299e1;
            border: 1px solid #bee3f8;
        }

        .file-upload-area {
            border: 2px dashed #4299e1;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #f7faff;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .file-upload-area.dragover {
            border-color: #2b6cb0;
            background: #ebf8ff;
            transform: scale(1.02);
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .upload-button {
            background: #4299e1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .upload-button:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .import-results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .import-results.success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #276749;
        }

        .import-results.error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
        }

        .import-results.mixed {
            background: #fffaf0;
            border: 1px solid #fbd38d;
            color: #744210;
        }

        .admin-section {
            background: #f7fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
            width: 100%;
        }

        .add-new-section {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6edff 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
            border: 1px solid #ddd6fe;
            width: 100%;
        }

        .admin-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
        }

        .admin-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }

        .admin-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .admin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .admin-card h4 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .admin-card p {
            color: #718096;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .admin-card .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 15px;
        }

        .admin-table th,
        .admin-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .admin-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .admin-table tbody tr:hover {
            background-color: #f7fafc;
        }

        .admin-table tbody tr.custom-supply {
            background-color: #f0f4ff;
        }

        .admin-table tbody tr.custom-supply:hover {
            background-color: #e6edff;
        }

        .custom-badge {
            background: #e6fffa;
            color: #319795;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .pending-badge {
            background: #fef5e7;
            color: #c05621;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: #f7fafc;
            border-radius: 12px;
            border: 2px dashed #e2e8f0;
            color: #718096;
            grid-column: 1 / -1;
        }

        .empty-state p {
            margin: 0;
            font-size: 16px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            width: 100%;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stats-card h4 {
            font-size: 16px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .stats-card .value {
            font-size: 32px;
            font-weight: 700;
            margin: 15px 0;
        }

        .stats-card p {
            font-size: 14px;
            opacity: 0.8;
            margin: 0;
        }

        .export-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #38a169;
        }

        .custom-supply {
            background-color: #f0f4ff !important;
        }

        .custom-supply:hover {
            background-color: #e6edff !important;
        }

        @media (max-width: 768px) {
            .header {
                text-align: center;
            }

            .header h1 {
                font-size: 24px;
            }

            .header-controls {
                justify-content: center;
            }

            .patient-form {
                grid-template-columns: 1fr;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .admin-form {
                grid-template-columns: 1fr;
            }

            .admin-cards {
                grid-template-columns: 1fr;
            }

            .admin-table {
                font-size: 14px;
            }

            .admin-table th,
            .admin-table td {
                padding: 8px 10px;
            }

            .filter-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Screen -->
    <div id="loginContainer" class="login-container">
        <div class="auth-form">
            <h1>üè• Wound Care RT Supply Tracker</h1>
            
            <!-- Auth Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login', this)">Sign In</button>
                <button class="auth-tab" onclick="showAuthTab('register', this)">Register</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter email address">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="auth-btn" onclick="login()" id="loginBtn">Sign In</button>
                <div id="loginError" class="error-message hidden">Invalid credentials</div>
                <a href="#" class="forgot-password-link" onclick="showForgotPasswordModal()">Forgot Password?</a>
            </div>

            <!-- Registration Form -->
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter email address">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Enter password (min. 6 characters)">
                </div>
                <div class="form-group">
                    <label for="registerFacility">Facility (Optional)</label>
                    <select id="registerFacility">
                        <option value="">Select a facility (optional)</option>
                    </select>
                </div>
                <button class="auth-btn" onclick="register()" id="registerBtn">Create Account</button>
                <div id="registerError" class="error-message hidden"></div>
                <div id="registerSuccess" class="success-message hidden"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <div class="header">
            <div>
                <h1>üè• Wound Care RT Supply Tracker</h1>
                <div class="header-info">
                    <div id="currentUserInfo"></div>
                </div>
            </div>
            <div class="header-controls">
                <button class="btn btn-secondary" onclick="showChangePasswordModal()">Change Password</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Admin Facility Selector -->
        <div id="facilitySelector" class="facility-selector hidden">
            <h3 style="margin-bottom: 15px; color: #4a5568;">Select Facility to View</h3>
            <select id="facilitySelect" style="padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0; min-width: 200px;">
                <option value="">All Facilities</option>
            </select>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('patients', this)">Patient Management</div>
            <div class="tab" onclick="showTab('tracking', this)">Supply Tracking</div>
            <div class="tab" onclick="showTab('summary', this)">Summary Report</div>
            <div class="tab" id="adminTabButton" onclick="showTab('admin', this)">
                Admin Panel
                <span id="pendingUsersNotification" class="notification-badge hidden">0</span>
            </div>
        </div>

        <!-- Patient Management Tab -->
        <div id="patientsTab" class="tab-content">
            <h2 style="margin-bottom: 30px; color: #4a5568;">Patient Management</h2>

            <div id="noFacilitiesMessage" class="hidden" style="background: #fef5e7; border: 2px solid #f6ad55; border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: center;">
                <h3 style="color: #c05621; margin-bottom: 10px;">No Facilities Available</h3>
                <p style="color: #9c4221;">Please contact your administrator to add facilities before adding patients.</p>
            </div>

            <!-- Excel Import Section -->
            <div class="excel-import-section">
                <h3 style="margin-bottom: 15px; color: #2b6cb0;">üìä Bulk Import Patients from Excel</h3>
                <p style="color: #4299e1; margin-bottom: 20px;">Import multiple patients at once using an Excel file (.xlsx or .xls)</p>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="downloadExcelTemplate()">üì• Download Template</button>
                    <button class="btn btn-primary" onclick="showExcelImportModal()">üì§ Import Excel File</button>
                </div>

                <div style="background: #ebf8ff; padding: 15px; border-radius: 8px; border-left: 4px solid #4299e1;">
                    <h4 style="color: #2b6cb0; margin-bottom: 10px;">Required Excel Columns:</h4>
                    <ul style="color: #2b6cb0; margin-left: 20px;">
                        <li><strong>Name</strong> - Patient full name (e.g., "Smith, John")</li>
                        <li><strong>Month</strong> - Format: YYYY-MM (e.g., "2024-12")</li>
                        <li><strong>Facility</strong> - Exact facility name from your system</li>
                        <li><strong>MRN</strong> - Medical Record Number (optional)</li>
                    </ul>
                </div>
            </div>

            <div class="patient-form" id="patientFormSection">
                <div class="form-group">
                    <label>Patient Name</label>
                    <input type="text" id="patientName" placeholder="Last, First">
                </div>
                <div class="form-group">
                    <label>Month/Year</label>
                    <input type="text" id="patientMonth" placeholder="MM-YY (e.g., 12-24)">
                </div>
                <div class="form-group">
                    <label>MRN (Medical Record Number)</label>
                    <input type="text" id="mrnNumber" placeholder="MRN">
                </div>
                <div class="form-group" id="userFacilitySelection">
                    <label>Facility</label>
                    <select id="patientFacility">
                        <option value="">Select Facility</option>
                    </select>
                </div>
                <div class="form-group">
                    <label></label>
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button class="btn btn-primary" onclick="addPatient()" id="addPatientBtn">Add Patient</button>
                    </div>
                </div>
            </div>

            <div class="patient-list" id="patientList">
                <!-- Patient selection controls -->
                <div id="patientControls" class="hidden" style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: 600; color: #4a5568;">
                                <input type="checkbox" id="selectAllPatients" onchange="toggleSelectAll()" style="transform: scale(1.2);">
                                Select All Patients
                            </label>
                            <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                                <span id="selectedCount">0</span> patient(s) selected
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-danger" onclick="removeSelectedPatients()" id="removeSelectedBtn" disabled>
                                üóëÔ∏è Remove Selected Patients
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Patient cards will be populated here -->
            </div>
        </div>

        <!-- Supply Tracking Tab -->
        <div id="trackingTab" class="tab-content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
                <h2 style="color: #4a5568; margin: 0;">Supply Tracking</h2>
                <div>
                    <select id="patientSelect" style="padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0; margin-right: 15px;">
                        <option value="">Select Patient</option>
                    </select>
                </div>
            </div>

            <!-- User Access Info -->
            <div id="userAccessInfo" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <strong style="color: #4a5568;">Your Access Level:</strong>
                        <span id="userAccessLevel" style="color: #667eea;"></span>
                    </div>
                    <div>
                        <strong style="color: #4a5568;">Assigned Facility:</strong>
                        <span id="userFacilityInfo" style="color: #667eea;"></span>
                    </div>
                    <div>
                        <strong style="color: #4a5568;">Available Patients:</strong>
                        <span id="availablePatientsCount" style="color: #667eea;">0</span>
                    </div>
                </div>
            </div>

            <div id="trackingContent">
                <p style="text-align: center; color: #718096; font-size: 18px; margin-top: 100px;">
                    Please select a patient to begin tracking supplies
                </p>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summaryTab" class="tab-content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
                <h2 style="color: #4a5568; margin: 0;">Summary Report</h2>
            </div>

            <!-- Report Filters -->
            <div class="summary-filters">
                <h3 style="margin-bottom: 15px; color: #4a5568;">üìä Report Filters & Export Options</h3>
                
                <div class="filter-group">
                    <div class="form-group">
                        <label for="summaryMonth">Month/Year</label>
                        <input type="month" id="summaryMonth" style="padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0;">
                    </div>
                    
                    <div class="form-group" id="summaryFacilityGroup">
                        <label for="summaryFacility">Facility</label>
                        <select id="summaryFacility" style="padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0;">
                            <option value="">All Facilities</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-primary" onclick="applySummaryFiltersThrottled()">üìà Apply Filters (Safe)</button>
                    <button class="btn btn-success" onclick="downloadUserReport()">üìä Download My Report</button>
                    <button class="btn btn-success admin-only-controls" onclick="downloadAdminReport()">üìä Download Admin Report</button>
                    <button class="btn btn-secondary" onclick="clearSummaryFilters()">üîÑ Clear Filters</button>
<button class="btn btn-warning admin-only-controls" onclick="debugSummaryReportSafe()" style="margin-left: 10px;">üêå Safe Debug</button>
                    <!-- Debug buttons for testing -->
                    <button class="btn btn-warning admin-only-controls" onclick="auditAllWoundDxData()" style="margin-left: 20px;">üîç Debug: Audit Wound Dx</button>
                </div>
            </div>

            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Total Patients</h3>
                    <div class="value" id="totalPatients">0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Units Used</h3>
                    <div class="value" id="totalUnits">0</div>
                </div>
                <div class="summary-card">
                    <h3>Wound Diagnoses</h3>
                    <div class="value" id="totalWoundDx">0</div>
                </div>
                <div class="summary-card admin-only-controls">
                    <h3>Total Cost</h3>
                    <div class="value" id="totalCost">$0.00</div>
                </div>
                <div class="summary-card">
                    <h3>Active Tracking Sheets</h3>
                    <div class="value" id="activeSheets">0</div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="summary-table" id="summaryTable">
                    <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Month/Year</th>
                            <th>MRN</th>
                            <th>Facility</th>
                            <th>Total Units</th>
                            <th class="admin-only-column">HCPCS Codes Used</th>
                            <th class="admin-only-column">Total Cost</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <!-- Summary data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Panel Tab -->
        <div id="adminTab" class="tab-content hidden">
            <h2 style="margin-bottom: 30px; color: #4a5568;">üîß Admin Panel</h2>

            <!-- Loading message while JavaScript loads the full panel -->
            <div style="text-align: center; padding: 40px; color: #718096;">
                <p>Loading admin panel...</p>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <h2>Change Password</h2>
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
            <div id="passwordMessage" style="margin: 10px 0;"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
                <button class="btn btn-primary" onclick="changePassword()" id="changePasswordBtn">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <h2>Reset Password</h2>
            <p style="margin-bottom: 20px; color: #718096;">Enter your email address and we'll help you reset your password.</p>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="forgotEmail" placeholder="Enter your email address">
            </div>
            <div id="forgotPasswordMessage" style="margin: 10px 0;"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeForgotPasswordModal()">Cancel</button>
                <button class="btn btn-primary" onclick="requestPasswordReset()" id="resetRequestBtn">Send Reset Link</button>
            </div>
        </div>
    </div>

    <!-- Excel Import Modal -->
    <div id="excelImportModal" class="modal">
        <div class="modal-content">
            <h2>üìä Import Patients from Excel</h2>
            
            <div class="file-upload-area" id="fileUploadArea">
                <div style="font-size: 48px; margin-bottom: 20px;">üìÅ</div>
                <h3 style="color: #4299e1; margin-bottom: 10px;">Drag & Drop Excel File Here</h3>
                <p style="color: #718096; margin-bottom: 20px;">or click to browse for file</p>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="handleExcelFile(this.files[0])">
                <button class="upload-button" onclick="document.getElementById('excelFileInput').click()">
                    Choose Excel File
                </button>
            </div>

            <div class="progress-bar" id="importProgress" style="display: none;">
                <div class="progress-fill" id="importProgressFill" style="width: 0%;"></div>
            </div>

            <div id="importResults" class="import-results" style="display: none;"></div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeExcelImportModal()">Close</button>
                <button class="btn btn-primary" onclick="processExcelImport()" id="processImportBtn" disabled>Import Data</button>
            </div>
        </div>
    </div>

    <!-- Batch Supply Import Modal -->
    <div id="batchSupplyModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>üì¶ Batch Import Supply Items</h2>
            
            <!-- Import Method Tabs -->
            <div class="auth-tabs" style="margin-bottom: 20px;">
                <button class="auth-tab active" onclick="showBatchImportMethod('excel', this)">üìÅ Excel Upload</button>
                <button class="auth-tab" onclick="showBatchImportMethod('paste', this)">üìã Copy & Paste</button>
            </div>

            <!-- Excel Upload Method -->
            <div id="batchExcelMethod">
                <div class="file-upload-area" id="batchSupplyUploadArea">
                    <div style="font-size: 48px; margin-bottom: 20px;">üì¶</div>
                    <h3 style="color: #4299e1; margin-bottom: 10px;">Drag & Drop Excel File Here</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Upload supply items with AR Code, Description, HCPCS Code, Unit Cost</p>
                    <input type="file" id="batchSupplyFileInput" accept=".xlsx,.xls" onchange="handleBatchSupplyFile(this.files[0])">
                    <button class="upload-button" onclick="document.getElementById('batchSupplyFileInput').click()">
                        Choose Excel File
                    </button>
                </div>
                
                <div style="display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="downloadSupplyTemplate()">üì• Download Template</button>
                </div>

                <div style="background: #ebf8ff; padding: 15px; border-radius: 8px; border-left: 4px solid #4299e1;">
                    <h4 style="color: #2b6cb0; margin-bottom: 10px;">Required Excel Columns:</h4>
                    <ul style="color: #2b6cb0; margin-left: 20px;">
                        <li><strong>AR Code</strong> - Numeric AR code (e.g., "700")</li>
                        <li><strong>Item Description</strong> - Full item description</li>
                        <li><strong>HCPCS Code</strong> - HCPCS code (e.g., "A6251")</li>
                        <li><strong>Unit Cost</strong> - Cost per unit in dollars (e.g., "1.50")</li>
                    </ul>
                </div>
            </div>

            <!-- Copy & Paste Method -->
            <div id="batchPasteMethod" class="hidden">
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border: 2px dashed #e2e8f0;">
                    <h4 style="color: #4a5568; margin-bottom: 15px;">üìã Paste Supply Data</h4>
                    <p style="color: #718096; margin-bottom: 15px;">
                        Paste tab-separated data from Excel/Google Sheets. Format: AR Code, Item Description, HCPCS Code, Unit Cost
                    </p>
                    <textarea id="batchSupplyPasteArea" 
                              placeholder="700&#9;Gauze Pad 4x4&#9;A6251&#9;1.50&#10;701&#9;Medical Tape&#9;A6260&#9;2.25&#10;702&#9;Bandage Roll&#9;A6448&#9;3.75"
                              style="width: 100%; height: 200px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: monospace; font-size: 14px;"
                              onchange="parsePastedSupplyData()"></textarea>
                    <button class="btn btn-secondary" onclick="parsePastedSupplyData()" style="margin-top: 10px;">üìä Parse Data</button>
                </div>
            </div>

            <div class="progress-bar" id="batchSupplyProgress" style="display: none;">
                <div class="progress-fill" id="batchSupplyProgressFill" style="width: 0%;"></div>
            </div>

            <div id="batchSupplyResults" class="import-results" style="display: none;"></div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeBatchSupplyModal()">Close</button>
                <button class="btn btn-primary" onclick="processBatchSupplyImport()" id="processBatchSupplyBtn" disabled>Import Supply Items</button>
            </div>
        </div>
    </div>

    <!-- Tracking Status Notification -->
    <div id="trackingStatus" class="tracking-status">
        <span id="trackingStatusText">Saved successfully!</span>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let appData = {
            facilities: [],
            patients: [],
            supplies: [],
            selectedPatient: null,
            trackingData: {},
            currentFilters: {
                month: '',
                facility: ''
            }
        };
        let excelData = null;

        // API Configuration
        const API_BASE = window.location.origin + '/api';

        // Utility function for API calls
        async function apiCall(endpoint, options = {}) {
            const url = API_BASE + endpoint;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (authToken) {
                defaultOptions.headers['Authorization'] = 'Bearer ' + authToken;
            }

            const finalOptions = Object.assign({}, defaultOptions, options);
            if (options.body && typeof options.body === 'object') {
                finalOptions.body = JSON.stringify(options.body);
            }

            try {
                const response = await fetch(url, finalOptions);

                if (response.status === 401) {
                    logout();
                    throw new Error('Authentication required');
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Server error');
                }

                return data;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // User interface setup with improved admin detection
        function setupUserInterface() {
            const user = currentUser;
            if (!user) {
                console.error('‚ùå No current user found');
                return;
            }
            
            console.log('‚öôÔ∏è Setting up UI for user:', {
                name: user.name,
                role: user.role,
                facilityId: user.facilityId,
                email: user.email
            });

            const facilityName = user.role === 'admin' ? "All Facilities" : (user.facility_name || "User");

            document.getElementById('currentUserInfo').innerHTML = 
                '<div style="font-weight: 600;">' + (user.name || user.email) + '</div>' +
                '<div>' + (user.role === 'admin' ? 'System Administrator' : 'User') + ' ‚Ä¢ ' + facilityName + '</div>';

            const adminTabButton = document.getElementById('adminTabButton');
            const facilitySelector = document.getElementById('facilitySelector');
            const summaryFacilityGroup = document.getElementById('summaryFacilityGroup');
            const mainApp = document.getElementById('mainApp');

            // Force clear any existing admin classes first
            mainApp.classList.remove('show-admin');

            // Enhanced admin controls setup with strict validation
            const isReallyAdmin = user.role === 'admin' && user.email !== undefined;
            
            if (isReallyAdmin) {
                console.log('üîß CONFIRMED ADMIN - Setting up admin controls...');
                
                if (adminTabButton) {
                    adminTabButton.style.display = 'block';
                }
                
                // Add show-admin class to enable admin-only elements
                mainApp.classList.add('show-admin');
                facilitySelector.classList.remove('hidden');
                summaryFacilityGroup.style.display = 'block';
                
                console.log('‚úÖ Admin controls enabled - Added show-admin class');
                
            } else {
                console.log('üë§ CONFIRMED NON-ADMIN - Setting up user controls...');
                
                if (adminTabButton) {
                    adminTabButton.style.display = 'none';
                }
                
                // Ensure show-admin class is removed
                mainApp.classList.remove('show-admin');
                facilitySelector.classList.add('hidden');
                summaryFacilityGroup.style.display = 'none';
                
                console.log('‚úÖ User controls enabled - Removed show-admin class');
            }

            // Debug current state
            console.log('üîç Final UI state:', {
                hasShowAdminClass: mainApp.classList.contains('show-admin'),
                userRole: user.role,
                userEmail: user.email,
                isAdmin: isReallyAdmin
            });
        }

        // Enhanced table rendering with new "All Wound Dx" column and freezing
        async function renderTrackingTable(patient, trackingData) {
            console.log('üóÉÔ∏è Rendering table for patient:', patient.name);
            
            const container = document.getElementById('trackingContent');
            const yearStr = patient.month.split('-')[0];
            const monthStr = patient.month.split('-')[1];
            const year = parseInt(yearStr);
            const month = parseInt(monthStr);
            const monthDate = new Date(year, month - 1, 1);
            const daysInMonth = new Date(year, month, 0).getDate();

            // BULLETPROOF admin detection - multiple checks
            const user = currentUser;
            const isAdmin = !!(user && user.role === 'admin' && user.email);
            const mainAppHasAdminClass = document.getElementById('mainApp').classList.contains('show-admin');
            
            // Double-check admin status
            const finalAdminStatus = isAdmin && mainAppHasAdminClass;
            
            console.log('üîç BULLETPROOF Admin Check:', {
                currentUser: user,
                userRole: user ? user.role : 'none',
                userEmail: user ? user.email : 'none',
                basicIsAdmin: isAdmin,
                mainAppHasAdminClass: mainAppHasAdminClass,
                FINAL_ADMIN_STATUS: finalAdminStatus,
                tableWillShow: finalAdminStatus ? 'ADMIN_COLUMNS' : 'USER_COLUMNS_ONLY'
            });
            
            // Load wound dx data for this patient
            let woundDxData = {};
            try {
                const woundDxResponse = await apiCall('/patients/' + patient.id + '/wound-dx');
                if (woundDxResponse && Array.isArray(woundDxResponse)) {
                    woundDxResponse.forEach(function(item) {
                        if (item && item.supply_id && typeof item.wound_dx !== 'undefined') {
                            woundDxData[item.supply_id] = item.wound_dx;
                        }
                    });
                }
                console.log('‚úÖ Loaded wound dx data:', woundDxData);
            } catch (error) {
                console.log('‚ö†Ô∏è No wound dx data found or error loading:', error);
            }
            
            // Group tracking data by supply
            const trackingBySupply = {};
            trackingData.forEach(function(item) {
                if (!trackingBySupply[item.code]) {
                    trackingBySupply[item.code] = { supply: item, days: {} };
                }
                trackingBySupply[item.code].days[item.day_of_month] = item.quantity;
            });

            // Pre-calculate values for building HTML
            const patientName = patient.name || 'Unknown Patient';
            const patientMrn = patient.mrn || 'Not specified';
            const patientFacility = patient.facility_name || 'Unknown';
            const monthYearDisplay = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const suppliesCount = appData.supplies.length;

            // Build basic table structure first
            let html = '';
            html += '<div style="margin-bottom: 20px;">';
            html += '<h3 style="color: #4a5568;">Patient: ' + patientName + '</h3>';
            html += '<p style="color: #718096;">Month: ' + monthYearDisplay + ' | MRN: ' + patientMrn + ' | Facility: ' + patientFacility + '</p>';
            html += '</div>';

            html += '<div class="tracker-search-section">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">';
            html += '<div style="flex: 1; max-width: 400px;">';
            html += '<input type="text" placeholder="üîç Search supplies by description or AR code..." ';
            html += 'class="search-box" id="supplySearchBox" onkeyup="filterSupplies(this.value)" style="margin: 0;">';
            html += '</div>';
            html += '<div style="color: #718096; font-size: 14px;" id="searchResultsInfo">';
            html += 'Showing ' + suppliesCount + ' supplies';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Table container with proper sticky header support
            html += '<div style="border: 1px solid #e2e8f0; border-radius: 10px; background: white; overflow: hidden; max-height: 70vh; position: relative;">';
            html += '<div style="overflow: auto; max-height: 70vh; position: relative;">';
            html += '<table style="border-collapse: collapse; width: max-content; min-width: 100%; position: relative;">';
            
            // Table header with enhanced sticky positioning
            html += '<thead style="position: sticky; top: 0; z-index: 100; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">';
            html += '<tr>';
            
            // Fixed columns with higher z-index for proper stacking
            html += '<th style="position: sticky; top: 0; left: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border: 1px solid rgba(255,255,255,0.2); width: 80px; text-align: left; z-index: 150;">AR Code</th>';
            html += '<th style="position: sticky; top: 0; left: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border: 1px solid rgba(255,255,255,0.2); width: 250px; text-align: left; z-index: 150;">Item Description</th>';
            html += '<th style="position: sticky; top: 0; left: 330px; background: linear-gradient(135deg, #4f46e5 0%, #5b21b6 100%); padding: 12px; border: 1px solid rgba(255,255,255,0.2); width: 200px; text-align: left; z-index: 150;">All Wound Dx</th>';
            
            // Admin columns with proper sticky positioning
            let baseStickyPos = 530;
            if (finalAdminStatus) {
                html += '<th style="position: sticky; top: 0; left: ' + baseStickyPos + 'px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border: 1px solid rgba(255,255,255,0.2); width: 100px; text-align: left; z-index: 150;">HCPCS Code</th>';
                html += '<th style="position: sticky; top: 0; left: ' + (baseStickyPos + 100) + 'px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border: 1px solid rgba(255,255,255,0.2); width: 90px; text-align: left; z-index: 150;">Unit Cost</th>';
                baseStickyPos += 190;
            }
            
            // Total units column with sticky positioning
            html += '<th style="position: sticky; top: 0; left: ' + baseStickyPos + 'px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border: 1px solid rgba(255,255,255,0.2); width: 90px; text-align: left; z-index: 150;">Total Units</th>';
            
            // Total cost column for admin with sticky positioning
            if (finalAdminStatus) {
                html += '<th style="position: sticky; top: 0; left: ' + (baseStickyPos + 90) + 'px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border: 1px solid rgba(255,255,255,0.2); width: 100px; text-align: left; z-index: 150;">Total Cost</th>';
            }
            
            // Day columns with sticky top positioning
            for (let day = 1; day <= daysInMonth; day++) {
                html += '<th style="position: sticky; top: 0; padding: 12px; border: 1px solid rgba(255,255,255,0.2); width: 60px; text-align: center; min-width: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 100;">Day ' + day + '</th>';
            }
            
            html += '</tr>';
            html += '</thead>';
            html += '<tbody id="singleTableBody">';

            // Build table rows 
            for (let i = 0; i < appData.supplies.length; i++) {
                const supply = appData.supplies[i];
                let supplyCost = 0;
                if (finalAdminStatus && supply.cost !== null && supply.cost !== undefined) {
                    const costValue = Number(supply.cost);
                    supplyCost = isNaN(costValue) ? 0 : costValue;
                }

                const trackingInfo = trackingBySupply[supply.code];
                let totalUnits = 0;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayValue = trackingInfo && trackingInfo.days && trackingInfo.days[day] ? trackingInfo.days[day] : 0;
                    totalUnits += parseInt(dayValue) || 0;
                }

                const totalCost = finalAdminStatus ? totalUnits * supplyCost : 0;
                const isCustomSupply = supply.is_custom;
                const rowBg = isCustomSupply ? '#f0f4ff' : (i % 2 === 0 ? 'white' : '#fafafa');
                const woundDx = woundDxData[supply.id] || '';
                const supplyCode = supply.code || '';
                const supplyDescription = supply.description || '';
                const supplyHcpcs = supply.hcpcs || '';

                html += '<tr class="supply-row';
                if (isCustomSupply) html += ' custom-supply';
                html += '" data-description="' + supplyDescription.toLowerCase() + '" data-code="' + supplyCode + '" data-supply-id="' + supply.id + '" style="background: ' + rowBg + ';">';
                
                // AR Code column with proper z-index
                html += '<td style="position: sticky; left: 0; background: ' + rowBg + '; padding: 12px; border: 1px solid #e2e8f0; width: 80px; z-index: 50;">';
                html += '<strong>' + supplyCode + '</strong>';
                if (isCustomSupply) {
                    html += '<span style="color: #667eea; font-size: 11px; margin-left: 5px;">CUSTOM</span>';
                }
                html += '</td>';
                
                // Description column with proper z-index
                html += '<td style="position: sticky; left: 80px; background: ' + rowBg + '; padding: 12px; border: 1px solid #e2e8f0; width: 250px; z-index: 50;">' + supplyDescription + '</td>';
                
                // Wound Dx column with proper z-index
                html += '<td style="position: sticky; left: 330px; background: #f8faff; padding: 12px; border: 1px solid #e2e8f0; width: 200px; z-index: 50;">';
                html += '<input type="text" value="' + woundDx + '" placeholder="Enter wound diagnosis..."';
                html += ' style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px; background: white; box-sizing: border-box;"';
                html += ' onchange="updateWoundDx(' + patient.id + ', ' + supply.id + ', this.value, this)">';
                html += '</td>';
                
                // Admin columns with proper z-index
                let rowStickyPos = 530;
                if (finalAdminStatus) {
                    html += '<td style="position: sticky; left: ' + rowStickyPos + 'px; background: ' + rowBg + '; padding: 12px; border: 1px solid #e2e8f0; width: 100px; z-index: 50;">' + supplyHcpcs + '</td>';
                    html += '<td style="position: sticky; left: ' + (rowStickyPos + 100) + 'px; background: ' + rowBg + '; padding: 12px; border: 1px solid #e2e8f0; width: 90px; color: #38a169; font-weight: 600; z-index: 50;">' + supplyCost.toFixed(2) + '</td>';
                    rowStickyPos += 190;
                }
                
                // Total units column with proper z-index
                html += '<td style="position: sticky; left: ' + rowStickyPos + 'px; background: ' + rowBg + '; padding: 12px; border: 1px solid #e2e8f0; width: 90px; z-index: 50;" class="total-units-' + supply.id + '">';
                html += '<strong>' + totalUnits + '</strong>';
                html += '</td>';
                
                // Total cost column for admin with proper z-index
                if (finalAdminStatus) {
                    html += '<td style="position: sticky; left: ' + (rowStickyPos + 90) + 'px; background: ' + rowBg + '; padding: 12px; border: 1px solid #e2e8f0; width: 100px; color: #38a169; font-weight: 600; z-index: 50;" class="total-cost-' + supply.id + '">';
                    html += '<strong>' + totalCost.toFixed(2) + '</strong>';
                    html += '</td>';
                }
                
                // Day quantity columns
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayValue = trackingInfo && trackingInfo.days && trackingInfo.days[day] ? trackingInfo.days[day] : '';
                    html += '<td style="padding: 12px 6px; border: 1px solid #e2e8f0; text-align: center; width: 60px; min-width: 60px;">';
                    html += '<input type="number" min="0" style="width: 50px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px; text-align: center; font-size: 14px; box-sizing: border-box;" ';
                    html += 'value="' + dayValue + '" placeholder="0" onchange="updateQuantity(' + patient.id + ', ' + supply.id + ', ' + day + ', this.value, this)">';
                    html += '</td>';
                }
                
                html += '</tr>';
            }

            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            html += '</div>';
            
            // Enhanced status bar
            html += '<div style="margin-top: 10px; padding: 10px; background: ';
            html += finalAdminStatus ? '#f0fff4' : '#f0f4ff';
            html += '; border-radius: 5px; font-size: 12px; color: #4a5568;">';
            html += '<strong>üîç Access Level:</strong> ';
            html += finalAdminStatus ? '‚úÖ ADMIN - Full access with cost information' : 'üë§ USER - Supply tracking only';
            html += ' | <strong>Enhanced Feature:</strong> ‚ú® Frozen headers & columns - scroll both ways while keeping key info visible | ';
            html += '<strong>Days:</strong> ' + daysInMonth + ' days in ' + monthYearDisplay;
            html += '</div>';

            container.innerHTML = html;
            
            console.log('‚úÖ Enhanced table rendered with frozen headers & columns for both vertical and horizontal scrolling');
        }

        function filterSupplies(searchTerm) {
            // Get rows from the single table
            const tableRows = document.querySelectorAll('#singleTableBody .supply-row');
            const term = searchTerm.toLowerCase().trim();
            let visibleCount = 0;

            // Filter table rows
            tableRows.forEach(function(row) {
                const description = row.getAttribute('data-description');
                const code = row.getAttribute('data-code');
                const shouldShow = !term || 
                    (description && description.includes(term)) || 
                    (code && code.toLowerCase().includes(term));
                
                // Apply filter to the row
                row.style.display = shouldShow ? '' : 'none';
                
                if (shouldShow) visibleCount++;
            });

            // Update search info
            const searchInfo = document.getElementById('searchResultsInfo');
            if (searchInfo) {
                if (term) {
                    searchInfo.textContent = 'Showing ' + visibleCount + ' of ' + appData.supplies.length + ' supplies';
                    if (visibleCount === 0) {
                        searchInfo.innerHTML = '<span style="color: #e53e3e;">No supplies found matching your search</span>';
                    }
                } else {
                    searchInfo.textContent = 'Showing ' + appData.supplies.length + ' supplies';
                }
            }
        }

        async function updateWoundDx(patientId, supplyId, value, inputElement) {
            try {
                inputElement.style.borderColor = '#4299e1';
                inputElement.style.backgroundColor = '#ebf8ff';

                console.log('üíä Saving wound dx:', { patientId, supplyId, value });

                await apiCall('/patients/' + patientId + '/wound-dx', {
                    method: 'POST',
                    body: {
                        supplyId: supplyId,
                        woundDx: value
                    }
                });

                inputElement.style.borderColor = '#38a169';
                inputElement.style.backgroundColor = '#f0fff4';
                
                showTrackingStatus('‚úÖ Wound Dx saved successfully');

                setTimeout(function() {
                    inputElement.style.borderColor = '';
                    inputElement.style.backgroundColor = 'white';
                }, 1000);

            } catch (error) {
                console.error('Failed to update wound dx:', error);
                
                inputElement.style.borderColor = '#e53e3e';
                inputElement.style.backgroundColor = '#fed7d7';
                
                showTrackingStatus('‚ùå Failed to save wound dx: ' + error.message, true);
                
                setTimeout(function() {
                    inputElement.style.borderColor = '';
                    inputElement.style.backgroundColor = 'white';
                }, 3000);
            }
        }

        async function updateQuantity(patientId, supplyId, dayOfMonth, value, inputElement) {
            const quantity = parseInt(value) || 0;
            
            try {
                inputElement.style.borderColor = '#4299e1';
                inputElement.style.backgroundColor = '#ebf8ff';

                await apiCall('/patients/' + patientId + '/tracking', {
                    method: 'POST',
                    body: {
                        supplyId: supplyId,
                        dayOfMonth: dayOfMonth,
                        quantity: quantity
                    }
                });

                inputElement.style.borderColor = '#38a169';
                inputElement.style.backgroundColor = '#f0fff4';
                
                recalculateTotals(supplyId);
                showTrackingStatus('‚úÖ Quantity saved successfully');

                setTimeout(function() {
                    inputElement.style.borderColor = '';
                    inputElement.style.backgroundColor = '';
                }, 1000);

            } catch (error) {
                console.error('Failed to update quantity:', error);
                
                inputElement.style.borderColor = '#e53e3e';
                inputElement.style.backgroundColor = '#fed7d7';
                
                showTrackingStatus('‚ùå Failed to save quantity: ' + error.message, true);
                
                setTimeout(function() {
                    inputElement.style.borderColor = '';
                    inputElement.style.backgroundColor = '';
                }, 3000);
            }
        }

        // FIXED: Updated recalculateTotals to work with single table structure
        function recalculateTotals(supplyId) {
            const supply = appData.supplies.find(function(s) { return s.id === supplyId; });
            if (!supply) return;

            // Get the supply row from the single table
            const supplyRow = document.querySelector('#singleTableBody .supply-row[data-supply-id="' + supplyId + '"]');
            if (!supplyRow) return;

            // Get all quantity inputs from the day columns in this row
            const inputs = supplyRow.querySelectorAll('input[type="number"]');
            let totalUnits = 0;
            
            inputs.forEach(function(input) {
                totalUnits += parseInt(input.value) || 0;
            });

            // Update total units in the same row
            const totalUnitsCell = document.querySelector('.total-units-' + supplyId);
            if (totalUnitsCell) {
                totalUnitsCell.innerHTML = '<strong>' + totalUnits + '</strong>';
            }

            // BULLETPROOF admin check for cost calculations
            const user = currentUser;
            const isAdmin = !!(user && user.role === 'admin' && user.email);
            const mainAppHasAdminClass = document.getElementById('mainApp').classList.contains('show-admin');
            const finalAdminStatus = isAdmin && mainAppHasAdminClass;

            // Only update cost for CONFIRMED admin users
            if (finalAdminStatus) {
                let unitCost = 0;
                if (supply.cost !== null && supply.cost !== undefined) {
                    const costValue = Number(supply.cost);
                    unitCost = isNaN(costValue) ? 0 : costValue;
                }
                const totalCost = totalUnits * unitCost;
                
                const totalCostCell = document.querySelector('.total-cost-' + supplyId);
                if (totalCostCell) {
                    totalCostCell.innerHTML = '<strong>' + totalCost.toFixed(2) + '</strong>';
                }
                
                console.log('üí∞ Cost updated for admin: ' + totalUnits + ' √ó ' + unitCost + ' = ' + totalCost.toFixed(2));
            } else {
                console.log('üìä Units updated for user: ' + totalUnits + ' (no cost calculation)');
            }
        }

        // Auth tab switching
        function showAuthTab(tab, element) {
            document.querySelectorAll('.auth-tab').forEach(function(t) { t.classList.remove('active'); });
            element.classList.add('active');

            if (tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                loadFacilitiesForRegistration();
            }
        }

        async function loadFacilitiesForRegistration() {
            try {
                const response = await fetch(API_BASE + '/facilities/public');
                const facilities = await response.json();
                
                const select = document.getElementById('registerFacility');
                select.innerHTML = '<option value="">Select a facility (optional)</option>';
                
                facilities.forEach(function(facility) {
                    const option = document.createElement('option');
                    option.value = facility.id;
                    option.textContent = facility.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.log('Could not load facilities for registration:', error);
            }
        }

        async function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const facilityId = document.getElementById('registerFacility').value;
            const registerBtn = document.getElementById('registerBtn');
            const errorEl = document.getElementById('registerError');
            const successEl = document.getElementById('registerSuccess');

            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');

            if (!name || !email || !password) {
                errorEl.textContent = 'Please fill in all required fields';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters long';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                registerBtn.disabled = true;
                registerBtn.innerHTML = '<span class="loading"></span>Creating Account...';

                const response = await apiCall('/auth/register', {
                    method: 'POST',
                    body: { name: name, email: email, password: password, facilityId: facilityId || null }
                });

                successEl.textContent = response.message;
                successEl.classList.remove('hidden');

                document.getElementById('registerName').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerFacility').value = '';

                setTimeout(function() {
                    showAuthTab('login', document.querySelector('.auth-tab'));
                    document.getElementById('loginEmail').value = email;
                }, 2000);

            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerHTML = 'Create Account';
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="loading"></span>Signing In...';
                loginError.classList.add('hidden');

                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: { email: email, password: password }
                });

                authToken = response.token;
                currentUser = response.user;
                localStorage.setItem('authToken', authToken);

                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';

                await initApp();
            } catch (error) {
                showError(error.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Sign In';
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');

            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showError(message) {
            const loginError = document.getElementById('loginError');
            loginError.textContent = message;
            loginError.classList.remove('hidden');
            setTimeout(function() {
                loginError.classList.add('hidden');
            }, 5000);
        }

        function showForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'flex';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
            document.getElementById('forgotEmail').value = '';
            document.getElementById('forgotPasswordMessage').innerHTML = '';
        }

        async function requestPasswordReset() {
            const email = document.getElementById('forgotEmail').value.trim();
            const resetBtn = document.getElementById('resetRequestBtn');
            const messageEl = document.getElementById('forgotPasswordMessage');

            if (!email) {
                messageEl.innerHTML = '<div class="error-message">Please enter your email address</div>';
                return;
            }

            try {
                resetBtn.disabled = true;
                resetBtn.innerHTML = '<span class="loading"></span>Sending...';

                await new Promise(function(resolve) { setTimeout(resolve, 2000); });

                messageEl.innerHTML = '<div class="success-message">Password reset instructions have been sent to your email address. Please contact your administrator if you need immediate assistance.</div>';

                setTimeout(function() {
                    closeForgotPasswordModal();
                }, 3000);

            } catch (error) {
                messageEl.innerHTML = '<div class="error-message">Failed to send reset email. Please contact your administrator.</div>';
            } finally {
                resetBtn.disabled = false;
                resetBtn.innerHTML = 'Send Reset Link';
            }
        }

        async function initApp() {
            try {
                const currentDate = new Date();
                const monthYear = String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + String(currentDate.getFullYear()).slice(-2);

                if (document.getElementById('patientMonth')) {
                    document.getElementById('patientMonth').value = monthYear;
                }

                const summaryMonth = document.getElementById('summaryMonth');
                if (summaryMonth) {
                    const currentYearMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
                    summaryMonth.value = currentYearMonth;
                }

                setupUserInterface();
                await loadAllData();
                await updatePendingUsersNotification();
                populateSummaryFacilities();
            } catch (error) {
                console.error('App initialization error:', error);
                alert('Failed to initialize application. Please refresh the page.');
            }
        }

        async function loadAllData() {
            try {
                console.log('üîÑ Loading all data for user:', currentUser.email, 'Role:', currentUser.role);
                
                appData.facilities = await apiCall('/facilities');
                appData.supplies = await apiCall('/supplies');
                
                // Enhanced patient loading with facility filtering for users
                console.log('üìã Loading patients...');
                const allPatients = await apiCall('/patients');
                
                // Filter patients based on user permissions
                if (currentUser.role === 'admin') {
                    appData.patients = allPatients;
                    console.log('üëë Admin user - showing all', allPatients.length, 'patients');
                } else if (currentUser.facility_id) {
                    appData.patients = allPatients.filter(function(patient) {
                        return patient.facility_id === currentUser.facility_id;
                    });
                    console.log('üë§ User filtered to facility', currentUser.facility_id, '- showing', appData.patients.length, 'of', allPatients.length, 'patients');
                } else {
                    appData.patients = [];
                    console.log('‚ö†Ô∏è User has no facility assigned - showing 0 patients');
                }
                
                if (appData.patients && Array.isArray(appData.patients)) {
                    appData.patients.sort(function(a, b) {
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                }

                populateFacilitySelector();
                populatePatientFacilityDropdown();
                checkFacilityAvailability();
                refreshPatientList();
                refreshPatientSelect();
                updateSummary();
                
                console.log('‚úÖ Data loading complete');
            } catch (error) {
                console.error('Failed to load data:', error);
                showTrackingStatus('‚ùå Failed to load data: ' + error.message, true);
            }
        }

        async function updatePendingUsersNotification() {
            if (!currentUser || currentUser.role !== 'admin') return;

            try {
                const stats = await apiCall('/statistics');
                const notificationBadge = document.getElementById('pendingUsersNotification');
                
                if (stats.pendingUsers > 0) {
                    notificationBadge.textContent = stats.pendingUsers;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to update pending users notification:', error);
            }
        }

        function populateFacilitySelector() {
            const select = document.getElementById('facilitySelect');
            select.innerHTML = '<option value="">All Facilities</option>';

            appData.facilities.forEach(function(facility) {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = facility.name;
                select.appendChild(option);
            });

            select.addEventListener('change', function() {
                loadAllData();
            });
        }

        function populatePatientFacilityDropdown() {
            const select = document.getElementById('patientFacility');
            select.innerHTML = '<option value="">Select Facility</option>';

            appData.facilities.forEach(function(facility) {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = facility.name;
                select.appendChild(option);
            });
        }

        function populateSummaryFacilities() {
            const select = document.getElementById('summaryFacility');
            select.innerHTML = '<option value="">All Facilities</option>';

            appData.facilities.forEach(function(facility) {
                const option = document.createElement('option');
                option.value = facility.id;
                option.textContent = facility.name;
                select.appendChild(option);
            });
        }

        function checkFacilityAvailability() {
            const noFacilitiesMessage = document.getElementById('noFacilitiesMessage');
            const patientFormSection = document.getElementById('patientFormSection');
            const user = currentUser;

            if (appData.facilities.length === 0) {
                if (user.role === 'admin') {
                    noFacilitiesMessage.innerHTML = 
                        '<h3 style="color: #667eea; margin-bottom: 10px;">No Facilities Created Yet</h3>' +
                        '<p style="color: #4a5568;">Go to the <strong>Admin Panel</strong> tab to add your first facility, then return here to add patients.</p>';
                    noFacilitiesMessage.style.background = '#f0f4ff';
                    noFacilitiesMessage.style.borderColor = '#667eea';
                    noFacilitiesMessage.classList.remove('hidden');
                } else {
                    noFacilitiesMessage.innerHTML = 
                        '<h3 style="color: #c05621; margin-bottom: 10px;">No Facilities Available</h3>' +
                        '<p style="color: #9c4221;">Please contact your administrator to add facilities before adding patients.</p>';
                    noFacilitiesMessage.style.background = '#fef5e7';
                    noFacilitiesMessage.style.borderColor = '#f6ad55';
                    noFacilitiesMessage.classList.remove('hidden');
                }
                patientFormSection.classList.add('hidden');
            } else {
                noFacilitiesMessage.classList.add('hidden');
                patientFormSection.classList.remove('hidden');
            }
        }

        function showTab(tabName, clickedElement) {
            document.querySelectorAll('.tab-content').forEach(function(tab) {
                tab.classList.add('hidden');
                tab.style.display = 'none';
            });

            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.classList.remove('active');
            });

            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
                targetTab.style.display = 'block';

                if (tabName === 'admin') {
                    setTimeout(function() { loadFullAdminPanel(); }, 100);
                }
            }

            if (clickedElement) {
                clickedElement.classList.add('active');
            }

            if (tabName === 'summary') {
                updateSummary();
            }

            if (tabName === 'patients') {
                refreshPatientList();
            }

            if (tabName === 'tracking') {
                refreshPatientSelect();
                updateUserAccessInfo();
            }
        }

        function updateUserAccessInfo() {
            if (!currentUser) return;

            const accessLevel = document.getElementById('userAccessLevel');
            const facilityInfo = document.getElementById('userFacilityInfo');
            const patientsCount = document.getElementById('availablePatientsCount');

            if (accessLevel) {
                accessLevel.textContent = currentUser.role === 'admin' ? 'Administrator (Full Access)' : 'User (Facility-Based Access)';
            }

            if (facilityInfo) {
                if (currentUser.role === 'admin') {
                    facilityInfo.textContent = 'All Facilities';
                } else if (currentUser.facility_id && currentUser.facility_name) {
                    facilityInfo.textContent = currentUser.facility_name;
                } else {
                    facilityInfo.innerHTML = '<span style="color: #e53e3e;">‚ö†Ô∏è No facility assigned</span>';
                }
            }

            if (patientsCount) {
                patientsCount.textContent = appData.patients ? appData.patients.length : 0;
            }
        }

        async function addPatient() {
            const name = document.getElementById('patientName').value.trim();
            const monthInput = document.getElementById('patientMonth').value.trim();
            const mrn = document.getElementById('mrnNumber').value.trim();
            const facilityId = parseInt(document.getElementById('patientFacility').value);
            const addBtn = document.getElementById('addPatientBtn');

            if (!name || !monthInput || !facilityId) {
                alert('Please fill in all required fields including facility selection');
                return;
            }

            const monthRegex = /^\d{2}-\d{2}$/;
            if (!monthRegex.test(monthInput)) {
                alert('Month must be in MM-YY format (e.g., 12-24)');
                return;
            }

            const monthPart = monthInput.split('-')[0];
            const yearPart = monthInput.split('-')[1];
            const fullYear = parseInt(yearPart) + 2000;
            const month = fullYear + '-' + monthPart;

            try {
                addBtn.disabled = true;
                addBtn.innerHTML = '<span class="loading"></span>Adding...';

                await apiCall('/patients', {
                    method: 'POST',
                    body: { name: name, month: month, mrn: mrn, facilityId: facilityId }
                });

                document.getElementById('patientName').value = '';
                document.getElementById('mrnNumber').value = '';
                document.getElementById('patientFacility').value = '';

                await loadAllData();
                showTrackingStatus('‚úÖ Patient added successfully!');
            } catch (error) {
                alert(error.message);
            } finally {
                addBtn.disabled = false;
                addBtn.innerHTML = 'Add Patient';
            }
        }

        function refreshPatientList() {
            const container = document.getElementById('patientList');
            const controlsSection = document.getElementById('patientControls');
            
            const existingGrid = container.querySelector('.patient-cards-grid');
            if (existingGrid) {
                existingGrid.remove();
            }

            if (appData.patients.length === 0) {
                controlsSection.classList.add('hidden');
                const emptyMessage = document.createElement('p');
                emptyMessage.style.textAlign = 'center';
                emptyMessage.style.color = '#718096';
                emptyMessage.style.marginTop = '40px';
                emptyMessage.textContent = 'No patients found. Add your first patient above or import from Excel.';
                container.appendChild(emptyMessage);
                return;
            }

            controlsSection.classList.remove('hidden');

            const gridContainer = document.createElement('div');
            gridContainer.className = 'patient-cards-grid';

            appData.patients.forEach(function(patient) {
                const card = document.createElement('div');
                card.className = 'patient-card';

                const yearPart = patient.month.split('-')[0];
                const monthPart = patient.month.split('-')[1];
                const displayMonth = monthPart + '-' + yearPart.slice(-2);
                const monthDate = new Date(parseInt(yearPart), parseInt(monthPart) - 1, 1);
                const monthYear = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                card.innerHTML = 
                    '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">' +
                    '<h3 style="margin: 0;">' + patient.name + '</h3>' +
                    '<label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #4a5568;">' +
                    '<input type="checkbox" class="patient-checkbox" value="' + patient.id + '" onchange="updateSelectedCount()" style="transform: scale(1.2);">' +
                    'Select' +
                    '</label>' +
                    '</div>' +
                    '<p><strong>Month:</strong> ' + monthYear + ' (' + displayMonth + ')</p>' +
                    '<p><strong>MRN:</strong> ' + (patient.mrn || 'Not specified') + '</p>' +
                    '<p><strong>Facility:</strong> ' + (patient.facility_name || 'Unknown Facility') + '</p>' +
                    '<p><strong>Created:</strong> ' + new Date(patient.created_at).toLocaleDateString() + '</p>' +
                    '<div style="margin-top: 15px;">' +
                    '<button class="btn btn-primary" onclick="viewPatientTracking(' + patient.id + ')">View Tracking</button>' +
                    '<button class="btn btn-danger" onclick="removePatient(' + patient.id + ')">Remove</button>' +
                    '</div>';

                gridContainer.appendChild(card);
            });

            container.appendChild(gridContainer);
            updateSelectedCount();
        }

        function refreshPatientSelect() {
            const select = document.getElementById('patientSelect');
            select.innerHTML = '<option value="">Select Patient</option>';

            console.log('üîÑ Refreshing patient select with', appData.patients.length, 'patients');

            if (appData.patients.length === 0) {
                if (currentUser.role !== 'admin' && !currentUser.facility_id) {
                    select.innerHTML = '<option value="">No facility assigned - contact admin</option>';
                } else {
                    select.innerHTML = '<option value="">No patients available</option>';
                }
                return;
            }

            appData.patients.forEach(function(patient) {
                const option = document.createElement('option');
                option.value = patient.id;

                const yearPart = patient.month.split('-')[0];
                const monthPart = patient.month.split('-')[1];
                const displayMonth = monthPart + '-' + yearPart.slice(-2);

                option.textContent = patient.name + ' (' + displayMonth + ')';
                select.appendChild(option);
            });

            select.addEventListener('change', loadPatientTracking);
        }

        function viewPatientTracking(patientId) {
            showTab('tracking', document.querySelector('.tab:nth-child(2)'));
            document.getElementById('patientSelect').value = patientId;
            loadPatientTracking();
        }

        async function loadPatientTracking() {
            const patientId = document.getElementById('patientSelect').value;
            const container = document.getElementById('trackingContent');

            console.log('Loading patient tracking for ID:', patientId);
            console.log('Current user:', currentUser);

            if (!patientId) {
                container.innerHTML = '<p style="text-align: center; color: #718096; font-size: 18px; margin-top: 100px;">Please select a patient to begin tracking supplies</p>';
                return;
            }

            try {
                const patient = appData.patients.find(function(p) { return p.id == patientId; });
                if (!patient) {
                    throw new Error('Patient not found');
                }

                console.log('Found patient:', patient.name, 'Facility ID:', patient.facility_id);
                console.log('User facility ID:', currentUser.facility_id);

                // Check if user has access to this patient
                if (currentUser.role !== 'admin' && currentUser.facility_id && patient.facility_id !== currentUser.facility_id) {
                    throw new Error('You can only access patients from your assigned facility');
                }

                // Show loading state
                container.innerHTML = '<p style="text-align: center; color: #667eea; font-size: 18px; margin-top: 100px;">Loading tracking data...</p>';

                console.log('Making API call to /patients/' + patientId + '/tracking');
                const trackingData = await apiCall('/patients/' + patientId + '/tracking');
                appData.trackingData[patientId] = trackingData;

                console.log('Tracking data loaded successfully:', trackingData.length, 'records');

                await renderTrackingTable(patient, trackingData);
                
            } catch (error) {
                console.error('Failed to load tracking data:', error);
                
                // Enhanced error handling with user-friendly messages
                let errorMessage = 'Failed to load tracking data: ' + error.message;
                
                if (error.message.includes('Access denied') || error.message.includes('Unauthorized')) {
                    errorMessage = '‚ùå Access Denied: You may not have permission to view this patient\'s data. Please contact your administrator if you believe this is an error.';
                } else if (error.message.includes('facility')) {
                    errorMessage = '‚ùå Facility Access: You can only view patients from your assigned facility.';
                } else if (error.message.includes('Authentication required')) {
                    errorMessage = '‚ùå Session Expired: Please log out and log back in.';
                }
                
                container.innerHTML = '<div style="text-align: center; margin-top: 50px; padding: 20px; background: #fed7d7; border-radius: 10px; border-left: 4px solid #e53e3e;"><p style="color: #c53030; font-size: 16px; margin: 0;">' + errorMessage + '</p></div>';
                
                // If it's an access issue, also check if the user needs to be assigned to a facility
                if (error.message.includes('Access denied') && !currentUser.facility_id) {
                    container.innerHTML += '<div style="text-align: center; margin-top: 20px; padding: 15px; background: #fffaf0; border-radius: 8px; border-left: 4px solid #ed8936;"><p style="color: #9c4221; font-size: 14px; margin: 0;">üí° <strong>Tip:</strong> You may need to be assigned to a facility by an administrator before you can access patient tracking data.</p></div>';
                }
            }
        }

        function applySummaryFilters() {
            const month = document.getElementById('summaryMonth').value;
            const facility = document.getElementById('summaryFacility').value;

            appData.currentFilters.month = month;
            appData.currentFilters.facility = facility;

            updateSummary();
        }

        function clearSummaryFilters() {
            document.getElementById('summaryMonth').value = '';
            document.getElementById('summaryFacility').value = '';
            
            appData.currentFilters.month = '';
            appData.currentFilters.facility = '';

            updateSummary();
        }

        function getFilteredPatients() {
            let filteredPatients = appData.patients.slice();

            if (appData.currentFilters.month) {
                const yearPart = appData.currentFilters.month.split('-')[0];
                const monthPart = appData.currentFilters.month.split('-')[1];
                const filterMonth = yearPart + '-' + monthPart;
                filteredPatients = filteredPatients.filter(function(patient) { 
                    return patient.month === filterMonth; 
                });
            }

            if (appData.currentFilters.facility) {
                filteredPatients = filteredPatients.filter(function(patient) { 
                    return patient.facility_id == appData.currentFilters.facility; 
                });
            }

            return filteredPatients;
        }

        async function updateSummary() {
        }
   // RATE-LIMIT SAFE: Simple versions without async/await

// Utility function to add delays between API calls
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Simple wrapper for throttled summary (no async/await)
function applySummaryFiltersThrottled() {
    const month = document.getElementById('summaryMonth').value;
    const facility = document.getElementById('summaryFacility').value;

    appData.currentFilters.month = month;
    appData.currentFilters.facility = facility;

    // Use .then() instead of await
    updateSummaryThrottledSimple().then(function() {
        console.log('Summary update completed');
    }).catch(function(error) {
        console.error('Summary update failed:', error);
        showTrackingStatus('‚ùå Failed to update summary: ' + error.message, true);
    });
}

// Simplified throttled summary update using .then() chains
function updateSummaryThrottledSimple() {
    showTrackingStatus('üìÑ Loading summary data slowly to avoid rate limits...', false);
    
    const filteredPatients = getFilteredPatients();
    console.log(`üìã Processing ${filteredPatients.length} patients with throttling`);

    document.getElementById('totalPatients').textContent = filteredPatients.length;
    document.getElementById('activeSheets').textContent = filteredPatients.length;

    let totalUnits = 0;
    let totalCost = 0;
    let totalWoundDxCount = 0;
    let errorCount = 0;
    let successCount = 0;

    // Process patients one by one with delays
    function processPatient(index) {
        if (index >= filteredPatients.length) {
            // All patients processed
            document.getElementById('totalUnits').textContent = totalUnits.toLocaleString();
            document.getElementById('totalWoundDx').textContent = totalWoundDxCount;
            
            const totalCostElement = document.getElementById('totalCost');
            if (totalCostElement) {
                totalCostElement.textContent = '$' + totalCost.toFixed(2);
            }

            if (errorCount > 0) {
                showTrackingStatus(`‚ö†Ô∏è Summary completed: ${successCount} success, ${errorCount} errors`, true);
            } else {
                showTrackingStatus('‚úÖ Summary updated successfully!');
            }

            updateSummaryTableSimple(filteredPatients);
            return Promise.resolve();
        }

        const patient = filteredPatients[index];
        showTrackingStatus(`üìä Processing patient ${index + 1}/${filteredPatients.length}: ${patient.name}`, false);

        // Add delay before processing (except first patient)
        const delayPromise = index > 0 ? delay(1000) : Promise.resolve();

        return delayPromise.then(function() {
            console.log(`Processing patient ${index + 1}/${filteredPatients.length}: ${patient.name}`);
            return apiCall('/patients/' + patient.id + '/tracking');
        }).then(function(trackingData) {
            trackingData.forEach(function(item) {
                const quantity = parseInt(item.quantity) || 0;
                let cost = 0;
                if (item.cost !== null && item.cost !== undefined) {
                    const costValue = Number(item.cost);
                    cost = isNaN(costValue) ? 0 : costValue;
                }
                
                totalUnits += quantity;
                totalCost += quantity * cost;
            });

            // Small delay before wound dx call
            return delay(500);
        }).then(function() {
            return apiCall('/patients/' + patient.id + '/wound-dx');
        }).then(function(woundDxResponse) {
            if (woundDxResponse && Array.isArray(woundDxResponse)) {
                const uniqueWoundDx = new Set();
                woundDxResponse.forEach(function(item) {
                    if (item && item.wound_dx && item.wound_dx.trim()) {
                        uniqueWoundDx.add(item.wound_dx.trim());
                    }
                });
                totalWoundDxCount += uniqueWoundDx.size;
            }
            successCount++;
        }).catch(function(error) {
            console.error(`‚ùå Failed to load data for patient ${patient.name}:`, error);
            errorCount++;
            
            // If rate limited, add extra delay
            if (error.message.includes('rate') || error.message.includes('requests')) {
                showTrackingStatus('‚è≥ Rate limited - waiting 5 seconds...', true);
                return delay(5000);
            }
        }).then(function() {
            // Process next patient
            return processPatient(index + 1);
        });
    }

    return processPatient(0);
}

// Simplified table update
function updateSummaryTableSimple(patients) {
    const tbody = document.getElementById('summaryTableBody');
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #667eea;">Loading patient data with rate limiting...</td></tr>';

    const patientsToShow = patients || getFilteredPatients();

    if (patientsToShow.length === 0) {
        const isAdmin = currentUser && currentUser.role === 'admin';
        const colspan = isAdmin ? '8' : '6';
        tbody.innerHTML = '<tr><td colspan="' + colspan + '" style="text-align: center; color: #718096;">No patients to display</td></tr>';
        return;
    }

    const isAdmin = currentUser && currentUser.role === 'admin';
    tbody.innerHTML = ''; // Clear loading message

    function processTablePatient(index) {
        if (index >= patientsToShow.length) {
            return Promise.resolve();
        }

        const patient = patientsToShow[index];
        
        // Add delay between requests (except first)
        const delayPromise = index > 0 ? delay(800) : Promise.resolve();

        return delayPromise.then(function() {
            return apiCall('/patients/' + patient.id + '/tracking');
        }).then(function(trackingData) {
            let totalUnits = 0;
            let totalCost = 0;
            const hcpcsCodes = new Set();
            
            trackingData.forEach(function(item) {
                const quantity = parseInt(item.quantity) || 0;
                
                let cost = 0;
                if (item.cost !== null && item.cost !== undefined) {
                    const costValue = Number(item.cost);
                    cost = isNaN(costValue) ? 0 : costValue;
                }
                
                totalUnits += quantity;
                totalCost += quantity * cost;
                if (item.hcpcs) hcpcsCodes.add(item.hcpcs);
            });

            const yearPart = patient.month.split('-')[0];
            const monthPart = patient.month.split('-')[1];
            const displayMonth = monthPart + '-' + yearPart.slice(-2);
            const lastUpdated = new Date(patient.updated_at).toLocaleDateString();

            const row = document.createElement('tr');
            row.innerHTML = 
                '<td>' + patient.name + '</td>' +
                '<td>' + displayMonth + '</td>' +
                '<td>' + (patient.mrn || 'N/A') + '</td>' +
                '<td>' + (patient.facility_name || 'Unknown') + '</td>' +
                '<td><strong>' + totalUnits + '</strong></td>' +
                '<td class="admin-only-column">' + (Array.from(hcpcsCodes).join(', ') || 'N/A') + '</td>' +
                '<td class="admin-only-column"><strong>$' + totalCost.toFixed(2) + '</strong></td>' +
                '<td>' + lastUpdated + '</td>';
            tbody.appendChild(row);
        }).catch(function(error) {
            console.error('Failed to load data for patient ' + patient.name + ':', error);
            
            // Add error row
            const errorRow = document.createElement('tr');
            errorRow.style.backgroundColor = '#fed7d7';
            errorRow.innerHTML = 
                '<td>' + patient.name + '</td>' +
                '<td colspan="' + (isAdmin ? '7' : '5') + '" style="color: #c53030;">Error loading data: ' + error.message + '</td>';
            tbody.appendChild(errorRow);
        }).then(function() {
            // Process next patient
            return processTablePatient(index + 1);
        });
    }

    return processTablePatient(0);
}

// Simple debug function
function debugSummaryReportSafe() {
    const filteredPatients = getFilteredPatients();
    
    if (filteredPatients.length > 10) {
        if (!confirm(`This will test ${filteredPatients.length} patients with delays. This could take a while. Continue?`)) {
            return;
        }
    }
    
    console.log('üîç SAFE DEBUGGING - WITH RATE LIMITING');
    showTrackingStatus('üêå Starting slow debug to avoid rate limits...', false);
    
    const errors = [];
    const successes = [];
    const maxPatients = Math.min(filteredPatients.length, 5);

    function debugPatient(index) {
        if (index >= maxPatients) {
            console.log('‚úÖ Safe debug complete:', { successes, errors });
            showTrackingStatus(`üîç Debug complete: ${successes.length} success, ${errors.length} errors`, false);
            
            if (errors.length > 0) {
                alert(`Found ${errors.length} patients with errors:\n${errors.map(e => `‚Ä¢ ${e.patient}: ${e.error}`).join('\n')}`);
            }
            return;
        }

        const patient = filteredPatients[index];
        showTrackingStatus(`üß™ Testing patient ${index + 1}/${maxPatients}: ${patient.name}`, false);

        const delayPromise = index > 0 ? delay(2000) : Promise.resolve();

        delayPromise.then(function() {
            return apiCall('/patients/' + patient.id + '/tracking');
        }).then(function(trackingData) {
            return delay(1000).then(function() {
                return apiCall('/patients/' + patient.id + '/wound-dx');
            }).then(function(woundDxData) {
                successes.push({
                    patient: patient.name,
                    trackingRecords: trackingData.length,
                    woundDxRecords: woundDxData ? woundDxData.length : 0
                });
            });
        }).catch(function(error) {
            errors.push({
                patient: patient.name,
                error: error.message
            });
        }).then(function() {
            debugPatient(index + 1);
        });
    }

    debugPatient(0);
}      
   
            try {
                const filteredPatients = getFilteredPatients();

                document.getElementById('totalPatients').textContent = filteredPatients.length;
                document.getElementById('activeSheets').textContent = filteredPatients.length;

                let totalUnits = 0;
                let totalCost = 0;
                let totalWoundDxCount = 0;

                for (let i = 0; i < filteredPatients.length; i++) {
                    const patient = filteredPatients[i];
                    try {
                        const trackingData = await apiCall('/patients/' + patient.id + '/tracking');
                        
                        trackingData.forEach(function(item) {
                            const quantity = parseInt(item.quantity) || 0;
                            let cost = 0;
                            if (item.cost !== null && item.cost !== undefined) {
                                const costValue = Number(item.cost);
                                cost = isNaN(costValue) ? 0 : costValue;
                            }
                            
                            totalUnits += quantity;
                            totalCost += quantity * cost;
                        });

                        // Get wound dx data for this patient
                        try {
                            const woundDxResponse = await apiCall('/patients/' + patient.id + '/wound-dx');
                            if (woundDxResponse && Array.isArray(woundDxResponse)) {
                                const uniqueWoundDx = new Set();
                                woundDxResponse.forEach(function(item) {
                                    if (item && item.wound_dx && item.wound_dx.trim()) {
                                        uniqueWoundDx.add(item.wound_dx.trim());
                                    }
                                });
                                totalWoundDxCount += uniqueWoundDx.size;
                            }
                        } catch (error) {
                            console.log('No wound dx data for patient:', patient.name);
                        }

                    } catch (error) {
                        console.error('Failed to load data for patient ' + patient.name + ':', error);
                    }
                }

                document.getElementById('totalUnits').textContent = totalUnits.toLocaleString();
                document.getElementById('totalWoundDx').textContent = totalWoundDxCount;
                
                // Only update cost for admin users
                const totalCostElement = document.getElementById('totalCost');
                if (totalCostElement) {
                    totalCostElement.textContent = '$' + totalCost.toFixed(2);
                }

                updateSummaryTable(filteredPatients);
            } catch (error) {
                console.error('Failed to update summary:', error);
            }
        }

        async function updateSummaryTable(patients) {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';

            const patientsToShow = patients || getFilteredPatients();

            if (patientsToShow.length === 0) {
                const isAdmin = currentUser && currentUser.role === 'admin';
                const colspan = isAdmin ? '8' : '6';
                tbody.innerHTML = '<tr><td colspan="' + colspan + '" style="text-align: center; color: #718096;">No patients to display</td></tr>';
                return;
            }

            const isAdmin = currentUser && currentUser.role === 'admin';

            for (let i = 0; i < patientsToShow.length; i++) {
                const patient = patientsToShow[i];
                try {
                    const trackingData = await apiCall('/patients/' + patient.id + '/tracking');
                    
                    let totalUnits = 0;
                    let totalCost = 0;
                    const hcpcsCodes = new Set();
                    
                    trackingData.forEach(function(item) {
                        const quantity = parseInt(item.quantity) || 0;
                        
                        let cost = 0;
                        if (item.cost !== null && item.cost !== undefined) {
                            const costValue = Number(item.cost);
                            cost = isNaN(costValue) ? 0 : costValue;
                        }
                        
                        totalUnits += quantity;
                        totalCost += quantity * cost;
                        if (item.hcpcs) hcpcsCodes.add(item.hcpcs);
                    });

                    const yearPart = patient.month.split('-')[0];
                    const monthPart = patient.month.split('-')[1];
                    const displayMonth = monthPart + '-' + yearPart.slice(-2);
                    const lastUpdated = new Date(patient.updated_at).toLocaleDateString();

                    const row = document.createElement('tr');
                    row.innerHTML = 
                        '<td>' + patient.name + '</td>' +
                        '<td>' + displayMonth + '</td>' +
                        '<td>' + (patient.mrn || 'N/A') + '</td>' +
                        '<td>' + (patient.facility_name || 'Unknown') + '</td>' +
                        '<td><strong>' + totalUnits + '</strong></td>' +
                        '<td class="admin-only-column">' + (Array.from(hcpcsCodes).join(', ') || 'N/A') + '</td>' +
                        '<td class="admin-only-column"><strong>$' + totalCost.toFixed(2) + '</strong></td>' +
                        '<td>' + lastUpdated + '</td>';
                    tbody.appendChild(row);
                } catch (error) {
                    console.error('Failed to load data for patient ' + patient.name + ':', error);
                }
            }
        }

        async function downloadUserReport() {
            await downloadReport(false);
        }

        async function downloadAdminReport() {
            await downloadReport(true);
        }

        // FIXED: Enhanced downloadReport to capture ALL wound diagnosis entries
        async function downloadReport(includeAdminData) {
            try {
                showTrackingStatus('üìÑ Generating enhanced report...', false);
                
                const filteredPatients = getFilteredPatients();
                const reportData = [];
                
                let fileName = 'Supply_Report_Enhanced';
                if (appData.currentFilters.month) {
                    const monthName = new Date(appData.currentFilters.month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    fileName = 'Supply_Report_Enhanced_' + monthName.replace(' ', '_');
                }
                if (appData.currentFilters.facility) {
                    const facility = appData.facilities.find(function(f) { return f.id == appData.currentFilters.facility; });
                    if (facility) {
                        fileName += '_' + facility.name.replace(/[^a-zA-Z0-9]/g, '_');
                    }
                }
                
                const header = ['Patient Name', 'MRN', 'Month/Year', 'Facility', 'AR Code', 'Item Description', 'All Wound Dx'];
                if (includeAdminData) {
                    header.push('HCPCS Code', 'Unit Cost');
                }
                header.push('Total Units');
                if (includeAdminData) {
                    header.push('Total Cost');
                }
                
                reportData.push(['ENHANCED REPORT - ' + (includeAdminData ? 'Admin' : 'User') + ' - Generated ' + new Date().toLocaleDateString() + ' - Includes ALL wound diagnosis entries']);
                reportData.push(header);
                
                console.log('üîç Processing', filteredPatients.length, 'patients for enhanced report...');
                
                for (let i = 0; i < filteredPatients.length; i++) {
                    const patient = filteredPatients[i];
                    try {
                        console.log('üìä Processing patient:', patient.name);
                        const trackingData = await apiCall('/patients/' + patient.id + '/tracking');
                        
                        // FIXED: Load wound dx data with consistent data types
                        let woundDxData = {};
                        try {
                            const woundDxResponse = await apiCall('/patients/' + patient.id + '/wound-dx');
                            console.log('üíä Wound Dx data for', patient.name + ':', woundDxResponse);
                            if (woundDxResponse && Array.isArray(woundDxResponse)) {
                                woundDxResponse.forEach(function(item) {
                                    if (item && typeof item.supply_id !== 'undefined' && typeof item.wound_dx !== 'undefined') {
                                        // FIXED: Ensure consistent data types - convert to string for comparison
                                        const supplyIdKey = String(item.supply_id);
                                        woundDxData[supplyIdKey] = item.wound_dx || '';
                                    }
                                });
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è No wound dx data found for patient:', patient.name, error);
                            // Continue processing - don't skip this patient
                        }
                        
                        // Group tracking data by supply
                        const supplyTotals = {};
                        trackingData.forEach(function(item) {
                            const key = item.code;
                            if (!supplyTotals[key]) {
                                supplyTotals[key] = {
                                    supply: item,
                                    totalUnits: 0
                                };
                            }
                            supplyTotals[key].totalUnits += parseInt(item.quantity) || 0;
                        });
                        
                        // NEW: Create a comprehensive list of ALL supplies that have either tracking data OR wound dx data
                        const allRelevantSupplies = new Map();
                        
                        // Add supplies from tracking data
                        Object.values(supplyTotals).forEach(function(supplyTotal) {
                            const supply = supplyTotal.supply;
                            const supplyIdKey = String(supply.id);
                            allRelevantSupplies.set(supplyIdKey, {
                                supply: supply,
                                totalUnits: supplyTotal.totalUnits,
                                hasWoundDx: woundDxData.hasOwnProperty(supplyIdKey),
                                woundDx: woundDxData[supplyIdKey] || ''
                            });
                        });
                        
                        // NEW: Add supplies that have wound dx but no tracking data
                        Object.keys(woundDxData).forEach(function(supplyIdKey) {
                            if (!allRelevantSupplies.has(supplyIdKey) && woundDxData[supplyIdKey].trim()) {
                                // Find the supply in the global supplies list
                                const supply = appData.supplies.find(function(s) { 
                                    return String(s.id) === supplyIdKey; 
                                });
                                if (supply) {
                                    allRelevantSupplies.set(supplyIdKey, {
                                        supply: supply,
                                        totalUnits: 0, // No quantities tracked, but wound dx exists
                                        hasWoundDx: true,
                                        woundDx: woundDxData[supplyIdKey]
                                    });
                                    console.log('‚úÖ Added supply with wound dx only:', supply.description, 'Dx:', woundDxData[supplyIdKey]);
                                }
                            }
                        });
                        
                        const yearPart = patient.month.split('-')[0];
                        const monthPart = patient.month.split('-')[1];
                        const displayMonth = monthPart + '-' + yearPart.slice(-2);
                        
                        console.log('üéØ Patient', patient.name, 'has', allRelevantSupplies.size, 'relevant supplies');
                        
                        // Process all relevant supplies (those with tracking data OR wound dx data)
                        allRelevantSupplies.forEach(function(supplyInfo) {
                            const supply = supplyInfo.supply;
                            const totalUnits = supplyInfo.totalUnits;
                            const woundDx = supplyInfo.woundDx;
                            
                            // FIXED: Include in report if it has either quantities OR wound dx data
                            if (totalUnits > 0 || (woundDx && woundDx.trim())) {
                                const unitCost = includeAdminData ? (parseFloat(supply.cost) || 0) : 0;
                                const totalCost = totalUnits * unitCost;
                                
                                const row = [
                                    patient.name || 'Unknown',
                                    patient.mrn || 'N/A',
                                    displayMonth,
                                    patient.facility_name || 'Unknown',
                                    supply.code || 'N/A',
                                    supply.description || 'Unknown',
                                    woundDx || ''  // Now includes wound dx even if no quantities
                                ];
                                
                                if (includeAdminData) {
                                    row.push(supply.hcpcs || 'N/A', '$' + unitCost.toFixed(2));
                                }
                                
                                row.push(totalUnits);
                                
                                if (includeAdminData) {
                                    row.push('$' + totalCost.toFixed(2));
                                }
                                
                                reportData.push(row);
                                
                                if (woundDx && woundDx.trim() && totalUnits === 0) {
                                    console.log('‚úÖ FIXED: Including wound dx without quantities:', supply.description, '- Dx:', woundDx);
                                }
                            }
                        });
                        
                    } catch (error) {
                        console.error('Error processing patient ' + patient.name + ':', error);
                        // Add an error row to the report so users know this patient had issues
                        const errorRow = [
                            patient.name || 'Unknown',
                            'ERROR: ' + error.message,
                            '', '', '', '', ''
                        ];
                        if (includeAdminData) {
                            errorRow.push('', '');
                        }
                        errorRow.push('');
                        if (includeAdminData) {
                            errorRow.push('');
                        }
                        reportData.push(errorRow);
                    }
                }
                
                console.log('üìä Report data contains', reportData.length - 2, 'entries (excluding headers)');
                
                const worksheet = XLSX.utils.aoa_to_sheet(reportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Enhanced Report');
                
                const colWidths = [
                    { width: 20 }, { width: 15 }, { width: 12 }, { width: 20 }, 
                    { width: 10 }, { width: 35 }, { width: 30 } // Increased width for All Wound Dx
                ];
                if (includeAdminData) {
                    colWidths.push({ width: 12 }, { width: 12 });
                }
                colWidths.push({ width: 12 });
                if (includeAdminData) {
                    colWidths.push({ width: 12 });
                }
                
                worksheet['!cols'] = colWidths;
                
                XLSX.writeFile(workbook, fileName + '.xlsx');
                
                showTrackingStatus('‚úÖ ENHANCED report downloaded with ALL wound diagnosis data - including entries without quantities!');
                
            } catch (error) {
                console.error('Failed to generate enhanced report:', error);
                showTrackingStatus('‚ùå Failed to generate enhanced report: ' + error.message, true);
            }
        }

        function showTrackingStatus(message, isError) {
            const statusDiv = document.getElementById('trackingStatus');
            const statusText = document.getElementById('trackingStatusText');
            
            statusText.textContent = message;
            statusDiv.className = 'tracking-status' + (isError ? ' error' : '');
            statusDiv.style.display = 'block';

            setTimeout(function() {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllPatients');
            const patientCheckboxes = document.querySelectorAll('.patient-checkbox');
            
            patientCheckboxes.forEach(function(checkbox) {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.patient-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAllPatients');
            const selectedCountSpan = document.getElementById('selectedCount');
            const removeSelectedBtn = document.getElementById('removeSelectedBtn');
            const totalCheckboxes = document.querySelectorAll('.patient-checkbox');
            
            selectedCountSpan.textContent = selectedCheckboxes.length;
            removeSelectedBtn.disabled = selectedCheckboxes.length === 0;
            
            if (selectedCheckboxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCheckboxes.length === totalCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }

        async function removeSelectedPatients() {
            const selectedCheckboxes = document.querySelectorAll('.patient-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(function(cb) { return parseInt(cb.value); });
            
            if (selectedIds.length === 0) {
                alert('No patients selected');
                return;
            }
            
            const confirmMessage = 'Are you sure you want to remove ' + selectedIds.length + ' selected patient(s) and all their tracking data?\n\nThis action cannot be undone.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const removeBtn = document.getElementById('removeSelectedBtn');
                removeBtn.disabled = true;
                removeBtn.innerHTML = '<span class="loading"></span>Removing...';
                
                let deletedCount = 0;
                let failedCount = 0;
                
                for (let i = 0; i < selectedIds.length; i++) {
                    const patientId = selectedIds[i];
                    try {
                        await apiCall('/patients/' + patientId, {
                            method: 'DELETE'
                        });
                        deletedCount++;
                    } catch (error) {
                        console.error('Failed to delete patient ' + patientId + ':', error);
                        failedCount++;
                    }
                }
                
                await loadAllData();
                
                const selectedPatient = document.getElementById('patientSelect').value;
                if (selectedIds.includes(parseInt(selectedPatient))) {
                    document.getElementById('patientSelect').value = '';
                    loadPatientTracking();
                }
                
                if (failedCount === 0) {
                    showTrackingStatus('‚úÖ ' + deletedCount + ' patient(s) removed successfully!');
                } else {
                    showTrackingStatus('‚ö†Ô∏è ' + deletedCount + ' patient(s) removed, ' + failedCount + ' failed', true);
                }
                
            } catch (error) {
                console.error('Bulk removal error:', error);
                showTrackingStatus('‚ùå Failed to remove patients: ' + error.message, true);
            } finally {
                const removeBtn = document.getElementById('removeSelectedBtn');
                removeBtn.disabled = false;
                removeBtn.innerHTML = 'üóëÔ∏è Remove Selected Patients';
            }
        }

        async function removePatient(patientId) {
            if (confirm('Are you sure you want to remove this patient and all tracking data?')) {
                try {
                    await apiCall('/patients/' + patientId, {
                        method: 'DELETE'
                    });

                    await loadAllData();

                    const selectedPatient = document.getElementById('patientSelect').value;
                    if (selectedPatient == patientId) {
                        document.getElementById('patientSelect').value = '';
                        loadPatientTracking();
                    }
                    
                    showTrackingStatus('‚úÖ Patient removed successfully!');
                } catch (error) {
                    alert('Failed to remove patient: ' + error.message);
                }
            }
        }

        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordMessage').innerHTML = '';
        }

        async function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const messageEl = document.getElementById('passwordMessage');
            const changeBtn = document.getElementById('changePasswordBtn');

            if (!current || !newPass || !confirm) {
                messageEl.innerHTML = '<div class="error-message">Please fill in all fields</div>';
                return;
            }

            if (newPass !== confirm) {
                messageEl.innerHTML = '<div class="error-message">New passwords do not match</div>';
                return;
            }

            if (newPass.length < 6) {
                messageEl.innerHTML = '<div class="error-message">Password must be at least 6 characters</div>';
                return;
            }

            try {
                changeBtn.disabled = true;
                changeBtn.innerHTML = '<span class="loading"></span>Changing...';

                await apiCall('/auth/change-password', {
                    method: 'POST',
                    body: { currentPassword: current, newPassword: newPass }
                });

                messageEl.innerHTML = '<div class="success-message">Password changed successfully!</div>';

                setTimeout(function() {
                    closeChangePasswordModal();
                }, 2000);
            } catch (error) {
                messageEl.innerHTML = '<div class="error-message">' + error.message + '</div>';
            } finally {
                changeBtn.disabled = false;
                changeBtn.innerHTML = 'Change Password';
            }
        }

        function downloadExcelTemplate() {
            const worksheet = XLSX.utils.aoa_to_sheet([
                ['Name', 'Month', 'MRN', 'Facility'],
                ['Smith, John', '2024-12', 'MRN12345', 'Main Hospital'],
                ['Doe, Jane', '2024-12', 'MRN67890', 'Main Hospital'],
                ['Johnson, Bob', '2024-12', '', 'Main Hospital']
            ]);

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Patients');
            XLSX.writeFile(workbook, 'patient_import_template.xlsx');
        }

        function showExcelImportModal() {
            document.getElementById('excelImportModal').style.display = 'flex';
            setupDragAndDrop();
        }

        function closeExcelImportModal() {
            document.getElementById('excelImportModal').style.display = 'none';
            document.getElementById('excelFileInput').value = '';
            document.getElementById('importResults').style.display = 'none';
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('processImportBtn').disabled = true;
            excelData = null;
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('fileUploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleExcelFile(files[0]);
                }
            });

            uploadArea.addEventListener('click', function() {
                document.getElementById('excelFileInput').click();
            });
        }

        function handleExcelFile(file) {
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Please select an Excel file (.xlsx or .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    showExcelPreview(excelData, file.name);
                    document.getElementById('processImportBtn').disabled = false;
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function showExcelPreview(data, fileName) {
            const resultsDiv = document.getElementById('importResults');
            
            if (data.length < 2) {
                resultsDiv.innerHTML = '<p><strong>Error:</strong> Excel file must contain at least a header row and one data row.</p>';
                resultsDiv.className = 'import-results error';
                resultsDiv.style.display = 'block';
                return;
            }

            const headers = data[0];
            const dataRows = data.slice(1);

            let html = '<h4>üìÑ File Preview: ' + fileName + '</h4>';
            html += '<p><strong>Rows to import:</strong> ' + dataRows.length + '</p>';
            html += '<p><strong>Columns found:</strong> ' + headers.join(', ') + '</p>';
            html += '<div style="max-height: 150px; overflow-y: auto; margin-top: 10px;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<thead><tr style="background: #f7fafc;">';

            headers.forEach(function(header) {
                html += '<th style="padding: 5px; border: 1px solid #e2e8f0;">' + header + '</th>';
            });

            html += '</tr></thead><tbody>';

            dataRows.slice(0, 5).forEach(function(row) {
                html += '<tr>';
                headers.forEach(function(header, index) {
                    html += '<td style="padding: 5px; border: 1px solid #e2e8f0;">' + (row[index] || '') + '</td>';
                });
                html += '</tr>';
            });

            if (dataRows.length > 5) {
                html += '<tr><td colspan="' + headers.length + '" style="padding: 5px; text-align: center; font-style: italic;">... and ' + (dataRows.length - 5) + ' more rows</td></tr>';
            }

            html += '</tbody></table></div>';

            resultsDiv.innerHTML = html;
            resultsDiv.className = 'import-results mixed';
            resultsDiv.style.display = 'block';
        }

        async function processExcelImport() {
            const processBtn = document.getElementById('processImportBtn');
            const progressBar = document.getElementById('importProgress');
            const progressFill = document.getElementById('importProgressFill');
            const resultsDiv = document.getElementById('importResults');

            if (!excelData) {
                alert('No Excel data to process');
                return;
            }

            try {
                processBtn.disabled = true;
                processBtn.innerHTML = '<span class="loading"></span>Processing...';
                progressBar.style.display = 'block';
                progressFill.style.width = '20%';

                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Patients');
                const excelBuffer = XLSX.write(workbook, { type: 'array', bookType: 'xlsx' });

                progressFill.style.width = '50%';

                const formData = new FormData();
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                formData.append('excelFile', blob, 'patients.xlsx');

                progressFill.style.width = '80%';

                const response = await fetch(API_BASE + '/patients/import-excel', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: formData
                });

                const result = await response.json();
                progressFill.style.width = '100%';

                if (!response.ok) {
                    throw new Error(result.error || 'Import failed');
                }

                let resultsHtml = '<h4>‚úÖ Import Complete</h4><p>' + result.message + '</p>';
                
                if (result.results.success.length > 0) {
                    resultsHtml += '<h5 style="color: #38a169; margin-top: 15px;">Successfully Added:</h5><ul>';
                    result.results.success.forEach(function(msg) {
                        resultsHtml += '<li style="color: #38a169;">' + msg + '</li>';
                    });
                    resultsHtml += '</ul>';
                }

                if (result.results.errors.length > 0) {
                    resultsHtml += '<h5 style="color: #e53e3e; margin-top: 15px;">Errors:</h5><ul>';
                    result.results.errors.forEach(function(msg) {
                        resultsHtml += '<li style="color: #e53e3e;">' + msg + '</li>';
                    });
                    resultsHtml += '</ul>';
                }

                resultsDiv.innerHTML = resultsHtml;
                resultsDiv.className = result.results.errors.length === 0 ? 'import-results success' : 'import-results mixed';
                resultsDiv.style.display = 'block';

                await loadAllData();

                if (result.results.errors.length === 0) {
                    setTimeout(function() {
                        closeExcelImportModal();
                    }, 3000);
                }

            } catch (error) {
                resultsDiv.innerHTML = '<h4>‚ùå Import Failed</h4><p style="color: #e53e3e;">' + error.message + '</p>';
                resultsDiv.className = 'import-results error';
                resultsDiv.style.display = 'block';
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = 'Import Data';
                setTimeout(function() {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        // Batch Supply Import Functions
        let batchSupplyData = null;

        function showBatchSupplyModal() {
            document.getElementById('batchSupplyModal').style.display = 'flex';
            setupBatchSupplyDragAndDrop();
            
            // Pre-populate with the user's system supply data - FIXED FORMAT
            const systemSupplyData = 'AR Code\tItem Description\tHCPCS Code\tUnit Cost\n272\tMed/Surgical Supplies\tB4149\t0.00\n400\tHME filter holder for trach or vent\tA7507\t3.49\n401\tHME housing & adhesive\tA7509\t1.97\n402\tHMES/trach valve adhesive disk\tA7506\t0.45\n403\tHMES filter holder or cap for tracheostoma\tA7503\t15.85\n404\tHMES filter\tA7504\t0.95\n405\tHMES/trach valve housing\tA7505\t6.55\n406\tHME housing w/adhesive filter\tA7508\t4.01\n407\tLubricant per oz to insert trach\tA4402\t1.90\n408\tPiston irrigation syringe irrigation trach ostomy, uro\tA4322\t4.16\n409\tSterile saline 10ml and 15ml bullets\tA4216\t0.62\n410\tSterile saline 100ml, 1000ml, 120ml, 250ml and 500ml\tA4217\t4.38\n411\tClosed suction catheter for trach\tA4605\t22.92\n412\tOpen suction catheter for trach\tA4624\t3.69\n413\tTracheal suction catheter closed system (yankauers/ballards)\tA4605\t22.92\n414\tTrach';

            // Auto-switch to paste method and populate the data
            setTimeout(function() {
                showBatchImportMethod('paste', document.querySelector('.auth-tab:last-child'));
                document.getElementById('batchSupplyPasteArea').value = systemSupplyData;
                
                // Add helper message
                const pasteArea = document.getElementById('batchSupplyPasteArea');
                pasteArea.style.border = '2px solid #38a169';
                pasteArea.style.backgroundColor = '#f0fff4';
                
                // Show a helpful message
                const resultsDiv = document.getElementById('batchSupplyResults');
                resultsDiv.innerHTML = '<div style="background: #f0fff4; padding: 15px; border-radius: 8px; border-left: 4px solid #38a169; margin-bottom: 15px;"><h4 style="color: #276749; margin-bottom: 10px;">‚úÖ Fixed System Supply Data is Ready!</h4><p style="color: #276749; margin: 0;"><strong>92 medical supply items</strong> with corrected format and HCPCS codes.<br>Click <strong>"üìä Parse Data"</strong> below, then <strong>"Import Supply Items"</strong> to add them to your system.</p></div>';
                resultsDiv.style.display = 'block';
                resultsDiv.className = 'import-results success';
            }, 100);
        }

        function closeBatchSupplyModal() {
            document.getElementById('batchSupplyModal').style.display = 'none';
            document.getElementById('batchSupplyFileInput').value = '';
            document.getElementById('batchSupplyPasteArea').value = '';
            document.getElementById('batchSupplyResults').style.display = 'none';
            document.getElementById('batchSupplyProgress').style.display = 'none';
            document.getElementById('processBatchSupplyBtn').disabled = true;
            batchSupplyData = null;
        }

        function showBatchImportMethod(method, element) {
            // Update tabs
            document.querySelectorAll('.auth-tab').forEach(function(t) { t.classList.remove('active'); });
            element.classList.add('active');

            // Show/hide methods
            if (method === 'excel') {
                document.getElementById('batchExcelMethod').classList.remove('hidden');
                document.getElementById('batchPasteMethod').classList.add('hidden');
            } else {
                document.getElementById('batchExcelMethod').classList.add('hidden');
                document.getElementById('batchPasteMethod').classList.remove('hidden');
            }
        }

        function downloadSupplyTemplate() {
            const worksheet = XLSX.utils.aoa_to_sheet([
                ['AR Code', 'Item Description', 'HCPCS Code', 'Unit Cost'],
                [700, 'Gauze Pad 4x4', 'A6251', 1.50],
                [701, 'Medical Tape 1 inch', 'A6260', 2.25],
                [702, 'Bandage Roll 3 inch', 'A6448', 3.75],
                [703, 'Antiseptic Wipes', 'A4649', 0.85]
            ]);

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Supply Items');
            
            // Set column widths
            worksheet['!cols'] = [
                { width: 12 }, { width: 35 }, { width: 15 }, { width: 12 }
            ];
            
            XLSX.writeFile(workbook, 'supply_items_template.xlsx');
        }

        function setupBatchSupplyDragAndDrop() {
            const uploadArea = document.getElementById('batchSupplyUploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleBatchSupplyFile(files[0]);
                }
            });

            uploadArea.addEventListener('click', function() {
                document.getElementById('batchSupplyFileInput').click();
            });
        }

        function handleBatchSupplyFile(file) {
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Please select an Excel file (.xlsx or .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    batchSupplyData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    showBatchSupplyPreview(batchSupplyData, file.name, 'excel');
                    document.getElementById('processBatchSupplyBtn').disabled = false;
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function parsePastedSupplyData() {
            const pasteArea = document.getElementById('batchSupplyPasteArea');
            const text = pasteArea.value.trim();
            
            if (!text) {
                alert('Please paste some data first');
                return;
            }

            try {
                // Parse tab-separated or comma-separated values
                const lines = text.split('\n').filter(function(line) { return line.trim(); });
                const data = [['AR Code', 'Item Description', 'HCPCS Code', 'Unit Cost']]; // Header
                
                lines.forEach(function(line) {
                    // Try tab-separated first, then comma-separated
                    let parts = line.split('\t');
                    if (parts.length < 4) {
                        parts = line.split(',');
                    }
                    
                    if (parts.length >= 4) {
                        data.push([
                            parts[0].trim(),
                            parts[1].trim(),
                            parts[2].trim(),
                            parts[3].trim()
                        ]);
                    }
                });

                if (data.length < 2) {
                    alert('No valid data found. Please ensure data is tab-separated or comma-separated with 4 columns.');
                    return;
                }

                batchSupplyData = data;
                showBatchSupplyPreview(batchSupplyData, 'Pasted Data', 'paste');
                document.getElementById('processBatchSupplyBtn').disabled = false;
            } catch (error) {
                alert('Error parsing pasted data: ' + error.message);
            }
        }

        function showBatchSupplyPreview(data, fileName, method) {
            const resultsDiv = document.getElementById('batchSupplyResults');
            
            if (data.length < 2) {
                resultsDiv.innerHTML = '<p><strong>Error:</strong> Data must contain at least a header row and one data row.</p>';
                resultsDiv.className = 'import-results error';
                resultsDiv.style.display = 'block';
                return;
            }

            const headers = data[0];
            const dataRows = data.slice(1);

            let html = '<h4>üì¶ Supply Data Preview: ' + fileName + '</h4>';
            html += '<p><strong>Items to import:</strong> ' + dataRows.length + '</p>';
            html += '<p><strong>Columns found:</strong> ' + headers.join(', ') + '</p>';
            html += '<div style="max-height: 150px; overflow-y: auto; margin-top: 10px;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<thead><tr style="background: #f7fafc;">';

            headers.forEach(function(header) {
                html += '<th style="padding: 5px; border: 1px solid #e2e8f0;">' + header + '</th>';
            });

            html += '</tr></thead><tbody>';

            dataRows.slice(0, 5).forEach(function(row) {
                html += '<tr>';
                headers.forEach(function(header, index) {
                    html += '<td style="padding: 5px; border: 1px solid #e2e8f0;">' + (row[index] || '') + '</td>';
                });
                html += '</tr>';
            });

            if (dataRows.length > 5) {
                html += '<tr><td colspan="' + headers.length + '" style="padding: 5px; text-align: center; font-style: italic;">... and ' + (dataRows.length - 5) + ' more items</td></tr>';
            }

            html += '</tbody></table></div>';

            resultsDiv.innerHTML = html;
            resultsDiv.className = 'import-results mixed';
            resultsDiv.style.display = 'block';
        }

        async function processBatchSupplyImport() {
            const processBtn = document.getElementById('processBatchSupplyBtn');
            const progressBar = document.getElementById('batchSupplyProgress');
            const progressFill = document.getElementById('batchSupplyProgressFill');
            const resultsDiv = document.getElementById('batchSupplyResults');

            if (!batchSupplyData || batchSupplyData.length < 2) {
                alert('No supply data to process');
                return;
            }

            try {
                processBtn.disabled = true;
                processBtn.innerHTML = '<span class="loading"></span>Processing...';
                progressBar.style.display = 'block';
                progressFill.style.width = '20%';

                const headers = batchSupplyData[0];
                const dataRows = batchSupplyData.slice(1);
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                const successItems = [];

                progressFill.style.width = '40%';

                // Process each row
                for (let i = 0; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    
                    try {
                        const arCode = parseInt(row[0]);
                        const description = row[1] ? row[1].trim() : '';
                        const hcpcsCode = row[2] ? row[2].trim() : '';
                        const unitCost = parseFloat(row[3]) || 0;

                        if (!arCode || !description) {
                            errors.push('Row ' + (i + 2) + ': Missing AR Code or Description');
                            errorCount++;
                            continue;
                        }

                        await apiCall('/supplies', {
                            method: 'POST',
                            body: { 
                                code: arCode, 
                                description: description, 
                                hcpcs: hcpcsCode || '', 
                                cost: unitCost,
                                is_custom: false  // Make batch imported supplies system supplies
                            }
                        });

                        successItems.push(arCode + ' - ' + description);
                        successCount++;
                    } catch (error) {
                        errors.push('Row ' + (i + 2) + ': ' + error.message);
                        errorCount++;
                    }

                    // Update progress
                    const progress = 40 + ((i + 1) / dataRows.length) * 50;
                    progressFill.style.width = progress + '%';
                }

                progressFill.style.width = '100%';

                // Show results
                let resultsHtml = '<h4>‚úÖ Batch Import Complete</h4>';
                resultsHtml += '<p><strong>Successfully added:</strong> ' + successCount + ' items</p>';
                resultsHtml += '<p><strong>Errors:</strong> ' + errorCount + ' items</p>';
                
                if (successItems.length > 0) {
                    resultsHtml += '<h5 style="color: #38a169; margin-top: 15px;">Successfully Added:</h5><ul>';
                    successItems.slice(0, 10).forEach(function(item) {
                        resultsHtml += '<li style="color: #38a169; font-size: 12px;">' + item + '</li>';
                    });
                    if (successItems.length > 10) {
                        resultsHtml += '<li style="color: #38a169; font-size: 12px;"><em>... and ' + (successItems.length - 10) + ' more</em></li>';
                    }
                    resultsHtml += '</ul>';
                }

                if (errors.length > 0) {
                    resultsHtml += '<h5 style="color: #e53e3e; margin-top: 15px;">Errors:</h5><ul>';
                    errors.slice(0, 10).forEach(function(error) {
                        resultsHtml += '<li style="color: #e53e3e; font-size: 12px;">' + error + '</li>';
                    });
                    if (errors.length > 10) {
                        resultsHtml += '<li style="color: #e53e3e; font-size: 12px;"><em>... and ' + (errors.length - 10) + ' more errors</em></li>';
                    }
                    resultsHtml += '</ul>';
                }

                resultsDiv.innerHTML = resultsHtml;
                resultsDiv.className = errorCount === 0 ? 'import-results success' : 'import-results mixed';
                resultsDiv.style.display = 'block';

                // Refresh data
                await loadAllData();
                adminRefreshSupplies();
                adminRefreshStats();

                if (errorCount === 0) {
                    showTrackingStatus('‚úÖ ' + successCount + ' supply items imported successfully!');
                    setTimeout(function() {
                        closeBatchSupplyModal();
                    }, 3000);
                } else {
                    showTrackingStatus('‚ö†Ô∏è ' + successCount + ' imported, ' + errorCount + ' failed', true);
                }

            } catch (error) {
                resultsDiv.innerHTML = '<h4>‚ùå Import Failed</h4><p style="color: #e53e3e;">' + error.message + '</p>';
                resultsDiv.className = 'import-results error';
                resultsDiv.style.display = 'block';
                showTrackingStatus('‚ùå Batch import failed: ' + error.message, true);
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = 'Import Supply Items';
                setTimeout(function() {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        async function loadFullAdminPanel() {
            const adminTab = document.getElementById('adminTab');

            adminTab.innerHTML = 
                '<h2 style="margin-bottom: 30px; color: #4a5568;">üîß Admin Panel</h2>' +
                '<div class="admin-section">' +
                '<h3>üë• User Management</h3>' +
                '<div id="pendingUsersSection" style="margin-bottom: 25px;">' +
                '<h4 style="color: #ed8936; margin-bottom: 15px;">‚è≥ Pending Approvals</h4>' +
                '<div id="pendingUsersList">Loading pending users...</div>' +
                '</div>' +
                '<h4>All Users</h4>' +
                '<div class="table-container">' +
                '<table class="admin-table" id="allUsersTable">' +
                '<thead>' +
                '<tr>' +
                '<th>Name</th>' +
                '<th>Email</th>' +
                '<th>Role</th>' +
                '<th>Facility</th>' +
                '<th>Status</th>' +
                '<th>Registered</th>' +
                '<th>Actions</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody id="allUsersTableBody">Loading users...</tbody>' +
                '</table>' +
                '</div>' +
                '</div>' +
                '<div class="admin-section">' +
                '<h3>üè¢ Facility Management</h3>' +
                '<div class="add-new-section">' +
                '<h4>Add New Facility</h4>' +
                '<div class="admin-form">' +
                '<div class="form-group">' +
                '<label for="adminFacilityName">Facility Name</label>' +
                '<input type="text" id="adminFacilityName" placeholder="Enter facility name" autocomplete="off">' +
                '</div>' +
                '<div class="form-group">' +
                '<label>&nbsp;</label>' +
                '<button class="btn btn-primary" type="button" onclick="adminAddFacility()" id="addFacilityBtn">Add Facility</button>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<h4>Existing Facilities</h4>' +
                '<div class="admin-cards" id="adminFacilityCards">Loading facilities...</div>' +
                '</div>' +
                '<div class="admin-section">' +
                '<h3>üì¶ Supply Management</h3>' +
                '<div class="add-new-section">' +
                '<h4>Add New Supply Item</h4>' +
                '<div class="admin-form">' +
                '<div class="form-group">' +
                '<label for="adminNewArCode">AR Code</label>' +
                '<input type="number" id="adminNewArCode" placeholder="e.g., 700" min="1" autocomplete="off">' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="adminNewDescription">Item Description</label>' +
                '<input type="text" id="adminNewDescription" placeholder="Enter description" autocomplete="off">' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="adminNewHcpcsCode">HCPCS Code</label>' +
                '<input type="text" id="adminNewHcpcsCode" placeholder="e.g., A6251" autocomplete="off">' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="adminNewUnitCost">Unit Cost ($)</label>' +
                '<input type="number" id="adminNewUnitCost" placeholder="0.00" min="0" step="0.01" autocomplete="off">' +
                '</div>' +
                '</div>' +
                '<div style="display: flex; gap: 15px; flex-wrap: wrap;">' +
                '<button class="btn btn-success" type="button" onclick="adminAddSupply()" id="addSupplyBtn">Add New Supply Item</button>' +
                '<button class="btn btn-primary" type="button" onclick="showBatchSupplyModal()" id="batchSupplyBtn">üì§ Add Batch Supply Items</button>' +
                '</div>' +
                '</div>' +
                '<h4>Edit Existing Supply Costs</h4>' +
                '<div id="supplyControls" class="hidden" style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">' +
                '<div>' +
                '<label style="display: flex; align-items: center; gap: 10px; font-weight: 600; color: #4a5568;">' +
                '<input type="checkbox" id="selectAllSupplies" onchange="toggleSelectAllSupplies()" style="transform: scale(1.2);">' +
                'Select All Supply Items' +
                '</label>' +
                '<p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">' +
                '<span id="selectedSupplyCount">0</span> supply item(s) selected' +
                '</p>' +
                '</div>' +
                '<div>' +
                '<button class="btn btn-danger" onclick="deleteSelectedSupplies()" id="deleteSelectedSuppliesBtn" disabled>' +
                'üóëÔ∏è Delete Selected Supply Items' +
                '</button>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<input type="text" id="adminSupplySearch" placeholder="Search supplies..." class="search-box" onkeyup="adminFilterSupplies(this.value)" autocomplete="off">' +
                '<div class="table-container">' +
                '<table class="admin-table" id="adminSupplyTable">' +
                '<thead>' +
                '<tr>' +
                '<th style="width: 50px;">Select</th>' +
                '<th style="width: 100px;">AR Code</th>' +
                '<th style="min-width: 300px;">Item Description</th>' +
                '<th style="width: 120px;">HCPCS Code</th>' +
                '<th style="width: 100px;">Unit Cost</th>' +
                '<th style="width: 100px;">Actions</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody id="adminSupplyTableBody">' +
                '</tbody>' +
                '</table>' +
                '</div>' +
                '</div>' +
                '<div class="admin-section">' +
                '<h3>üìä System Overview</h3>' +
                '<div class="admin-cards" id="adminStatsCards">Loading statistics...</div>' +
                '</div>';

            setTimeout(function() {
                adminRefreshUsers();
                adminRefreshFacilities();
                adminRefreshSupplies();
                adminRefreshStats();
            }, 50);
        }

        async function adminRefreshUsers() {
            try {
                const pendingUsers = await apiCall('/users/pending');
                const pendingContainer = document.getElementById('pendingUsersList');

                if (pendingUsers.length === 0) {
                    pendingContainer.innerHTML = '<p style="color: #718096; font-style: italic;">No pending user approvals</p>';
                } else {
                    let html = '<div class="admin-cards">';
                    pendingUsers.forEach(function(user) {
                        html += 
                            '<div class="admin-card" style="border-left: 4px solid #ed8936;">' +
                            '<h4>üë§ ' + user.name + '</h4>' +
                            '<p><strong>Email:</strong> ' + user.email + '</p>' +
                            '<p><strong>Facility:</strong> ' + (user.facility_name || 'None selected') + '</p>' +
                            '<p><strong>Registered:</strong> ' + new Date(user.created_at).toLocaleDateString() + '</p>' +
                            '<div class="card-actions">' +
                            '<button class="btn btn-success btn-sm" onclick="approveUser(' + user.id + ')">‚úÖ Approve</button>' +
                            '<button class="btn btn-danger btn-sm" onclick="rejectUser(' + user.id + ')">‚ùå Reject</button>' +
                            '</div>' +
                            '</div>';
                    });
                    html += '</div>';
                    pendingContainer.innerHTML = html;
                }

                const allUsers = await apiCall('/users');
                const tbody = document.getElementById('allUsersTableBody');
                tbody.innerHTML = '';

                allUsers.forEach(function(user) {
                    const statusBadge = user.is_approved ? 
                        '<span style="background: #38a169; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">Approved</span>' :
                        '<span class="pending-badge">Pending</span>';

                    const row = document.createElement('tr');
                    
                    let facilitySelect = user.facility_name || 'None';
                    if (user.is_approved) {
                        facilitySelect = '<select onchange="updateUserFacility(' + user.id + ', this.value)" style="padding: 4px; border-radius: 4px; border: 1px solid #e2e8f0;">';
                        facilitySelect += '<option value="">No Facility</option>';
                        appData.facilities.forEach(function(f) {
                            const selected = f.id === user.facility_id ? 'selected' : '';
                            facilitySelect += '<option value="' + f.id + '" ' + selected + '>' + f.name + '</option>';
                        });
                        facilitySelect += '</select>';
                    }

                    let actions = '';
                    if (!user.is_approved) {
                        actions += '<button class="btn btn-success btn-sm" onclick="approveUser(' + user.id + ')">Approve</button>';
                    }
                    if (user.email !== 'admin@system.com') {
                        actions += '<button class="btn btn-danger btn-sm" onclick="adminDeleteUser(' + user.id + ')" style="margin-left: 5px;">Delete</button>';
                    }

                    row.innerHTML = 
                        '<td>' + user.name + '</td>' +
                        '<td>' + user.email + '</td>' +
                        '<td><span style="background: ' + (user.role === 'admin' ? '#667eea' : '#718096') + '; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">' + user.role.toUpperCase() + '</span></td>' +
                        '<td>' + facilitySelect + '</td>' +
                        '<td>' + statusBadge + '</td>' +
                        '<td>' + new Date(user.created_at).toLocaleDateString() + '</td>' +
                        '<td>' + actions + '</td>';
                    tbody.appendChild(row);
                });

                await updatePendingUsersNotification();

            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('pendingUsersList').innerHTML = '<p style="color: #e53e3e;">Failed to load users</p>';
            }
        }

        async function approveUser(userId) {
            try {
                await apiCall('/users/' + userId + '/approve', { method: 'POST' });
                showTrackingStatus('‚úÖ User approved successfully!');
                adminRefreshUsers();
            } catch (error) {
                alert('Failed to approve user: ' + error.message);
            }
        }

        async function rejectUser(userId) {
            if (confirm('Are you sure you want to reject this user registration? This will permanently delete their account.')) {
                try {
                    await apiCall('/users/' + userId, { method: 'DELETE' });
                    showTrackingStatus('‚úÖ User registration rejected');
                    adminRefreshUsers();
                } catch (error) {
                    alert('Failed to reject user: ' + error.message);
                }
            }
        }

        async function updateUserFacility(userId, facilityId) {
            try {
                await apiCall('/users/' + userId + '/facility', {
                    method: 'PUT',
                    body: { facilityId: facilityId || null }
                });
                showTrackingStatus('‚úÖ User facility updated successfully!');
                adminRefreshUsers();
            } catch (error) {
                alert('Failed to update user facility: ' + error.message);
                adminRefreshUsers();
            }
        }

        async function adminDeleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    await apiCall('/users/' + userId, { method: 'DELETE' });
                    showTrackingStatus('‚úÖ User deleted successfully');
                    adminRefreshUsers();
                } catch (error) {
                    alert('Failed to delete user: ' + error.message);
                }
            }
        }

        async function adminAddFacility() {
            const name = document.getElementById('adminFacilityName').value.trim();
            const addBtn = document.getElementById('addFacilityBtn');

            if (!name) {
                alert('Please enter a facility name');
                return;
            }

            try {
                addBtn.disabled = true;
                addBtn.innerHTML = '<span class="loading"></span>Adding...';

                await apiCall('/facilities', {
                    method: 'POST',
                    body: { name: name }
                });

                document.getElementById('adminFacilityName').value = '';
                await loadAllData();
                adminRefreshFacilities();
                adminRefreshStats();

                showTrackingStatus('‚úÖ Facility added successfully!');
            } catch (error) {
                alert(error.message);
            } finally {
                addBtn.disabled = false;
                addBtn.innerHTML = 'Add Facility';
            }
        }

        function adminRefreshFacilities() {
            const container = document.getElementById('adminFacilityCards');
            if (!container) return;

            if (appData.facilities.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No facilities created yet. Add your first facility above.</p></div>';
                return;
            }

            container.innerHTML = '';
            appData.facilities.forEach(function(facility) {
                const patientsInFacility = appData.patients.filter(function(p) { return p.facility_id === facility.id; }).length;

                const card = document.createElement('div');
                card.className = 'admin-card';
                card.innerHTML = 
                    '<h4>üè¢ ' + facility.name + '</h4>' +
                    '<p><strong>Facility ID:</strong> ' + facility.id + '</p>' +
                    '<p><strong>Created:</strong> ' + new Date(facility.created_at).toLocaleDateString() + '</p>' +
                    '<p><strong>Patients:</strong> ' + patientsInFacility + ' active</p>' +
                    '<div class="card-actions">' +
                    '<button class="btn btn-danger btn-sm" onclick="adminRemoveFacility(' + facility.id + ')">Remove Facility</button>' +
                    '</div>';
                container.appendChild(card);
            });
        }

        async function adminRemoveFacility(facilityId) {
            const patientsInFacility = appData.patients.filter(function(p) { return p.facility_id === facilityId; });

            if (patientsInFacility.length > 0) {
                alert('Cannot remove facility. There are ' + patientsInFacility.length + ' patients assigned to this facility. Please remove or reassign patients first.');
                return;
            }

            if (confirm('Are you sure you want to remove this facility?')) {
                try {
                    await apiCall('/facilities/' + facilityId, { method: 'DELETE' });
                    await loadAllData();
                    adminRefreshFacilities();
                    adminRefreshStats();
                    showTrackingStatus('‚úÖ Facility removed successfully!');
                } catch (error) {
                    alert('Failed to remove facility: ' + error.message);
                }
            }
        }

        async function adminAddSupply() {
            const arCode = parseInt(document.getElementById('adminNewArCode').value);
            const description = document.getElementById('adminNewDescription').value.trim();
            const hcpcsCode = document.getElementById('adminNewHcpcsCode').value.trim();
            const unitCost = parseFloat(document.getElementById('adminNewUnitCost').value) || 0;
            const addBtn = document.getElementById('addSupplyBtn');

            if (!arCode || !description) {
                alert('Please fill in AR Code and Item Description (required fields)');
                return;
            }

            if (arCode < 1) {
                alert('AR Code must be a positive number');
                return;
            }

            try {
                addBtn.disabled = true;
                addBtn.innerHTML = '<span class="loading"></span>Adding...';

                await apiCall('/supplies', {
                    method: 'POST',
                    body: { 
                        code: arCode, 
                        description: description, 
                        hcpcs: hcpcsCode, 
                        cost: unitCost,
                        is_custom: false  // Make new supplies system supplies
                    }
                });

                document.getElementById('adminNewArCode').value = '';
                document.getElementById('adminNewDescription').value = '';
                document.getElementById('adminNewHcpcsCode').value = '';
                document.getElementById('adminNewUnitCost').value = '';

                await loadAllData();
                adminRefreshSupplies();
                adminRefreshStats();

                showTrackingStatus('‚úÖ Supply item added successfully!');
            } catch (error) {
                alert(error.message);
            } finally {
                addBtn.disabled = false;
                addBtn.innerHTML = 'Add New Supply Item';
            }
        }

        function adminRefreshSupplies() {
            const tbody = document.getElementById('adminSupplyTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            
            const controlsSection = document.getElementById('supplyControls');

            if (!appData.supplies || appData.supplies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #718096; padding: 40px;">No supplies in system. Add your first supply above or use batch import.</td></tr>';
                if (controlsSection) controlsSection.classList.add('hidden');
                return;
            }

            // Show controls section
            if (controlsSection) controlsSection.classList.remove('hidden');

            appData.supplies.forEach(function(supply) {
                const row = document.createElement('tr');
                if (supply.is_custom) {
                    row.classList.add('custom-supply');
                }
                
                row.innerHTML = 
                    '<td style="text-align: center;">' +
                    '<input type="checkbox" class="supply-checkbox" value="' + supply.id + '" ' +
                    'onchange="updateSelectedSupplyCount()" style="transform: scale(1.2);">' +
                    '</td>' +
                    '<td>' +
                    '<strong>' + supply.code + '</strong>' +
                    (supply.is_custom ? '<span class="custom-badge">CUSTOM</span>' : '') +
                    '</td>' +
                    '<td>' + supply.description + '</td>' +
                    '<td>' +
                    '<input type="text" value="' + (supply.hcpcs || '') + '" ' +
                    'style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;" ' +
                    'onchange="adminUpdateSupply(' + supply.id + ', \'hcpcs\', this.value)">' +
                    '</td>' +
                    '<td>' +
                    '<input type="number" value="' + (supply.cost || 0) + '" step="0.01" min="0" ' +
                    'style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;" ' +
                    'onchange="adminUpdateSupply(' + supply.id + ', \'cost\', this.value)">' +
                    '</td>' +
                    '<td style="text-align: center;">' +
                    '<button class="btn btn-danger btn-sm" onclick="adminDeleteSupply(' + supply.id + ')" title="Delete Supply Item">' +
                    'üóëÔ∏è' +
                    '</button>' +
                    '</td>';
                tbody.appendChild(row);
            });
            
            updateSelectedSupplyCount();
        }

        function toggleSelectAllSupplies() {
            const selectAllCheckbox = document.getElementById('selectAllSupplies');
            const supplyCheckboxes = document.querySelectorAll('.supply-checkbox');
            
            supplyCheckboxes.forEach(function(checkbox) {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedSupplyCount();
        }

        function updateSelectedSupplyCount() {
            const selectedCheckboxes = document.querySelectorAll('.supply-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAllSupplies');
            const selectedCountSpan = document.getElementById('selectedSupplyCount');
            const deleteSelectedBtn = document.getElementById('deleteSelectedSuppliesBtn');
            const totalCheckboxes = document.querySelectorAll('.supply-checkbox');
            
            if (selectedCountSpan) selectedCountSpan.textContent = selectedCheckboxes.length;
            if (deleteSelectedBtn) deleteSelectedBtn.disabled = selectedCheckboxes.length === 0;
            
            if (selectAllCheckbox) {
                if (selectedCheckboxes.length === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (selectedCheckboxes.length === totalCheckboxes.length) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                    selectAllCheckbox.checked = false;
                }
            }
        }

        async function deleteSelectedSupplies() {
            const selectedCheckboxes = document.querySelectorAll('.supply-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(function(cb) { return parseInt(cb.value); });
            
            if (selectedIds.length === 0) {
                alert('No supply items selected');
                return;
            }
            
            const selectedSupplies = appData.supplies.filter(function(s) { return selectedIds.includes(s.id); });
            const customCount = selectedSupplies.filter(function(s) { return s.is_custom; }).length;
            const systemCount = selectedSupplies.filter(function(s) { return !s.is_custom; }).length;
            
            let confirmMessage = 'Are you sure you want to PERMANENTLY DELETE ' + selectedIds.length + ' selected supply item(s)?\n\n';
            if (customCount > 0) confirmMessage += '‚Ä¢ ' + customCount + ' custom supply item(s)\n';
            if (systemCount > 0) confirmMessage += '‚Ä¢ ' + systemCount + ' system supply item(s)\n';
            confirmMessage += '\n‚ö†Ô∏è This action cannot be undone and will affect all existing tracking data for these items.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const deleteBtn = document.getElementById('deleteSelectedSuppliesBtn');
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<span class="loading"></span>Deleting...';
                
                let deletedCount = 0;
                let failedCount = 0;
                const errors = [];
                
                for (let i = 0; i < selectedIds.length; i++) {
                    const supplyId = selectedIds[i];
                    try {
                        await apiCall('/supplies/' + supplyId, {
                            method: 'DELETE'
                        });
                        deletedCount++;
                    } catch (error) {
                        console.error('Failed to delete supply ' + supplyId + ':', error);
                        const supply = appData.supplies.find(function(s) { return s.id === supplyId; });
                        errors.push((supply ? supply.description : 'ID ' + supplyId) + ': ' + error.message);
                        failedCount++;
                    }
                }
                
                await loadAllData();
                adminRefreshSupplies();
                adminRefreshStats();
                
                if (failedCount === 0) {
                    showTrackingStatus('‚úÖ ' + deletedCount + ' supply item(s) deleted successfully!');
                } else {
                    showTrackingStatus('‚ö†Ô∏è ' + deletedCount + ' deleted, ' + failedCount + ' failed', true);
                    if (errors.length > 0) {
                        console.error('Delete errors:', errors);
                        alert('Some items could not be deleted:\n' + errors.slice(0, 3).join('\n') + (errors.length > 3 ? '\n... and more' : ''));
                    }
                }
                
            } catch (error) {
                console.error('Bulk delete error:', error);
                showTrackingStatus('‚ùå Failed to delete supply items: ' + error.message, true);
            } finally {
                const deleteBtn = document.getElementById('deleteSelectedSuppliesBtn');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = 'üóëÔ∏è Delete Selected Supply Items';
            }
        }

        function adminFilterSupplies(searchTerm) {
            const rows = document.querySelectorAll('#adminSupplyTableBody tr');
            const term = searchTerm.toLowerCase().trim();
            let visibleCount = 0;

            rows.forEach(function(row) {
                const cells = row.querySelectorAll('td');
                if (cells.length === 1) return; // Skip empty state row
                
                // Check AR Code (2nd column, index 1) and Description (3rd column, index 2)
                const code = cells[1] ? cells[1].textContent.toLowerCase() : '';
                const description = cells[2] ? cells[2].textContent.toLowerCase() : '';
                const shouldShow = !term || code.includes(term) || description.includes(term);
                
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Update selection counts after filtering
            updateSelectedSupplyCount();
        }

        async function adminUpdateSupply(supplyId, field, value) {
            try {
                const updateData = {};
                updateData[field] = field === 'cost' ? parseFloat(value) || 0 : value;

                await apiCall('/supplies/' + supplyId, {
                    method: 'PUT',
                    body: updateData
                });

                // Update local data
                const supply = appData.supplies.find(function(s) { return s.id === supplyId; });
                if (supply) {
                    supply[field] = updateData[field];
                }

                showTrackingStatus('‚úÖ Supply updated successfully');
            } catch (error) {
                alert('Failed to update supply: ' + error.message);
                adminRefreshSupplies(); // Reload to reset values
            }
        }

        async function adminDeleteSupply(supplyId) {
            // Find the supply
            const supply = appData.supplies.find(function(s) { return s.id === supplyId; });
            if (!supply) {
                alert('Supply not found');
                return;
            }

            const itemType = supply.is_custom ? 'custom' : 'system';
            const confirmMessage = 'Are you sure you want to PERMANENTLY DELETE this ' + itemType + ' supply item?\n\n' +
                                 'Item: ' + supply.description + ' (AR Code: ' + supply.code + ')\n\n' +
                                 '‚ö†Ô∏è This action cannot be undone and will affect all existing tracking data for this item.';

            if (confirm(confirmMessage)) {
                try {
                    await apiCall('/supplies/' + supplyId, { method: 'DELETE' });
                    await loadAllData();
                    adminRefreshSupplies();
                    adminRefreshStats();
                    showTrackingStatus('‚úÖ Supply item "' + supply.description + '" deleted successfully');
                } catch (error) {
                    console.error('Delete supply error:', error);
                    
                    // Provide helpful error messages
                    if (error.message.includes('Custom supply not found') || error.message.includes('not found')) {
                        alert('This ' + itemType + ' supply item could not be deleted. It may have already been removed or there may be existing tracking data preventing deletion.');
                    } else if (error.message.includes('Cannot delete') || error.message.includes('has tracking data')) {
                        alert('This supply item cannot be deleted because it has existing tracking data. You may need to remove all tracking entries first, or contact your system administrator.');
                    } else {
                        alert('Failed to delete supply item: ' + error.message);
                    }
                }
            }
        }

        async function adminRefreshStats() {
            const container = document.getElementById('adminStatsCards');
            if (!container) return;

            try {
                const stats = await apiCall('/statistics');
                
                container.innerHTML = 
                    '<div class="stats-card">' +
                    '<h4>üë• Total Users</h4>' +
                    '<div class="value">' + stats.totalUsers + '</div>' +
                    '<p>' + stats.pendingUsers + ' pending approval</p>' +
                    '</div>' +
                    '<div class="stats-card">' +
                    '<h4>üè¢ Facilities</h4>' +
                    '<div class="value">' + stats.totalFacilities + '</div>' +
                    '<p>Active facilities</p>' +
                    '</div>' +
                    '<div class="stats-card">' +
                    '<h4>üë§ Patients</h4>' +
                    '<div class="value">' + stats.totalPatients + '</div>' +
                    '<p>Tracking sheets created</p>' +
                    '</div>' +
                    '<div class="stats-card">' +
                    '<h4>üì¶ Supply Items</h4>' +
                    '<div class="value">' + stats.totalSupplies + '</div>' +
                    '<p>' + stats.customSupplies + ' custom items</p>' +
                    '</div>';
            } catch (error) {
                console.error('Failed to load statistics:', error);
                container.innerHTML = '<div class="empty-state"><p>Failed to load statistics</p></div>';
            }
        }

        // DEBUGGING FUNCTIONS FOR WOUND DX ISSUES
        // Function to audit wound dx data for a specific patient
        async function debugWoundDxForPatient(patientId) {
            try {
                const patient = appData.patients.find(p => p.id == patientId);
                console.log('üîç DEBUGGING WOUND DX FOR PATIENT:', patient ? patient.name : 'ID ' + patientId);
                
                // Get tracking data
                const trackingData = await apiCall('/patients/' + patientId + '/tracking');
                console.log('üìä Tracking data entries:', trackingData.length);
                
                // Get wound dx data
                const woundDxResponse = await apiCall('/patients/' + patientId + '/wound-dx');
                console.log('üíä Wound Dx API response:', woundDxResponse);
                
                if (woundDxResponse && Array.isArray(woundDxResponse)) {
                    console.log('üìù Wound Dx entries found:', woundDxResponse.length);
                    
                    woundDxResponse.forEach(function(item, index) {
                        console.log(`Entry ${index + 1}:`, {
                            supply_id: item.supply_id,
                            supply_id_type: typeof item.supply_id,
                            wound_dx: item.wound_dx,
                            wound_dx_length: item.wound_dx ? item.wound_dx.length : 0
                        });
                        
                        // Find corresponding supply
                        const supply = appData.supplies.find(s => s.id == item.supply_id);
                        if (supply) {
                            console.log(`  ‚Üí Supply: ${supply.code} - ${supply.description}`);
                        } else {
                            console.log(`  ‚Üí ‚ö†Ô∏è Supply not found for ID: ${item.supply_id}`);
                        }
                    });
                }
                
                // Check for mismatches
                const trackingSupplyIds = [...new Set(trackingData.map(t => String(t.supply_id || t.id)))];
                const woundDxSupplyIds = woundDxResponse ? woundDxResponse.map(w => String(w.supply_id)) : [];
                
                console.log('üîÑ Tracking supply IDs:', trackingSupplyIds);
                console.log('üíä Wound Dx supply IDs:', woundDxSupplyIds);
                
                const onlyInTracking = trackingSupplyIds.filter(id => !woundDxSupplyIds.includes(id));
                const onlyInWoundDx = woundDxSupplyIds.filter(id => !trackingSupplyIds.includes(id));
                
                if (onlyInTracking.length > 0) {
                    console.log('‚ö†Ô∏è Supplies with tracking but no wound dx:', onlyInTracking);
                }
                if (onlyInWoundDx.length > 0) {
                    console.log('‚ö†Ô∏è Supplies with wound dx but no tracking:', onlyInWoundDx);
                }
                
            } catch (error) {
                console.error('‚ùå Debug failed:', error);
            }
        }

        // Function to audit all wound dx data in the system
        async function auditAllWoundDxData() {
            console.log('üîç AUDITING ALL WOUND DX DATA IN SYSTEM');
            
            let totalPatients = 0;
            let patientsWithWoundDx = 0;
            let totalWoundDxEntries = 0;
            const issues = [];
            
            for (const patient of appData.patients) {
                totalPatients++;
                try {
                    const woundDxResponse = await apiCall('/patients/' + patient.id + '/wound-dx');
                    if (woundDxResponse && Array.isArray(woundDxResponse) && woundDxResponse.length > 0) {
                        patientsWithWoundDx++;
                        totalWoundDxEntries += woundDxResponse.length;
                        
                        // Check for empty wound dx entries
                        const emptyEntries = woundDxResponse.filter(item => !item.wound_dx || !item.wound_dx.trim());
                        if (emptyEntries.length > 0) {
                            issues.push(`Patient ${patient.name}: ${emptyEntries.length} empty wound dx entries`);
                        }
                        
                        // Check for missing supply references
                        const invalidSupplies = woundDxResponse.filter(item => {
                            const supply = appData.supplies.find(s => s.id == item.supply_id);
                            return !supply;
                        });
                        if (invalidSupplies.length > 0) {
                            issues.push(`Patient ${patient.name}: ${invalidSupplies.length} wound dx entries reference missing supplies`);
                        }
                    }
                } catch (error) {
                    issues.push(`Patient ${patient.name}: Failed to load wound dx data - ${error.message}`);
                }
            }
            
            console.log('üìä AUDIT RESULTS:');
            console.log(`Total Patients: ${totalPatients}`);
            console.log(`Patients with Wound Dx: ${patientsWithWoundDx}`);
            console.log(`Total Wound Dx Entries: ${totalWoundDxEntries}`);
            console.log(`Issues Found: ${issues.length}`);
            
            if (issues.length > 0) {
                console.log('‚ö†Ô∏è ISSUES:');
                issues.forEach(issue => console.log(`  - ${issue}`));
            }
            
            // Show user-friendly alert
            alert(`Wound Dx Audit Complete!\n\nTotal Patients: ${totalPatients}\nPatients with Wound Dx: ${patientsWithWoundDx}\nTotal Wound Dx Entries: ${totalWoundDxEntries}\nIssues Found: ${issues.length}\n\nCheck console for detailed results.`);
            
            return {
                totalPatients,
                patientsWithWoundDx,
                totalWoundDxEntries,
                issues
            };
        }

        // Test the report generation logic for a single patient
        async function testReportLogicForPatient(patientId) {
            console.log('üß™ TESTING REPORT LOGIC FOR PATIENT:', patientId);
            
            try {
                const patient = appData.patients.find(p => p.id == patientId);
                const trackingData = await apiCall('/patients/' + patientId + '/tracking');
                
                // Load wound dx data exactly like the report does
                let woundDxData = {};
                try {
                    const woundDxResponse = await apiCall('/patients/' + patientId + '/wound-dx');
                    if (woundDxResponse && Array.isArray(woundDxResponse)) {
                        woundDxResponse.forEach(function(item) {
                            if (item && typeof item.supply_id !== 'undefined' && typeof item.wound_dx !== 'undefined') {
                                const supplyIdKey = String(item.supply_id);
                                woundDxData[supplyIdKey] = item.wound_dx || '';
                            }
                        });
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Error loading wound dx:', error);
                }
                
                console.log('üíä Processed wound dx data:', woundDxData);
                
                // Group tracking data by supply (like the report does)
                const supplyTotals = {};
                trackingData.forEach(function(item) {
                    const key = item.code;
                    if (!supplyTotals[key]) {
                        supplyTotals[key] = {
                            supply: item,
                            totalUnits: 0
                        };
                    }
                    supplyTotals[key].totalUnits += parseInt(item.quantity) || 0;
                });
                
                console.log('üìä Supply totals:', Object.keys(supplyTotals).length, 'supplies');
                
                // Test the new comprehensive approach
                const allRelevantSupplies = new Map();
                
                // Add supplies from tracking data
                Object.values(supplyTotals).forEach(function(supplyTotal) {
                    const supply = supplyTotal.supply;
                    const supplyIdKey = String(supply.id);
                    allRelevantSupplies.set(supplyIdKey, {
                        supply: supply,
                        totalUnits: supplyTotal.totalUnits,
                        hasWoundDx: woundDxData.hasOwnProperty(supplyIdKey),
                        woundDx: woundDxData[supplyIdKey] || ''
                    });
                });
                
                // Add supplies with wound dx but no tracking
                Object.keys(woundDxData).forEach(function(supplyIdKey) {
                    if (!allRelevantSupplies.has(supplyIdKey) && woundDxData[supplyIdKey].trim()) {
                        const supply = appData.supplies.find(function(s) { 
                            return String(s.id) === supplyIdKey; 
                        });
                        if (supply) {
                            allRelevantSupplies.set(supplyIdKey, {
                                supply: supply,
                                totalUnits: 0,
                                hasWoundDx: true,
                                woundDx: woundDxData[supplyIdKey]
                            });
                        }
                    }
                });
                
                console.log('üéØ All relevant supplies for report:', allRelevantSupplies.size);
                
                let reportEntries = 0;
                allRelevantSupplies.forEach(function(supplyInfo, supplyId) {
                    const totalUnits = supplyInfo.totalUnits;
                    const woundDx = supplyInfo.woundDx;
                    
                    if (totalUnits > 0 || (woundDx && woundDx.trim())) {
                        reportEntries++;
                        console.log(`  Entry ${reportEntries}: ${supplyInfo.supply.description} - Units: ${totalUnits}, Wound Dx: "${woundDx}"`);
                    }
                });
                
                console.log(`‚úÖ Would generate ${reportEntries} report entries for this patient`);
                alert(`Test Results for Patient:\n\nPatient: ${patient ? patient.name : 'Unknown'}\nSupplies in tracking: ${Object.keys(supplyTotals).length}\nWound dx entries: ${Object.keys(woundDxData).length}\nTotal relevant supplies: ${allRelevantSupplies.size}\nReport entries: ${reportEntries}\n\nCheck console for detailed results.`);
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                alert('Test failed: ' + error.message);
            }
        }

        // Check for existing auth token on page load
        window.addEventListener('DOMContentLoaded', async function() {
            if (authToken) {
                try {
                    console.log('üîç Checking stored auth token...');
                    
                    const response = await apiCall('/auth/verify');
                    currentUser = response.user;
                    
                    console.log('‚úÖ Token valid, auto-logging in user:', currentUser.email);
                    
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    await initApp();
                } catch (error) {
                    console.log('‚ùå Stored token invalid, showing login');
                    localStorage.removeItem('authToken');
                    authToken = null;
                    currentUser = null;
                }
            } else {
                console.log('üîì No stored token, showing login screen');
            }
        });

        // Handle Enter key for login
        document.addEventListener('DOMContentLoaded', function() {
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginEmail && loginPassword) {
                [loginEmail, loginPassword].forEach(function(input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            login();
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
