<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wound Care RT Supply Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        
        /* Authentication Styles */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .login-card h1 { color: #667eea; margin-bottom: 10px; font-size: 24px; }
        .login-card p { color: #666; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; transform: none; }
        .error-message { color: #e53e3e; margin-top: 10px; font-size: 14px; display: none; }
        .toggle-auth { margin-top: 20px; color: #667eea; cursor: pointer; text-decoration: underline; }
        .toggle-auth:hover { color: #4c51bf; }
        
        /* Main Application Styles */
        .app-container { display: none; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 0 20px; position: sticky; top: 0; z-index: 1000; }
        .nav { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; height: 70px; }
        .logo { font-size: 18px; font-weight: bold; color: #667eea; }
        .nav-links { display: flex; list-style: none; gap: 30px; margin: 0; }
        .nav-links li { cursor: pointer; padding: 10px 15px; border-radius: 8px; transition: all 0.3s; color: #4a5568; font-weight: 500; }
        .nav-links li:hover, .nav-links li.active { background: #667eea; color: white; transform: translateY(-2px); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; color: #4a5568; }
        .logout-btn { background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .logout-btn:hover { background: #c53030; }
        
        /* Content Styles */
        .main-content { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        .section { display: none; }
        .section.active { display: block; }
        .section-header { margin-bottom: 30px; }
        .section-title { font-size: 28px; color: white; margin-bottom: 8px; font-weight: 700; }
        .section-subtitle { color: rgba(255, 255, 255, 0.8); font-size: 16px; }
        
        /* Dashboard Styles */
        .dashboard-filters { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin-bottom: 30px; }
        .filters-row { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { color: white; font-weight: 600; font-size: 14px; }
        .filter-group select, .filter-group input { padding: 10px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; backdrop-filter: blur(10px); }
        .filter-group select option { background: #4a5568; color: white; }
        
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dashboard-card { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 25px; text-align: center; transition: transform 0.3s, box-shadow 0.3s; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); }
        .card-icon { font-size: 32px; margin-bottom: 10px; }
        .card-title { color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 600; margin-bottom: 5px; }
        .card-value { color: white; font-size: 24px; font-weight: 700; }
        
        .loading { text-align: center; padding: 40px; color: #667eea; }
        .no-data { text-align: center; padding: 40px; color: #a0aec0; font-size: 16px; }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="authContainer" class="login-container">
        <div class="login-card">
            <h1>Wound Care RT Supply Tracker</h1>
            <p>Comprehensive wound care supply management system</p>
            
            <!-- Login Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn">Sign In</button>
                <div id="loginError" class="error-message"></div>
            </form>
            
            <div class="toggle-auth">
                <span id="toggleAuthText">Need an account? Register here</span>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <!-- Header -->
        <header class="header">
            <nav class="nav">
                <div class="logo">üè• Wound Care RT Supply Tracker</div>
                <ul class="nav-links">
                    <li data-section="dashboard" class="active">Dashboard</li>
                    <li data-section="patients">Patients</li>
                    <li data-section="supplies">Supplies</li>
                    <li data-section="tracking">Supply Tracking</li>
                </ul>
                <div class="user-info">
                    <span class="user-name" id="currentUserName"></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="section-header">
                    <h1 class="section-title">Dashboard</h1>
                    <p class="section-subtitle">Overview of wound care supply tracking and patient management</p>
                </div>

                <!-- Dashboard Cards -->
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="card-icon">üë•</div>
                        <div class="card-title">Total Patients</div>
                        <div class="card-value" id="totalPatients">0</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon">üì¶</div>
                        <div class="card-title">Supply Items</div>
                        <div class="card-value" id="totalSupplies">0</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon">üìä</div>
                        <div class="card-title">Total Usage</div>
                        <div class="card-value" id="totalUsage">0</div>
                    </div>
                </div>
            </section>

            <!-- Patients Section -->
            <section id="patients" class="section">
                <div class="section-header">
                    <h1 class="section-title">Patient Management</h1>
                    <p class="section-subtitle">Add, edit, and manage patient information</p>
                </div>
                <div id="patientsContent" class="loading">Loading patients...</div>
            </section>

            <!-- Supplies Section -->
            <section id="supplies" class="section">
                <div class="section-header">
                    <h1 class="section-title">Supply Management</h1>
                    <p class="section-subtitle">Manage wound care supplies and inventory</p>
                </div>
                <div id="suppliesContent" class="loading">Loading supplies...</div>
            </section>

            <!-- Supply Tracking Section -->
            <section id="tracking" class="section">
                <div class="section-header">
                    <h1 class="section-title">Supply Tracking</h1>
                    <p class="section-subtitle">Track daily supply usage per patient</p>
                </div>
                <div id="trackingContent" class="loading">Loading tracking data...</div>
            </section>
        </main>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let authToken = null;
        let patients = [];
        let supplies = [];
        let facilities = [];
        let trackingData = [];

        console.log('üöÄ Starting Wound Care RT Supply Tracker...');

        // API helper function
        function apiRequest(url, options) {
            const defaultOptions = {
                headers: { 'Content-Type': 'application/json' }
            };

            if (authToken) {
                defaultOptions.headers['Authorization'] = 'Bearer ' + authToken;
            }

            const mergedOptions = Object.assign({}, defaultOptions, options);
            if (options && options.headers) {
                mergedOptions.headers = Object.assign({}, defaultOptions.headers, options.headers);
            }

            return fetch(url, mergedOptions);
        }

        // Authentication Functions
        function initializeAuth() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            loadFacilitiesForAuth();
        }

        async function loadFacilitiesForAuth() {
            try {
                const response = await fetch('/api/facilities');
                const data = await response.json();
                console.log('Facilities loaded for auth:', data);
            } catch (error) {
                console.error('Error loading facilities:', error);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                console.log('Attempting login...');
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, password: password })
                });
                
                const data = await response.json();
                console.log('Login response:', data);
                
                if (data.success) {
                    currentUser = data.user;
                    authToken = data.token;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    sessionStorage.setItem('authToken', authToken);
                    showMainApplication();
                } else {
                    showError('loginError', data.error || 'Invalid credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('loginError', 'Login failed. Please try again.');
            }
        }

        function showMainApplication() {
            console.log('Showing main application for:', currentUser.name);
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.name;
            
            // Initialize navigation
            initializeNavigation();
            
            // Load initial data
            loadAllData();
        }

        function logout() {
            currentUser = null;
            authToken = null;
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('authToken');
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        // Navigation
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-links li');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const section = this.dataset.section;
                    showSection(section);
                });
            });
        }

        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remove active from nav links
            const navLinks = document.querySelectorAll('.nav-links li');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Add active to clicked nav link
            const targetLink = document.querySelector('[data-section="' + sectionId + '"]');
            if (targetLink) {
                targetLink.classList.add('active');
            }
        }

        // Data Loading Functions
        async function loadAllData() {
            try {
                console.log('Loading all data...');
                
                await loadSupplies();
                await loadPatients();
                await loadTracking();
                
                updateDashboard();
                console.log('All data loaded successfully');
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadSupplies() {
            try {
                console.log('üîÑ Loading supplies...');
                const response = await apiRequest('/api/supplies');
                console.log('Supplies API response status:', response.status);
                
                const data = await response.json();
                console.log('Supplies API response data:', data);
                
                if (data.success) {
                    supplies = data.supplies;
                    console.log('‚úÖ Supplies loaded:', supplies.length);
                    displaySupplies();
                } else {
                    console.error('‚ùå Supplies API returned error:', data.error);
                    document.getElementById('suppliesContent').innerHTML = '<div class="no-data">Error loading supplies: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('‚ùå Error loading supplies:', error);
                document.getElementById('suppliesContent').innerHTML = '<div class="no-data">Failed to load supplies - check console for details</div>';
            }
        }

        async function loadPatients() {
            try {
                const response = await apiRequest('/api/patients');
                const data = await response.json();
                if (data.success) {
                    patients = data.patients;
                    console.log('Patients loaded:', patients.length);
                    displayPatients();
                }
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        async function loadTracking() {
            try {
                console.log('üîÑ Loading tracking data...');
                const response = await apiRequest('/api/tracking');
                console.log('Tracking API response status:', response.status);
                
                const data = await response.json();
                console.log('Tracking API response data:', data);
                
                if (data.success) {
                    trackingData = data.tracking;
                    console.log('‚úÖ Tracking data loaded:', trackingData.length);
                    displayTracking();
                } else {
                    console.error('‚ùå Tracking API returned error:', data.error);
                    document.getElementById('trackingContent').innerHTML = '<div class="no-data">Error loading tracking: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('‚ùå Error loading tracking:', error);
                document.getElementById('trackingContent').innerHTML = '<div class="no-data">Failed to load tracking data - check console for details</div>';
            }
        }

        // Display Functions
        function displayPatients() {
            const content = document.getElementById('patientsContent');
            if (patients.length === 0) {
                content.innerHTML = '<div class="no-data">No patients found</div>';
                return;
            }
            
            // Create proper table for patients
            let tableHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #4a5568;">Patient Records (${patients.length} patients)</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Name</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">MRN</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Month</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Facility</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Created</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            // Show first 20 patients (to keep display manageable)
            const displayPatients = patients.slice(0, 20);
            
            displayPatients.forEach((patient, index) => {
                const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const createdDate = patient.created_at ? new Date(patient.created_at).toLocaleDateString() : 'N/A';
                
                tableHTML += `
                    <tr style="background: ${rowColor}; border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${patient.name || 'No name'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${patient.mrn || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${formatMonth(patient.month) || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${patient.facility_name || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${createdDate}</td>
                    </tr>`;
            });
            
            if (patients.length > 20) {
                tableHTML += `
                    <tr>
                        <td colspan="5" style="padding: 10px; text-align: center; font-style: italic; color: #666;">
                            ... and ${patients.length - 20} more patients (showing first 20)
                        </td>
                    </tr>`;
            }
            
            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            content.innerHTML = tableHTML;
        }
        
        // Helper function to format month
        function formatMonth(monthStr) {
            if (!monthStr) return 'N/A';
            try {
                const date = new Date(monthStr + '-01');
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            } catch (error) {
                return monthStr;
            }
        }

        function displaySupplies() {
            const content = document.getElementById('suppliesContent');
            if (supplies.length === 0) {
                content.innerHTML = '<div class="no-data">No supplies found</div>';
                return;
            }
            
            // Create proper table for supplies
            let tableHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #4a5568;">Supply Catalog (${supplies.length} items)</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">AR Code</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Description</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">HCPCS Code</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Cost</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            supplies.forEach((supply, index) => {
                // Handle different possible column names from your database
                const arCode = supply.ar_code || supply.code || supply.id || 'N/A';
                const description = supply.description || 'No description';
                const hcpcs = supply.hcpcs || supply.hcpcs_code || 'N/A';
                const cost = supply.cost || supply.amount || '0.00';
                
                const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                tableHTML += `
                    <tr style="background: ${rowColor}; border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${arCode}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${description}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${hcpcs}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${parseFloat(cost || 0).toFixed(2)}</td>
                    </tr>`;
            });
            
            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            content.innerHTML = tableHTML;
        }

        function displayTracking() {
            const content = document.getElementById('trackingContent');
            if (patients.length === 0 || supplies.length === 0) {
                content.innerHTML = '<div class="no-data">No tracking data available - need patients and supplies loaded first</div>';
                return;
            }
            
            // Create enhanced tracking display
            let html = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #4a5568;">Supply Tracking Overview</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${patients.length}</div>
                            <div style="color: #666;">Total Patients</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${supplies.length}</div>
                            <div style="color: #666;">Available Supplies</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${trackingData.length}</div>
                            <div style="color: #666;">Tracking Records</div>
                        </div>
                    </div>`;
            
            if (trackingData.length > 0) {
                html += `
                    <h4 style="margin: 20px 0 10px 0; color: #4a5568;">Recent Tracking Activity</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Patient ID</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Supply ID</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Day</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Quantity</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Month</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                // Show first 10 tracking records as example
                trackingData.slice(0, 10).forEach((track, index) => {
                    const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                    html += `
                        <tr style="background: ${rowColor};">
                            <td style="padding: 8px; border: 1px solid #ddd;">${track.patient_id}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${track.supply_id}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${track.day}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${track.quantity || 0}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${track.month || 'N/A'}</td>
                        </tr>`;
                });
                
                if (trackingData.length > 10) {
                    html += `
                        <tr>
                            <td colspan="5" style="padding: 10px; text-align: center; font-style: italic; color: #666;">
                                ... and ${trackingData.length - 10} more tracking records
                            </td>
                        </tr>`;
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            } else {
                html += '<p style="text-align: center; color: #666; margin: 20px 0;">No tracking data recorded yet</p>';
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        // Update Dashboard with enhanced calculations
        function updateDashboard() {
            document.getElementById('totalPatients').textContent = patients.length.toString();
            document.getElementById('totalSupplies').textContent = supplies.length.toString();
            
            let totalUsage = 0;
            trackingData.forEach(track => {
                totalUsage += parseInt(track.quantity || 0);
            });
            document.getElementById('totalUsage').textContent = totalUsage.toString();
            
            // Add total cost card for admin users if we have cost data
            const dashboardCards = document.querySelector('.dashboard-cards');
            const existingCostCard = document.getElementById('totalCostCard');
            
            if (currentUser && currentUser.role === 'admin' && supplies.length > 0) {
                let totalCost = 0;
                supplies.forEach(supply => {
                    const cost = parseFloat(supply.cost || supply.amount || 0);
                    totalCost += cost;
                });
                
                if (!existingCostCard && totalCost > 0) {
                    const costCard = document.createElement('div');
                    costCard.className = 'dashboard-card';
                    costCard.id = 'totalCostCard';
                    costCard.innerHTML = `
                        <div class="card-icon">üí∞</div>
                        <div class="card-title">Total Supply Value</div>
                        <div class="card-value">${totalCost.toFixed(2)}</div>
                    `;
                    dashboardCards.appendChild(costCard);
                }
            }
        }

        // Utility Functions
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => element.style.display = 'none', 5000);
            } else {
                console.error('Error:', message);
            }
        }

        // Debug function to test API endpoints
        window.testAPI = async function() {
            console.log('=== API TEST START ===');
            console.log('Auth token:', authToken ? 'Present' : 'Missing');
            console.log('Current user:', currentUser);
            
            // Test facilities (should work - public)
            try {
                const facResponse = await fetch('/api/facilities');
                const facData = await facResponse.json();
                console.log('‚úÖ Facilities API:', facResponse.status, facData);
            } catch (error) {
                console.log('‚ùå Facilities API error:', error);
            }
            
            // Test supplies (requires auth)
            try {
                const supResponse = await apiRequest('/api/supplies');
                const supData = await supResponse.json();
                console.log('‚úÖ Supplies API:', supResponse.status, supData);
            } catch (error) {
                console.log('‚ùå Supplies API error:', error);
            }
            
            // Test tracking (requires auth)
            try {
                const trackResponse = await apiRequest('/api/tracking');
                const trackData = await trackResponse.json();
                console.log('‚úÖ Tracking API:', trackResponse.status, trackData);
            } catch (error) {
                console.log('‚ùå Tracking API error:', error);
            }
            
            console.log('=== API TEST END ===');
        };

        // Check for existing session
        window.addEventListener('load', function() {
            const savedUser = sessionStorage.getItem('currentUser');
            const savedToken = sessionStorage.getItem('authToken');
            if (savedUser && savedToken) {
                currentUser = JSON.parse(savedUser);
                authToken = savedToken;
                showMainApplication();
            }
        });

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('DOM loaded, initializing...');
                initializeAuth();
                console.log('Application initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize application');
            }
        });
    </script>
</body>
</html>
