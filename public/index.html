<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wound Care RT Supply Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .login-card h1 { color: #667eea; margin-bottom: 10px; font-size: 24px; }
        .login-card p { color: #666; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; transform: none; }
        .error-message { color: #e53e3e; margin-top: 10px; font-size: 14px; display: none; }
        .toggle-auth { margin-top: 20px; color: #667eea; cursor: pointer; text-decoration: underline; }
        .main-app { display: none; min-height: 100vh; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 0; box-shadow: 0 2px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: bold; color: #667eea; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .nav { background: rgba(255, 255, 255, 0.9); padding: 10px 0; margin-bottom: 20px; }
        .nav-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; gap: 20px; }
        .nav-btn { padding: 10px 20px; background: transparent; border: 2px solid #667eea; color: #667eea; border-radius: 25px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .nav-btn:hover, .nav-btn.active { background: #667eea; color: white; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .section { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; }
        .section.active { display: block; }
        .section h2 { color: #667eea; margin-bottom: 25px; font-size: 28px; }
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; transition: all 0.3s; }
        .card:hover { border-color: #667eea; transform: translateY(-2px); }
        .card h3 { color: #4a5568; margin-bottom: 15px; font-size: 18px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .stat-number { font-size: 36px; font-weight: bold; margin-bottom: 10px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; color: #4a5568; }
        tr:hover { background: #f1f5f9; }
        .btn-small { padding: 8px 16px; font-size: 14px; border-radius: 6px; margin-right: 8px; }
        .btn-secondary { background: #e2e8f0; color: #4a5568; }
        .btn-danger { background: #e53e3e; }
        .btn-success { background: #38a169; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal h3 { color: #667eea; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .tracking-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 8px; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
        .day-input { width: 100%; padding: 6px; text-align: center; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; transition: all 0.3s; }
        .day-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2); }
        .day-input:hover { border-color: #a0aec0; }
        .supply-row { background: #f8fafc; padding: 0; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e2e8f0; overflow: hidden; transition: all 0.3s; }
        .supply-row:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .supply-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; margin: 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .filter-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 14px; color: #4a5568; font-weight: 500; }
        .filter-group select, .filter-group input { padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .success-message { color: #38a169; background: #f0fff4; padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #38a169; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 3000; transform: translateX(400px); transition: transform 0.3s ease; max-width: 300px; }
        .toast.show { transform: translateX(0); }
        .toast.error { background: #e53e3e; }
        .export-progress { display: none; text-align: center; padding: 20px; background: #f0f9ff; border-radius: 8px; margin: 10px 0; border: 2px solid #3b82f6; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #e5e7eb; border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .admin-only { display: none; }
        .admin-only.show-admin { display: block; }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 15px; }
            .nav-content { flex-direction: column; align-items: center; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .filter-container { flex-direction: column; }
            .modal-content { margin: 20px; width: auto; }
            .section { padding: 20px; }
        }
    </style>
</head>
<body>
    <div id="authContainer" class="login-container">
        <div class="login-card">
            <h1>üè• Wound Care RT Supply Tracker</h1>
            <p>Healthcare Supply Management System</p>
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button class="btn" onclick="login()" id="loginBtn">Sign In</button>
                <div id="loginError" class="error-message"></div>
                <div class="toggle-auth" onclick="toggleAuthMode()">Need an account? Register here</div>
            </div>
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="registerFacility">Facility</label>
                    <select id="registerFacility" required><option value="">Select a facility</option></select>
                </div>
                <button class="btn" onclick="register()" id="registerBtn">Register</button>
                <div id="registerError" class="error-message"></div>
                <div class="toggle-auth" onclick="toggleAuthMode()">Already have an account? Sign in</div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="main-app">
        <div class="header">
            <div class="header-content">
                <div class="logo">üè• Wound Care RT Supply Tracker</div>
                <div class="user-info">
                    <span id="userWelcome">Welcome, User</span>
                    <button class="btn btn-small" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <div class="nav">
            <div class="nav-content">
                <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showSection('patients')">Patients</button>
                <button class="nav-btn" onclick="showSection('tracking')">Supply Tracking</button>
                <button class="nav-btn" onclick="showSection('reports')">Reports</button>
                <button class="nav-btn admin-only" onclick="showSection('supplies')">Manage Supplies</button>
                <button class="nav-btn admin-only" onclick="showSection('facilities')">Manage Facilities</button>
                <button class="nav-btn admin-only" onclick="showSection('users')">Manage Users</button>
            </div>
        </div>

        <div class="container">
            <div id="dashboardSection" class="section active">
                <h2>üìä Dashboard Overview</h2>
                <div class="filter-container">
                    <div class="filter-group">
                        <label>Facility</label>
                        <select id="dashboardFacilityFilter" onchange="loadDashboard()"><option value="">All Facilities</option></select>
                    </div>
                    <div class="filter-group">
                        <label>Month</label>
                        <select id="dashboardMonthFilter" onchange="loadDashboard()"><option value="">All Months</option></select>
                    </div>
                </div>
                <div class="stats-grid" id="statsGrid"></div>
                <div class="card">
                    <h3>Recent Patient Activity</h3>
                    <div class="table-container">
                        <table id="dashboardTable">
                            <thead><tr><th>Patient</th><th>Month</th><th>Facility</th><th>Total Units</th><th>Total Cost</th><th>Wound Diagnoses</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="patientsSection" class="section">
                <h2>üë• Patient Management</h2>
                <div class="filter-container">
                    <div class="filter-group">
                        <label>Facility</label>
                        <select id="patientsFacilityFilter" onchange="loadPatientsTable()"><option value="">All Facilities</option></select>
                    </div>
                    <div class="filter-group">
                        <label>Month</label>
                        <select id="patientsMonthFilter" onchange="loadPatientsTable()"><option value="">All Months</option></select>
                    </div>
                </div>
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Patient List</h3>
                        <button class="btn btn-small" onclick="showAddPatientModal()">+ Add Patient</button>
                    </div>
                    <div class="table-container">
                        <table id="patientsTable">
                            <thead><tr><th>Name</th><th>MRN</th><th>Month</th><th>Facility</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="trackingSection" class="section">
                <h2>üìã Supply Tracking</h2>
                <div class="filter-container">
                    <div class="filter-group">
                        <label>Facility</label>
                        <select id="trackingFacilityFilter" onchange="filterTrackingPatients()"><option value="">All Facilities</option></select>
                    </div>
                    <div class="filter-group">
                        <label>Month</label>
                        <select id="trackingMonthFilter" onchange="filterTrackingPatients()"><option value="">All Months</option></select>
                    </div>
                    <div class="filter-group">
                        <label>Select Patient</label>
                        <select id="trackingPatientSelect" onchange="loadPatientTracking()"><option value="">Choose a patient...</option></select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-small" onclick="showAddMonthModal()">+ Add New Month</button>
                    </div>
                </div>
                <div id="trackingContent" class="loading">Select filters and patient to begin tracking supplies</div>
            </div>

            <div id="reportsSection" class="section">
                <h2>üìà Reports & Analytics</h2>
                <div class="grid grid-2">
                    <div class="card">
                        <h3>Itemized Summary Report</h3>
                        <p>Detailed breakdown of supply usage by patient</p>
                        <div class="filter-container">
                            <div class="filter-group">
                                <label>Facility</label>
                                <select id="reportFacilityFilter"><option value="">All Facilities</option></select>
                            </div>
                            <div class="filter-group">
                                <label>Month</label>
                                <select id="reportMonthFilter"><option value="">All Months</option></select>
                            </div>
                        </div>
                        <button class="btn" onclick="generateItemizedReport()">Generate Report</button>
                        <div class="export-progress" id="reportProgress">
                            <div class="spinner"></div>
                            <span>Generating report...</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Export Options</h3>
                        <p>Export data for external analysis</p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-secondary" onclick="exportCurrentReport('csv')">üìä Export Current Report as CSV</button>
                            <button class="btn btn-secondary" onclick="exportCurrentReport('excel')">üìà Export Current Report as Excel</button>
                            <button class="btn btn-secondary" onclick="exportAllPatients('csv')">üë• Export All Patients as CSV</button>
                            <button class="btn btn-secondary" onclick="exportDashboardData('csv')">üìã Export Dashboard Data as CSV</button>
                        </div>
                        <div class="export-progress" id="exportProgress">
                            <div class="spinner"></div>
                            <span>Preparing export...</span>
                        </div>
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">
                        <h4>Quick Export Templates</h4>
                        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Pre-formatted reports for common use cases</p>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn btn-secondary btn-small" onclick="exportTemplate('monthly-summary')">üìÖ Monthly Summary Template</button>
                            <button class="btn btn-secondary btn-small" onclick="exportTemplate('facility-breakdown')">üè¢ Facility Breakdown Template</button>
                            <button class="btn btn-secondary btn-small" onclick="exportTemplate('cost-analysis')">üí∞ Cost Analysis Template</button>
                        </div>
                    </div>
                </div>
                <div id="reportResults" style="display: none;">
                    <div class="card">
                        <h3>Report Results</h3>
                        <div class="table-container">
                            <table id="reportTable">
                                <thead><tr><th>Patient</th><th>MRN</th><th>Facility</th><th>AR Code</th><th>Description</th><th>HCPCS</th><th>Units</th><th>Unit Cost</th><th>Total Cost</th><th>Wound Dx</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="suppliesSection" class="section">
                <h2>üè• Supply Management</h2>
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Supply Catalog</h3>
                        <button class="btn btn-small" onclick="showAddSupplyModal()">+ Add Supply</button>
                    </div>
                    <div class="table-container">
                        <table id="suppliesTable">
                            <thead><tr><th>Code</th><th>Description</th><th>HCPCS</th><th>Cost</th><th>Type</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="facilitiesSection" class="section">
                <h2>üè¢ Facility Management</h2>
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Healthcare Facilities</h3>
                        <button class="btn btn-small" onclick="showAddFacilityModal()">+ Add Facility</button>
                    </div>
                    <div class="table-container">
                        <table id="facilitiesTable">
                            <thead><tr><th>Name</th><th>Created</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="usersSection" class="section">
                <h2>üë§ User Management</h2>
                <div class="card">
                    <h3>System Users</h3>
                    <div class="table-container">
                        <table id="usersTable">
                            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Facility</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addPatientModal" class="modal">
        <div class="modal-content">
            <h3>Add New Patient</h3>
            <div class="success-message" id="patientSuccess"></div>
            <div class="form-group">
                <label>Patient Name</label>
                <input type="text" id="newPatientName" placeholder="Last, First">
            </div>
            <div class="form-group">
                <label>MRN</label>
                <input type="text" id="newPatientMRN" placeholder="Medical Record Number">
            </div>
            <div class="form-group">
                <label>Month</label>
                <input type="month" id="newPatientMonth">
            </div>
            <div class="form-group">
                <label>Facility</label>
                <select id="newPatientFacility"><option value="">Select facility...</option></select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('addPatientModal')">Cancel</button>
                <button class="btn" onclick="addPatient()">Add Patient</button>
            </div>
        </div>
    </div>

    <div id="addSupplyModal" class="modal">
        <div class="modal-content">
            <h3>Add New Supply</h3>
            <div class="form-group">
                <label>AR Code</label>
                <input type="number" id="newSupplyCode" placeholder="Supply code">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="newSupplyDescription" placeholder="Supply description">
            </div>
            <div class="form-group">
                <label>HCPCS Code</label>
                <input type="text" id="newSupplyHCPCS" placeholder="HCPCS code">
            </div>
            <div class="form-group">
                <label>Unit Cost</label>
                <input type="number" id="newSupplyCost" step="0.01" placeholder="0.00">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('addSupplyModal')">Cancel</button>
                <button class="btn" onclick="addSupply()">Add Supply</button>
            </div>
        </div>
    </div>

    <div id="addFacilityModal" class="modal">
        <div class="modal-content">
            <h3>Add New Facility</h3>
            <div class="form-group">
                <label>Facility Name</label>
                <input type="text" id="newFacilityName" placeholder="Facility name">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('addFacilityModal')">Cancel</button>
                <button class="btn" onclick="addFacility()">Add Facility</button>
            </div>
        </div>
    </div>

    <div id="editSupplyModal" class="modal">
        <div class="modal-content">
            <h3>Edit Supply</h3>
            <input type="hidden" id="editSupplyId">
            <div class="form-group">
                <label>AR Code</label>
                <input type="number" id="editSupplyCode" placeholder="Supply code">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="editSupplyDescription" placeholder="Supply description">
            </div>
            <div class="form-group">
                <label>HCPCS Code</label>
                <input type="text" id="editSupplyHCPCS" placeholder="HCPCS code">
            </div>
            <div class="form-group">
                <label>Unit Cost</label>
                <input type="number" id="editSupplyCost" step="0.01" placeholder="0.00">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('editSupplyModal')">Cancel</button>
                <button class="btn" onclick="updateSupply()">Update Supply</button>
            </div>
        </div>
    </div>

    <div id="editFacilityModal" class="modal">
        <div class="modal-content">
            <h3>Edit Facility</h3>
            <input type="hidden" id="editFacilityId">
            <div class="form-group">
                <label>Facility Name</label>
                <input type="text" id="editFacilityName" placeholder="Facility name">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('editFacilityModal')">Cancel</button>
                <button class="btn" onclick="updateFacility()">Update Facility</button>
            </div>
        </div>
    </div>

    <div id="addMonthModal" class="modal">
        <div class="modal-content">
            <h3>Add New Month</h3>
            <p>Add a new month/year for patient tracking</p>
            <div class="form-group">
                <label>Month/Year</label>
                <input type="month" id="newMonthInput" placeholder="Select month and year">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('addMonthModal')">Cancel</button>
                <button class="btn" onclick="addNewMonth()">Add Month</button>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <h3>Edit User</h3>
            <input type="hidden" id="editUserId">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editUserName" placeholder="Full name">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="editUserEmail" placeholder="Email address">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="editUserRole">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label>Facility</label>
                <select id="editUserFacility"><option value="">No facility assigned</option></select>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="editUserApproved"> Account Approved</label>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="btn" onclick="updateUser()">Update User</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let currentUser = null;
        let currentSection = 'dashboard';
        let supplies = [];
        let facilities = [];
        let patients = [];
        let availableMonths = [];

        function generateAvailableMonths() {
            const months = [];
            const startDate = new Date('2024-08-01');
            const currentDate = new Date();
            const endDate = new Date(currentDate.getFullYear() + 2, currentDate.getMonth() + 24, 1);
            let iterDate = new Date(startDate);
            while (iterDate <= endDate) {
                const yearMonth = iterDate.getFullYear() + '-' + String(iterDate.getMonth() + 1).padStart(2, '0');
                const displayText = iterDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                months.push({ value: yearMonth, text: displayText });
                iterDate.setMonth(iterDate.getMonth() + 1);
            }
            months.sort((a, b) => a.value.localeCompare(b.value));
            availableMonths = months;
            return months;
        }

        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': 'Bearer ' + token })
                },
                ...options
            };
            if (options.body) {
                config.body = JSON.stringify(options.body);
            }
            try {
                const response = await fetch('/api' + endpoint, config);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'HTTP ' + response.status);
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            if (!email || !password) {
                showError('loginError', 'Please enter both email and password');
                return;
            }
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing In...';
            loginError.style.display = 'none';
            try {
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: { email, password }
                });
                localStorage.setItem('authToken', response.token);
                currentUser = response.user;
                showMainApp();
            } catch (error) {
                showError('loginError', error.message || 'Login failed');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        async function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const facilityId = document.getElementById('registerFacility').value;
            const registerBtn = document.getElementById('registerBtn');
            const registerError = document.getElementById('registerError');
            if (!name || !email || !password || !facilityId) {
                showError('registerError', 'Please fill in all fields');
                return;
            }
            registerBtn.disabled = true;
            registerBtn.textContent = 'Registering...';
            registerError.style.display = 'none';
            try {
                await apiCall('/auth/register', {
                    method: 'POST',
                    body: { name, email, password, facilityId: parseInt(facilityId) }
                });
                alert('Registration successful! Please wait for admin approval before logging in.');
                toggleAuthMode();
            } catch (error) {
                showError('registerError', error.message || 'Registration failed');
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Register';
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            currentUser = null;
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function toggleAuthMode() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                loadFacilitiesForRegistration();
            }
        }

        async function loadFacilitiesForRegistration() {
            try {
                const facilities = await apiCall('/facilities/public');
                const select = document.getElementById('registerFacility');
                select.innerHTML = '<option value="">Select a facility</option>';
                facilities.forEach(facility => {
                    const option = document.createElement('option');
                    option.value = facility.id;
                    option.textContent = facility.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load facilities:', error);
            }
        }

        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userWelcome').textContent = 'Welcome, ' + currentUser.name;
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('show-admin'));
            }
            initializeApp();
        }

        async function initializeApp() {
            try {
                generateAvailableMonths();
                await Promise.all([loadSupplies(), loadFacilities(), loadPatients(), loadDashboard()]);
                populateFilters();
            } catch (error) {
                console.error('Failed to initialize app:', error);
            }
        }

        function showSection(sectionName) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionName + 'Section').classList.add('active');
            currentSection = sectionName;
            switch(sectionName) {
                case 'dashboard': loadDashboard(); break;
                case 'patients': loadPatientsTable(); break;
                case 'tracking': loadPatientsForTracking(); break;
                case 'supplies': loadSuppliesTable(); break;
                case 'facilities': loadFacilitiesTable(); break;
                case 'users': loadUsersTable(); break;
            }
        }

        async function loadSupplies() {
            try {
                supplies = await apiCall('/supplies');
            } catch (error) {
                console.error('Failed to load supplies:', error);
                supplies = [];
            }
        }

        async function loadFacilities() {
            try {
                facilities = await apiCall('/facilities');
            } catch (error) {
                console.error('Failed to load facilities:', error);
                facilities = [];
            }
        }

        async function loadPatients() {
            try {
                patients = await apiCall('/patients');
            } catch (error) {
                console.error('Failed to load patients:', error);
                patients = [];
            }
        }

        function populateFilters() {
            if (availableMonths.length === 0) {
                generateAvailableMonths();
            }
            const facilitySelects = ['dashboardFacilityFilter', 'reportFacilityFilter', 'newPatientFacility', 'patientsFacilityFilter', 'trackingFacilityFilter', 'editUserFacility'];
            facilitySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const isFormField = selectId.includes('new') || selectId.includes('edit');
                    select.innerHTML = isFormField ? (selectId.includes('editUser') ? '<option value="">No facility assigned</option>' : '<option value="">Select facility...</option>') : '<option value="">All Facilities</option>';
                    facilities.forEach(facility => {
                        const option = document.createElement('option');
                        option.value = facility.id;
                        option.textContent = facility.name;
                        select.appendChild(option);
                    });
                }
            });
            const monthSelects = ['dashboardMonthFilter', 'reportMonthFilter', 'patientsMonthFilter', 'trackingMonthFilter'];
            monthSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">All Months</option>';
                    availableMonths.forEach(month => {
                        const option = document.createElement('option');
                        option.value = month.value;
                        option.textContent = month.text;
                        select.appendChild(option);
                    });
                }
            });
            const today = new Date();
            const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            const newPatientMonth = document.getElementById('newPatientMonth');
            if (newPatientMonth && !newPatientMonth.value) {
                newPatientMonth.value = currentMonth;
            }
        }

        async function loadDashboard() {
            try {
                const facilityId = document.getElementById('dashboardFacilityFilter').value;
                const month = document.getElementById('dashboardMonthFilter').value;
                const params = new URLSearchParams();
                if (facilityId) params.append('facilityId', facilityId);
                if (month) params.append('month', month);
                const data = await apiCall('/dashboard/summary?' + params);
                const totalPatients = data.length;
                const totalUnits = data.reduce((sum, item) => sum + parseInt(item.total_units || 0), 0);
                const totalCost = data.reduce((sum, item) => sum + parseFloat(item.total_cost || 0), 0);
                const activeFacilities = new Set(data.map(item => item.facility_name)).size;
                document.getElementById('statsGrid').innerHTML = '<div class="stat-card"><div class="stat-number">' + totalPatients + '</div><div class="stat-label">Total Patients</div></div><div class="stat-card"><div class="stat-number">' + totalUnits.toLocaleString() + '</div><div class="stat-label">Supply Units Used</div></div><div class="stat-card"><div class="stat-number">$' + totalCost.toFixed(2) + '</div><div class="stat-label">Total Supply Cost</div></div><div class="stat-card"><div class="stat-number">' + activeFacilities + '</div><div class="stat-label">Active Facilities</div></div>';
                const tbody = document.querySelector('#dashboardTable tbody');
                tbody.innerHTML = data.slice(0, 10).map(item => '<tr><td>' + item.name + '</td><td>' + item.month + '</td><td>' + (item.facility_name || 'N/A') + '</td><td>' + (item.total_units || 0) + '</td><td>$' + parseFloat(item.total_cost || 0).toFixed(2) + '</td><td>' + (item.wound_diagnoses || 'N/A') + '</td></tr>').join('');
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function loadPatientsTable() {
            try {
                const facilityFilter = document.getElementById('patientsFacilityFilter') ? document.getElementById('patientsFacilityFilter').value : '';
                const monthFilter = document.getElementById('patientsMonthFilter') ? document.getElementById('patientsMonthFilter').value : '';
                let filteredPatients = [...patients];
                if (facilityFilter) {
                    filteredPatients = filteredPatients.filter(p => p.facility_id == facilityFilter);
                }
                if (monthFilter) {
                    filteredPatients = filteredPatients.filter(p => p.month === monthFilter);
                }
                const tbody = document.querySelector('#patientsTable tbody');
                tbody.innerHTML = filteredPatients.map(patient => '<tr><td>' + patient.name + '</td><td>' + (patient.mrn || 'N/A') + '</td><td>' + patient.month + '</td><td>' + (patient.facility_name || 'N/A') + '</td><td><button class="btn btn-small btn-danger" onclick="deletePatient(' + patient.id + ')">Delete</button></td></tr>').join('');
            } catch (error) {
                console.error('Failed to load patients table:', error);
            }
        }

        function filterTrackingPatients() {
            const facilityFilter = document.getElementById('trackingFacilityFilter').value;
            const monthFilter = document.getElementById('trackingMonthFilter').value;
            const select = document.getElementById('trackingPatientSelect');
            let filteredPatients = [...patients];
            if (facilityFilter) {
                filteredPatients = filteredPatients.filter(p => p.facility_id == facilityFilter);
            }
            if (monthFilter) {
                filteredPatients = filteredPatients.filter(p => p.month === monthFilter);
            }
            select.innerHTML = '<option value="">Choose a patient...</option>';
            filteredPatients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = patient.name + ' - ' + patient.month + ' (' + (patient.facility_name || 'N/A') + ')';
                select.appendChild(option);
            });
            document.getElementById('trackingContent').innerHTML = '<div class="loading">Select filters and patient to begin tracking supplies</div>';
        }

        async function loadPatientsForTracking() {
            filterTrackingPatients();
        }

        async function loadPatientTracking() {
            const patientId = document.getElementById('trackingPatientSelect').value;
            const contentDiv = document.getElementById('trackingContent');
            if (!patientId) {
                contentDiv.innerHTML = '<div class="loading">Select filters and patient to begin tracking supplies</div>';
                return;
            }
            contentDiv.innerHTML = '<div class="loading">Loading patient tracking data...</div>';
            try {
                const trackingData = await apiCall('/tracking/' + patientId);
                const patient = patients.find(p => p.id === parseInt(patientId));
                if (!patient) {
                    contentDiv.innerHTML = '<div class="error">Patient not found</div>';
                    return;
                }
                const trackingBySupply = {};
                trackingData.forEach(item => {
                    if (!trackingBySupply[item.supply_id]) {
                        trackingBySupply[item.supply_id] = { supply: supplies.find(s => s.id === item.supply_id), days: {}, wound_dx: item.wound_dx || '' };
                    }
                    trackingBySupply[item.supply_id].days[item.day_of_month] = item.quantity;
                    if (item.wound_dx) {
                        trackingBySupply[item.supply_id].wound_dx = item.wound_dx;
                    }
                });
                const parts = patient.month.split('-');
                const monthText = new Date(parts[0], parts[1] - 1, 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                let html = '<div class="card"><h3>üè• Supply Tracking for ' + patient.name + '</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;"><div><strong>Month:</strong> ' + monthText + '</div><div><strong>Facility:</strong> ' + (patient.facility_name || 'N/A') + '</div><div><strong>MRN:</strong> ' + (patient.mrn || 'N/A') + '</div><div><strong>Patient ID:</strong> ' + patient.id + '</div></div></div>';
                html += '<div class="card"><h4>üìÖ Daily Tracking Grid</h4><p style="margin-bottom: 20px; color: #666;">Enter quantities used for each day of the month. Days are numbered 1-31.</p>';
                const sortedSupplies = supplies.sort((a, b) => a.code - b.code);
                sortedSupplies.forEach(supply => {
                    const tracking = trackingBySupply[supply.id] || { days: {}, wound_dx: '' };
                    const totalUnits = Object.values(tracking.days).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
                    const totalCost = totalUnits * parseFloat(supply.cost || 0);
                    const dayInputs = Array.from({length: 31}, (_, i) => {
                        const day = i + 1;
                        const quantity = tracking.days[day] || '';
                        return '<div style="text-align: center;"><div style="font-size: 11px; font-weight: 600; color: #4a5568; margin-bottom: 4px;">Day ' + day + '</div><input type="number" class="day-input" min="0" max="999" style="width: 100%; padding: 6px; text-align: center; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px;" value="' + quantity + '" placeholder="0" onchange="updateTracking(' + patientId + ', ' + supply.id + ', ' + day + ', this.value)" onblur="this.style.borderColor=\'#cbd5e0\'" onfocus="this.style.borderColor=\'#667eea\'; this.select()" oninput="updateTrackingSummary()"></div>';
                    }).join('');
                    html += '<div class="supply-row" style="border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 20px; background: #f8fafc;"><div class="supply-header" style="background: #667eea; color: white; padding: 15px; border-radius: 8px 8px 0 0; margin: -1px -1px 15px -1px;"><div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;"><div style="font-size: 18px; font-weight: bold;">AR ' + supply.code + ' - ' + supply.description + '</div><div style="font-size: 14px; opacity: 0.9;">' + (supply.hcpcs ? 'HCPCS: ' + supply.hcpcs + ' | ' : '') + '$' + parseFloat(supply.cost || 0).toFixed(2) + ' each</div></div><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 14px; opacity: 0.9;"><div>Total Units: ' + totalUnits + '</div><div>Total Cost: $' + totalCost.toFixed(2) + '</div></div></div><div style="padding: 0 15px;"><div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">ü©π Wound Diagnosis:</label><input type="text" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;" value="' + (tracking.wound_dx || '') + '" placeholder="Enter primary wound diagnosis for this supply..." onchange="updateWoundDx(' + patientId + ', ' + supply.id + ', this.value)" onblur="this.style.borderColor=\'#e2e8f0\'" onfocus="this.style.borderColor=\'#667eea\'"></div><div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">üìä Daily Usage (Day 1-31):</label><div class="tracking-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 8px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">' + dayInputs + '</div></div></div></div>';
                });
                html += '</div>';
                const grandTotalUnits = Object.values(trackingBySupply).reduce((sum, tracking) => {
                    return sum + Object.values(tracking.days).reduce((daySum, qty) => daySum + (parseInt(qty) || 0), 0);
                }, 0);
                const grandTotalCost = Object.values(trackingBySupply).reduce((sum, tracking) => {
                    const supply = supplies.find(s => s.id === tracking.supply ? tracking.supply.id : null);
                    const units = Object.values(tracking.days).reduce((daySum, qty) => daySum + (parseInt(qty) || 0), 0);
                    return sum + (units * parseFloat(supply ? supply.cost || 0 : 0));
                }, 0);
                html += '<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><h3>üìà Summary for ' + patient.name + ' - ' + monthText + '</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;"><div style="text-align: center;"><div style="font-size: 28px; font-weight: bold;">' + grandTotalUnits + '</div><div style="opacity: 0.9;">Total Supply Units</div></div><div style="text-align: center;"><div style="font-size: 28px; font-weight: bold;">$' + grandTotalCost.toFixed(2) + '</div><div style="opacity: 0.9;">Total Supply Cost</div></div><div style="text-align: center;"><div style="font-size: 28px; font-weight: bold;">' + Object.keys(trackingBySupply).length + '</div><div style="opacity: 0.9;">Active Supply Items</div></div></div></div>';
                contentDiv.innerHTML = html;
            } catch (error) {
                console.error('Failed to load patient tracking:', error);
                contentDiv.innerHTML = '<div class="card" style="border: 2px solid #e53e3e; background: #fef2f2;"><h3 style="color: #e53e3e;">‚ùå Error Loading Tracking Data</h3><p>Failed to load tracking data for this patient. Please try again.</p><p style="font-size: 14px; color: #666; margin-top: 10px;">Error: ' + error.message + '</p></div>';
            }
        }

        async function updateTracking(patientId, supplyId, dayOfMonth, quantity) {
            try {
                const input = window.event ? window.event.target : null;
                let originalBorder = '#cbd5e0';
                if (input) {
                    originalBorder = input.style.borderColor || '#cbd5e0';
                    input.style.borderColor = '#f6ad55';
                    input.disabled = true;
                }
                await apiCall('/tracking', {
                    method: 'POST',
                    body: { patientId: parseInt(patientId), supplyId: parseInt(supplyId), dayOfMonth: parseInt(dayOfMonth), quantity: parseInt(quantity) || 0 }
                });
                if (input) {
                    input.style.borderColor = '#38a169';
                    setTimeout(() => {
                        input.style.borderColor = originalBorder;
                        input.disabled = false;
                    }, 1000);
                }
                updateTrackingSummary();
            } catch (error) {
                console.error('Failed to update tracking:', error);
                const input = window.event ? window.event.target : null;
                if (input) {
                    input.style.borderColor = '#e53e3e';
                    input.disabled = false;
                    setTimeout(() => {
                        input.style.borderColor = '#cbd5e0';
                    }, 2000);
                }
                alert('Failed to save tracking data. Please try again.');
            }
        }

        async function updateWoundDx(patientId, supplyId, woundDx) {
            try {
                const input = window.event ? window.event.target : null;
                let originalBorder = '#e2e8f0';
                if (input) {
                    originalBorder = input.style.borderColor || '#e2e8f0';
                    input.style.borderColor = '#f6ad55';
                    input.disabled = true;
                }
                await apiCall('/tracking', {
                    method: 'POST',
                    body: { patientId: parseInt(patientId), supplyId: parseInt(supplyId), dayOfMonth: 1, woundDx: woundDx.trim() }
                });
                if (input) {
                    input.style.borderColor = '#38a169';
                    setTimeout(() => {
                        input.style.borderColor = originalBorder;
                        input.disabled = false;
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to update wound diagnosis:', error);
                const input = window.event ? window.event.target : null;
                if (input) {
                    input.style.borderColor = '#e53e3e';
                    input.disabled = false;
                    setTimeout(() => {
                        input.style.borderColor = '#e2e8f0';
                    }, 2000);
                }
                alert('Failed to save wound diagnosis. Please try again.');
            }
        }
        
        function updateTrackingSummary() {
            try {
                const summarySection = document.querySelector('.card[style*="linear-gradient"]');
                if (!summarySection) return;
                let totalUnits = 0;
                let totalCost = 0;
                let activeSupplies = 0;
                document.querySelectorAll('.supply-row').forEach(row => {
                    const inputs = row.querySelectorAll('input[type="number"]');
                    let supplyUnits = 0;
                    inputs.forEach(input => {
                        const qty = parseInt(input.value) || 0;
                        supplyUnits += qty;
                    });
                    if (supplyUnits > 0) {
                        activeSupplies++;
                        totalUnits += supplyUnits;
                        const headerElement = row.querySelector('.supply-header');
                        if (headerElement) {
                            const costText = headerElement.textContent || '';
                            const costMatch = costText.match(/\$(\d+\.?\d*)/);
                            const unitCost = costMatch ? parseFloat(costMatch[1]) : 0;
                            const supplyCost = supplyUnits * unitCost;
                            totalCost += supplyCost;
                            const headerTotals = headerElement.querySelector('div:last-child');
                            if (headerTotals) {
                                headerTotals.innerHTML = 'Total Units: ' + supplyUnits + ' | Total Cost: $' + supplyCost.toFixed(2);
                            }
                        }
                    }
                });
                const summaryStats = summarySection.querySelectorAll('div[style*="font-size: 28px"]');
                if (summaryStats.length >= 3) {
                    summaryStats[0].textContent = totalUnits.toLocaleString();
                    summaryStats[1].textContent = '$' + totalCost.toFixed(2);
                    summaryStats[2].textContent = activeSupplies;
                }
            } catch (error) {
                console.error('Error updating tracking summary:', error);
            }
        }

        async function generateItemizedReport() {
            const facilityId = document.getElementById('reportFacilityFilter').value;
            const month = document.getElementById('reportMonthFilter').value;
            showExportProgress('Generating itemized report...');
            const params = new URLSearchParams();
            if (facilityId) params.append('facilityId', facilityId);
            if (month) params.append('month', month);
            try {
                const data = await apiCall('/reports/itemized-summary?' + params);
                const tbody = document.querySelector('#reportTable tbody');
                tbody.innerHTML = data.map(item => '<tr><td>' + item.patient_name + '</td><td>' + (item.mrn || 'N/A') + '</td><td>' + item.facility_name + '</td><td>' + item.ar_code + '</td><td>' + item.item_description + '</td><td>' + (item.hcpcs || 'N/A') + '</td><td>' + item.total_units + '</td><td>$' + parseFloat(item.unit_cost || 0).toFixed(2) + '</td><td>$' + parseFloat(item.total_cost || 0).toFixed(2) + '</td><td>' + (item.wound_dx || 'N/A') + '</td></tr>').join('');
                document.getElementById('reportResults').style.display = 'block';
                const totalCost = data.reduce((sum, item) => sum + parseFloat(item.total_cost || 0), 0);
                const totalUnits = data.reduce((sum, item) => sum + parseInt(item.total_units || 0), 0);
                const uniquePatients = new Set(data.map(item => item.patient_name)).size;
                showToast('‚úÖ Report generated: ' + data.length + ' records, ' + uniquePatients + ' patients, $' + totalCost.toFixed(2) + ' total cost', 'success');
            } catch (error) {
                console.error('Failed to generate report:', error);
                showToast('Failed to generate report. Please try again.', 'error');
            } finally {
                hideExportProgress();
            }
        }

        async function loadSuppliesTable() {
            if (currentUser.role !== 'admin') return;
            try {
                const tbody = document.querySelector('#suppliesTable tbody');
                tbody.innerHTML = supplies.map(supply => '<tr><td>' + supply.code + '</td><td>' + supply.description + '</td><td>' + (supply.hcpcs || 'N/A') + '</td><td>$' + parseFloat(supply.cost || 0).toFixed(2) + '</td><td>' + (supply.is_custom ? 'Custom' : 'Standard') + '</td><td><button class="btn btn-small btn-secondary" onclick="editSupply(' + supply.id + ')">Edit</button><button class="btn btn-small btn-danger" onclick="deleteSupply(' + supply.id + ')">Delete</button></td></tr>').join('');
            } catch (error) {
                console.error('Failed to load supplies table:', error);
            }
        }

        async function loadFacilitiesTable() {
            if (currentUser.role !== 'admin') return;
            try {
                const tbody = document.querySelector('#facilitiesTable tbody');
                tbody.innerHTML = facilities.map(facility => '<tr><td>' + facility.name + '</td><td>' + new Date(facility.created_at).toLocaleDateString() + '</td><td><button class="btn btn-small btn-secondary" onclick="editFacility(' + facility.id + ')">Edit</button><button class="btn btn-small btn-danger" onclick="deleteFacility(' + facility.id + ')">Delete</button></td></tr>').join('');
            } catch (error) {
                console.error('Failed to load facilities table:', error);
            }
        }

        async function loadUsersTable() {
            if (currentUser.role !== 'admin') return;
            try {
                const users = await apiCall('/users');
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = users.map(user => '<tr><td>' + user.name + '</td><td>' + user.email + '</td><td>' + user.role + '</td><td>' + (user.facility_name || 'N/A') + '</td><td><span style="color: ' + (user.is_approved ? '#38a169' : '#e53e3e') + ';">' + (user.is_approved ? 'Approved' : 'Pending') + '</span></td><td><button class="btn btn-small btn-secondary" onclick="editUser(' + user.id + ')">Edit</button>' + (!user.is_approved ? '<button class="btn btn-small btn-success" onclick="approveUser(' + user.id + ')">Approve</button>' : '') + (user.id !== currentUser.id ? '<button class="btn btn-small btn-danger" onclick="deleteUser(' + user.id + ')">Delete</button>' : '') + '</td></tr>').join('');
            } catch (error) {
                console.error('Failed to load users table:', error);
            }
        }

        function showAddPatientModal() {
            document.getElementById('addPatientModal').style.display = 'flex';
        }

        function showAddSupplyModal() {
            document.getElementById('addSupplyModal').style.display = 'flex';
        }

        function showAddFacilityModal() {
            document.getElementById('addFacilityModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'editSupplyModal') {
                document.getElementById('editSupplyId').value = '';
                document.getElementById('editSupplyCode').value = '';
                document.getElementById('editSupplyDescription').value = '';
                document.getElementById('editSupplyHCPCS').value = '';
                document.getElementById('editSupplyCost').value = '';
            }
            if (modalId === 'editFacilityModal') {
                document.getElementById('editFacilityId').value = '';
                document.getElementById('editFacilityName').value = '';
            }
            if (modalId === 'editUserModal') {
                document.getElementById('editUserId').value = '';
                document.getElementById('editUserName').value = '';
                document.getElementById('editUserEmail').value = '';
                document.getElementById('editUserRole').value = 'user';
                document.getElementById('editUserFacility').value = '';
                document.getElementById('editUserApproved').checked = false;
            }
            if (modalId === 'addMonthModal') {
                document.getElementById('newMonthInput').value = '';
            }
        }

        async function addPatient() {
            const name = document.getElementById('newPatientName').value.trim();
            const mrn = document.getElementById('newPatientMRN').value.trim();
            const month = document.getElementById('newPatientMonth').value;
            const facilityId = document.getElementById('newPatientFacility').value;
            if (!name || !month || !facilityId) {
                alert('Please fill in required fields');
                return;
            }
            try {
                await apiCall('/patients', {
                    method: 'POST',
                    body: { name, mrn, month, facilityId: parseInt(facilityId) }
                });
                document.getElementById('patientSuccess').textContent = 'Patient added successfully!';
                document.getElementById('patientSuccess').style.display = 'block';
                document.getElementById('newPatientName').value = '';
                document.getElementById('newPatientMRN').value = '';
                document.getElementById('newPatientMonth').value = '';
                document.getElementById('newPatientFacility').value = '';
                await loadPatients();
                if (currentSection === 'patients') loadPatientsTable();
                setTimeout(() => {
                    closeModal('addPatientModal');
                    document.getElementById('patientSuccess').style.display = 'none';
                }, 2000);
            } catch (error) {
                alert('Failed to add patient: ' + error.message);
            }
        }

        async function deletePatient(patientId) {
            if (!confirm('Are you sure you want to delete this patient? All tracking data will be lost.')) {
                return;
            }
            try {
                await apiCall('/patients/' + patientId, { method: 'DELETE' });
                await loadPatients();
                loadPatientsTable();
            } catch (error) {
                alert('Failed to delete patient: ' + error.message);
            }
        }

        async function addSupply() {
            const code = document.getElementById('newSupplyCode').value;
            const description = document.getElementById('newSupplyDescription').value.trim();
            const hcpcs = document.getElementById('newSupplyHCPCS').value.trim();
            const cost = document.getElementById('newSupplyCost').value;
            if (!code || !description) {
                alert('Please fill in required fields');
                return;
            }
            try {
                await apiCall('/supplies', {
                    method: 'POST',
                    body: { code: parseInt(code), description, hcpcs, cost: parseFloat(cost) || 0 }
                });
                document.getElementById('newSupplyCode').value = '';
                document.getElementById('newSupplyDescription').value = '';
                document.getElementById('newSupplyHCPCS').value = '';
                document.getElementById('newSupplyCost').value = '';
                closeModal('addSupplyModal');
                await loadSupplies();
                if (currentSection === 'supplies') loadSuppliesTable();
            } catch (error) {
                alert('Failed to add supply: ' + error.message);
            }
        }

        async function addFacility() {
            const name = document.getElementById('newFacilityName').value.trim();
            if (!name) {
                alert('Please enter facility name');
                return;
            }
            try {
                await apiCall('/facilities', {
                    method: 'POST',
                    body: { name }
                });
                document.getElementById('newFacilityName').value = '';
                closeModal('addFacilityModal');
                await loadFacilities();
                if (currentSection === 'facilities') loadFacilitiesTable();
                populateFilters();
            } catch (error) {
                alert('Failed to add facility: ' + error.message);
            }
        }

        async function editSupply(supplyId) {
            const supply = supplies.find(s => s.id === supplyId);
            if (!supply) return;
            document.getElementById('editSupplyId').value = supply.id;
            document.getElementById('editSupplyCode').value = supply.code;
            document.getElementById('editSupplyDescription').value = supply.description;
            document.getElementById('editSupplyHCPCS').value = supply.hcpcs || '';
            document.getElementById('editSupplyCost').value = supply.cost || 0;
            document.getElementById('editSupplyModal').style.display = 'flex';
        }

        async function updateSupply() {
            const supplyId = document.getElementById('editSupplyId').value;
            const code = document.getElementById('editSupplyCode').value;
            const description = document.getElementById('editSupplyDescription').value.trim();
            const hcpcs = document.getElementById('editSupplyHCPCS').value.trim();
            const cost = document.getElementById('editSupplyCost').value;
            if (!code || !description) {
                alert('Please fill in required fields');
                return;
            }
            try {
                await apiCall('/supplies/' + supplyId, {
                    method: 'PUT',
                    body: { code: parseInt(code), description, hcpcs, cost: parseFloat(cost) || 0 }
                });
                closeModal('editSupplyModal');
                await loadSupplies();
                if (currentSection === 'supplies') loadSuppliesTable();
            } catch (error) {
                alert('Failed to update supply: ' + error.message);
            }
        }

        async function deleteSupply(supplyId) {
            const supply = supplies.find(s => s.id === supplyId);
            if (!supply) return;
            if (!confirm('Are you sure you want to delete supply "' + supply.description + '"? This action cannot be undone.')) {
                return;
            }
            try {
                await apiCall('/supplies/' + supplyId, { method: 'DELETE' });
                await loadSupplies();
                if (currentSection === 'supplies') loadSuppliesTable();
            } catch (error) {
                alert('Failed to delete supply: ' + error.message);
            }
        }

        async function editFacility(facilityId) {
            const facility = facilities.find(f => f.id === facilityId);
            if (!facility) return;
            document.getElementById('editFacilityId').value = facility.id;
            document.getElementById('editFacilityName').value = facility.name;
            document.getElementById('editFacilityModal').style.display = 'flex';
        }

        async function updateFacility() {
            const facilityId = document.getElementById('editFacilityId').value;
            const name = document.getElementById('editFacilityName').value.trim();
            if (!name) {
                alert('Please enter facility name');
                return;
            }
            try {
                await apiCall('/facilities/' + facilityId, {
                    method: 'PUT',
                    body: { name }
                });
                closeModal('editFacilityModal');
                await loadFacilities();
                if (currentSection === 'facilities') loadFacilitiesTable();
                populateFilters();
            } catch (error) {
                alert('Failed to update facility: ' + error.message);
            }
        }

        async function deleteFacility(facilityId) {
            const facility = facilities.find(f => f.id === facilityId);
            if (!facility) return;
            if (!confirm('Are you sure you want to delete facility "' + facility.name + '"? This action cannot be undone.')) {
                return;
            }
            try {
                await apiCall('/facilities/' + facilityId, { method: 'DELETE' });
                await loadFacilities();
                if (currentSection === 'facilities') loadFacilitiesTable();
                populateFilters();
            } catch (error) {
                alert('Failed to delete facility: ' + error.message);
            }
        }

        async function editUser(userId) {
            try {
                const users = await apiCall('/users');
                const user = users.find(u => u.id === userId);
                if (!user) return;
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUserName').value = user.name;
                document.getElementById('editUserEmail').value = user.email;
                document.getElementById('editUserRole').value = user.role;
                document.getElementById('editUserFacility').value = user.facility_id || '';
                document.getElementById('editUserApproved').checked = user.is_approved;
                document.getElementById('editUserModal').style.display = 'flex';
            } catch (error) {
                console.error('Failed to load user for editing:', error);
            }
        }

        async function updateUser() {
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const role = document.getElementById('editUserRole').value;
            const facilityId = document.getElementById('editUserFacility').value;
            const isApproved = document.getElementById('editUserApproved').checked;
            if (!name || !email) {
                alert('Please fill in required fields');
                return;
            }
            try {
                await apiCall('/users/' + userId + '/approval', {
                    method: 'PUT',
                    body: { isApproved }
                });
                closeModal('editUserModal');
                if (currentSection === 'users') loadUsersTable();
                showToast('User updated successfully!', 'success');
            } catch (error) {
                console.error('Failed to update user:', error);
                showToast('Failed to update user: ' + error.message, 'error');
            }
        }

        function showAddMonthModal() {
            document.getElementById('addMonthModal').style.display = 'flex';
        }

        function addNewMonth() {
            const monthInput = document.getElementById('newMonthInput').value;
            if (!monthInput) {
                alert('Please select a month and year');
                return;
            }
            const parts = monthInput.split('-');
            const monthText = new Date(parts[0], parts[1] - 1, 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            if (!availableMonths.find(m => m.value === monthInput)) {
                availableMonths.push({ value: monthInput, text: monthText });
                availableMonths.sort((a, b) => a.value.localeCompare(b.value));
                populateFilters();
                alert(monthText + ' has been added to available months');
            } else {
                alert('This month is already available');
            }
            closeModal('addMonthModal');
            document.getElementById('newMonthInput').value = '';
        }

        async function approveUser(userId) {
            try {
                await apiCall('/users/' + userId + '/approval', {
                    method: 'PUT',
                    body: { isApproved: true }
                });
                loadUsersTable();
            } catch (error) {
                alert('Failed to approve user: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }
            try {
                await apiCall('/users/' + userId, { method: 'DELETE' });
                loadUsersTable();
            } catch (error) {
                alert('Failed to delete user: ' + error.message);
            }
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function exportCurrentReport(format) {
            const reportTable = document.getElementById('reportTable');
            const reportResults = document.getElementById('reportResults');
            if (!reportResults || reportResults.style.display === 'none') {
                showToast('Please generate a report first before exporting.', 'error');
                return;
            }
            showExportProgress('Preparing export...');
            const data = extractTableData(reportTable);
            if (data.length === 0) {
                hideExportProgress();
                showToast('No data to export. Please generate a report first.', 'error');
                return;
            }
            const facilityFilter = document.getElementById('reportFacilityFilter').value;
            const monthFilter = document.getElementById('reportMonthFilter').value;
            let filename = 'itemized-summary-report';
            if (facilityFilter) {
                const facilityName = facilities.find(f => f.id == facilityFilter) ? facilities.find(f => f.id == facilityFilter).name : 'facility';
                filename += '-' + facilityName.toLowerCase().replace(/\s+/g, '-');
            }
            if (monthFilter) {
                const monthText = availableMonths.find(m => m.value === monthFilter) ? availableMonths.find(m => m.value === monthFilter).text : monthFilter;
                filename += '-' + monthText.toLowerCase().replace(/\s+/g, '-');
            }
            filename += '-' + new Date().toISOString().split('T')[0];
            try {
                if (format === 'csv') {
                    exportToCSV(data, filename);
                    showToast('‚úÖ Report exported as CSV: ' + filename + '.csv', 'success');
                } else if (format === 'excel') {
                    exportToExcel(data, filename, 'Itemized Summary Report');
                    showToast('‚úÖ Report exported as Excel: ' + filename + '.xls', 'success');
                }
            } catch (error) {
                showToast('Failed to export report. Please try again.', 'error');
                console.error('Export error:', error);
            } finally {
                hideExportProgress();
            }
        }

        async function exportAllPatients(format) {
            showExportProgress('Fetching patient data...');
            try {
                const patientData = await apiCall('/patients');
                const data = [['Patient Name', 'MRN', 'Month', 'Facility', 'Created Date', 'Updated Date']];
                patientData.forEach(patient => {
                    data.push([patient.name || '', patient.mrn || '', patient.month || '', patient.facility_name || '', new Date(patient.created_at).toLocaleDateString(), new Date(patient.updated_at).toLocaleDateString()]);
                });
                const filename = 'all-patients-' + new Date().toISOString().split('T')[0];
                if (format === 'csv') {
                    exportToCSV(data, filename);
                    showToast('‚úÖ Patient data exported: ' + filename + '.csv (' + patientData.length + ' patients)', 'success');
                }
            } catch (error) {
                console.error('Failed to export patients:', error);
                showToast('Failed to export patient data. Please try again.', 'error');
            } finally {
                hideExportProgress();
            }
        }

        async function exportDashboardData(format) {
            showExportProgress('Preparing dashboard export...');
            try {
                const facilityId = document.getElementById('dashboardFacilityFilter').value;
                const month = document.getElementById('dashboardMonthFilter').value;
                const params = new URLSearchParams();
                if (facilityId) params.append('facilityId', facilityId);
                if (month) params.append('month', month);
                const dashboardData = await apiCall('/dashboard/summary?' + params);
                const data = [['Patient Name', 'MRN', 'Month', 'Facility', 'Total Units', 'Total Cost', 'Wound Diagnoses', 'Supply Codes', 'HCPCS Codes', 'Created Date']];
                dashboardData.forEach(item => {
                    data.push([item.name || '', item.mrn || '', item.month || '', item.facility_name || '', item.total_units || '0', '$' + parseFloat(item.total_cost || 0).toFixed(2), item.wound_diagnoses || '', item.supply_codes || '', item.hcpcs_codes || '', new Date(item.created_at).toLocaleDateString()]);
                });
                let filename = 'dashboard-summary';
                if (facilityId) {
                    const facilityName = facilities.find(f => f.id == facilityId) ? facilities.find(f => f.id == facilityId).name : 'facility';
                    filename += '-' + facilityName.toLowerCase().replace(/\s+/g, '-');
                }
                if (month) {
                    const monthText = availableMonths.find(m => m.value === month) ? availableMonths.find(m => m.value === month).text : month;
                    filename += '-' + monthText.toLowerCase().replace(/\s+/g, '-');
                }
                filename += '-' + new Date().toISOString().split('T')[0];
                if (format === 'csv') {
                    exportToCSV(data, filename);
                    showToast('‚úÖ Dashboard data exported: ' + filename + '.csv (' + dashboardData.length + ' records)', 'success');
                }
            } catch (error) {
                console.error('Failed to export dashboard data:', error);
                showToast('Failed to export dashboard data. Please try again.', 'error');
            } finally {
                hideExportProgress();
            }
        }

        async function exportTemplate(templateType) {
            const templateNames = {
                'monthly-summary': 'Monthly Summary',
                'facility-breakdown': 'Facility Breakdown', 
                'cost-analysis': 'Cost Analysis'
            };
            showExportProgress('Generating ' + templateNames[templateType] + ' template...');
            try {
                let data = [];
                let filename = '';
                let sheetName = '';
                switch (templateType) {
                    case 'monthly-summary':
                        data = await generateMonthlySummaryTemplate();
                        filename = 'monthly-summary-' + new Date().toISOString().split('T')[0];
                        sheetName = 'Monthly Summary';
                        break;
                    case 'facility-breakdown':
                        data = await generateFacilityBreakdownTemplate();
                        filename = 'facility-breakdown-' + new Date().toISOString().split('T')[0];
                        sheetName = 'Facility Breakdown';
                        break;
                    case 'cost-analysis':
                        data = await generateCostAnalysisTemplate();
                        filename = 'cost-analysis-' + new Date().toISOString().split('T')[0];
                        sheetName = 'Cost Analysis';
                        break;
                    default:
                        throw new Error('Unknown template type');
                }
                exportToExcel(data, filename, sheetName);
                showToast('‚úÖ ' + templateNames[templateType] + ' template exported: ' + filename + '.xls', 'success');
            } catch (error) {
                console.error('Failed to export template:', error);
                showToast('Failed to export template. Please try again.', 'error');
            } finally {
                hideExportProgress();
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type || 'success') + ' show';
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        function showExportProgress(message) {
            const reportProgress = document.getElementById('reportProgress');
            const exportProgress = document.getElementById('exportProgress');
            if (reportProgress) {
                reportProgress.querySelector('span').textContent = message || 'Exporting...';
                reportProgress.style.display = 'block';
            }
            if (exportProgress) {
                exportProgress.querySelector('span').textContent = message || 'Exporting...';
                exportProgress.style.display = 'block';
            }
        }

        function hideExportProgress() {
            const reportProgress = document.getElementById('reportProgress');
            const exportProgress = document.getElementById('exportProgress');
            if (reportProgress) {
                reportProgress.style.display = 'none';
            }
            if (exportProgress) {
                exportProgress.style.display = 'none';
            }
        }

        function extractTableData(table) {
            if (!table) return [];
            const data = [];
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('th, td');
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                if (rowData.length > 0) {
                    data.push(rowData);
                }
            });
            return data;
        }

        function exportToCSV(data, filename) {
            const BOM = '\uFEFF';
            const csvContent = data.map(row => 
                row.map(cell => {
                    const cellString = String(cell || '');
                    const cleanCell = cellString.replace(/^\$/, '');
                    if (cleanCell.includes(',') || cleanCell.includes('"') || cleanCell.includes('\n') || cleanCell.startsWith('=')) {
                        return '"' + cleanCell.replace(/"/g, '""') + '"';
                    }
                    return cleanCell;
                }).join(',')
            ).join('\n');
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            } else {
                showToast('CSV export is not supported in this browser.', 'error');
            }
        }

        function exportToExcel(data, filename, sheetName) {
            let html = '<html><head><meta charset="utf-8"><meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">';
            html += '<style>body { font-family: Arial, sans-serif; }';
            html += 'table { border-collapse: collapse; width: 100%; }';
            html += 'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }';
            html += 'th { background-color: #4472C4; color: white; font-weight: bold; }';
            html += '.number { text-align: right; }';
            html += '.currency { text-align: right; }';
            html += '.header-info { margin-bottom: 20px; }';
            html += '.footer-info { margin-top: 20px; font-style: italic; color: #666; }</style></head><body>';
            html += '<div class="header-info">';
            html += '<h2>' + (sheetName || 'Sheet1') + '</h2>';
            html += '<p><strong>Generated:</strong> ' + new Date().toLocaleString() + '</p>';
            html += '<p><strong>Source:</strong> Wound Care RT Supply Tracker</p>';
            html += '<p><strong>Total Records:</strong> ' + (data.length - 1) + '</p>';
            html += '</div><table>';
            data.forEach((row, index) => {
                html += '<tr>';
                row.forEach(cell => {
                    const cellValue = String(cell || '');
                    let className = '';
                    let displayValue = cellValue;
                    if (cellValue.startsWith('$')) {
                        className = 'currency';
                        displayValue = cellValue;
                    } else if (cellValue.match(/^\d+\.?\d*$/) && !cellValue.includes('-') && cellValue !== '') {
                        className = 'number';
                    }
                    const tag = index === 0 ? 'th' : 'td';
                    html += '<' + tag + ' class="' + className + '">' + displayValue + '</' + tag + '>';
                });
                html += '</tr>';
            });
            html += '</table>';
            html += '<div class="footer-info">';
            html += '<p>This report was exported from the Wound Care RT Supply Tracker system.</p>';
            html += '<p>For questions about this data, please contact your system administrator.</p>';
            html += '</div></body></html>';
            const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename + '.xls');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            } else {
                showToast('Excel export is not supported in this browser.', 'error');
            }
        }

        async function generateMonthlySummaryTemplate() {
            try {
                const currentMonth = new Date().toISOString().slice(0, 7);
                const dashboardData = await apiCall('/dashboard/summary?month=' + currentMonth);
                const data = [['MONTHLY SUMMARY REPORT'], ['Month:', currentMonth], ['Generated:', new Date().toLocaleString()], [''], ['Patient', 'Facility', 'Total Units', 'Total Cost', 'Active Supplies', 'Primary Wound Dx']];
                dashboardData.forEach(item => {
                    const primaryDx = item.wound_diagnoses ? item.wound_diagnoses.split(';')[0].trim() : '';
                    const activeSupplies = item.supply_codes ? item.supply_codes.split(',').length : 0;
                    data.push([item.name || '', item.facility_name || '', item.total_units || '0', '$' + parseFloat(item.total_cost || 0).toFixed(2), activeSupplies.toString(), primaryDx]);
                });
                const totalUnits = dashboardData.reduce((sum, item) => sum + parseInt(item.total_units || 0), 0);
                const totalCost = dashboardData.reduce((sum, item) => sum + parseFloat(item.total_cost || 0), 0);
                data.push(['']);
                data.push(['TOTALS:', '', totalUnits.toString(), '$' + totalCost.toFixed(2), '', '']);
                return data;
            } catch (error) {
                console.error('Error generating monthly summary:', error);
                return [['Error generating monthly summary template']];
            }
        }

        async function generateFacilityBreakdownTemplate() {
            try {
                const dashboardData = await apiCall('/dashboard/summary');
                const facilityGroups = {};
                dashboardData.forEach(item => {
                    const facilityName = item.facility_name || 'Unknown';
                    if (!facilityGroups[facilityName]) {
                        facilityGroups[facilityName] = { patients: 0, totalUnits: 0, totalCost: 0, details: [] };
                    }
                    facilityGroups[facilityName].patients += 1;
                    facilityGroups[facilityName].totalUnits += parseInt(item.total_units || 0);
                    facilityGroups[facilityName].totalCost += parseFloat(item.total_cost || 0);
                    facilityGroups[facilityName].details.push(item);
                });
                const data = [['FACILITY BREAKDOWN REPORT'], ['Generated:', new Date().toLocaleString()], [''], ['Facility', 'Patients', 'Total Units', 'Total Cost', 'Avg Cost per Patient']];
                Object.entries(facilityGroups).forEach(([facilityName, group]) => {
                    const avgCost = group.patients > 0 ? (group.totalCost / group.patients) : 0;
                    data.push([facilityName, group.patients.toString(), group.totalUnits.toString(), '$' + group.totalCost.toFixed(2), '$' + avgCost.toFixed(2)]);
                });
                return data;
            } catch (error) {
                console.error('Error generating facility breakdown:', error);
                return [['Error generating facility breakdown template']];
            }
        }

        async function generateCostAnalysisTemplate() {
            try {
                const reportData = await apiCall('/reports/itemized-summary');
                const supplyCosts = {};
                reportData.forEach(item => {
                    const code = item.ar_code;
                    if (!supplyCosts[code]) {
                        supplyCosts[code] = { description: item.item_description, hcpcs: item.hcpcs || '', totalUnits: 0, totalCost: 0, patientCount: new Set() };
                    }
                    supplyCosts[code].totalUnits += parseInt(item.total_units || 0);
                    supplyCosts[code].totalCost += parseFloat(item.total_cost || 0);
                    supplyCosts[code].patientCount.add(item.patient_name);
                });
                const data = [['COST ANALYSIS REPORT'], ['Generated:', new Date().toLocaleString()], [''], ['AR Code', 'Description', 'HCPCS', 'Total Units', 'Total Cost', 'Patients Using', 'Avg Cost per Unit', 'Avg Cost per Patient']];
                Object.entries(supplyCosts)
                    .sort(([,a], [,b]) => b.totalCost - a.totalCost)
                    .forEach(([code, supply]) => {
                        const avgCostPerUnit = supply.totalUnits > 0 ? (supply.totalCost / supply.totalUnits) : 0;
                        const avgCostPerPatient = supply.patientCount.size > 0 ? (supply.totalCost / supply.patientCount.size) : 0;
                        data.push([code, supply.description, supply.hcpcs, supply.totalUnits.toString(), '$' + supply.totalCost.toFixed(2), supply.patientCount.size.toString(), '$' + avgCostPerUnit.toFixed(2), '$' + avgCostPerPatient.toFixed(2)]);
                    });
                return data;
            } catch (error) {
                console.error('Error generating cost analysis:', error);
                return [['Error generating cost analysis template']];
            }
        }

        window.addEventListener('load', async () => {
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await apiCall('/auth/verify');
                    if (response && response.user) {
                        currentUser = response.user;
                        showMainApp();
                    }
                } catch (error) {
                    console.error('Auto-login failed:', error);
                    localStorage.removeItem('authToken');
                }
            }
        });

        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && document.getElementById('authContainer').style.display !== 'none') {
                const loginForm = document.getElementById('loginForm');
                const registerForm = document.getElementById('registerForm');
                if (loginForm && loginForm.style.display !== 'none') {
                    login();
                } else if (registerForm && registerForm.style.display !== 'none') {
                    register();
                }
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>
